"use strict";function initCollisionEventHandler(){altspace.inClient&&this.placeholder&&(this.nativeEvents.NativeCollisionEvent=altspaceutil.addNativeEventListener("NativeCollisionEvent",function(t,e,i,a,s,n,o,r,h,l,c,d){var p=altspaceutil.getObject3DById(e),u=altspaceutil.getObject3DById(i);if(p===this.placeholder||u===this.placeholder){var v={type:t,bubbles:!0,target:p===this.placeholder?this.object3d:p,other:u===this.placeholder?this.object3d:u,relativeVelocity:{x:a,y:s,z:n}};o&&(v.point={position:{x:l,y:c,z:d},normal:{x:o,y:r,z:h}}),this.object3d.dispatchEvent(v)}}.bind(this)),this.nativeEvents.NativeTriggerEvent=altspaceutil.addNativeEventListener("NativeTriggerEvent",function(t,e,i){var a=altspaceutil.getObject3DById(e),s=altspaceutil.getObject3DById(i);if(a===this.placeholder||s===this.placeholder){var n={type:t,bubbles:!0,target:a===this.placeholder?this.object3d:a,other:s===this.placeholder?this.object3d:s};this.object3d.dispatchEvent(n)}}.bind(this)))}window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(t,e){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(t,e):null},altspaceutil.removeNativeEventListener=function(t,e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(t,e)},altspaceutil.removeAllNativeEventListeners=function(t){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[t]&&delete altspace._internal.couiEngine.events[t]},altspaceutil.getObject3DById=function(t){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(t):null},altspaceutil.getThreeJSScene=function(t){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.getAbsoluteURL=function(t){if(t&&!t.startsWith("http"))if(t.startsWith("/"))t=location.origin+t;else{var e=location.pathname;e.endsWith("/")||(e=location.pathname.split("/").slice(0,-1).join("/")+"/"),t=location.origin+e+t}return t},altspaceutil.getBasePath=function(t){return t.split("/").slice(0,-1).join("/")+"/"},altspaceutil.manageBehavior=function(t,e){t.__isManaged=!0,e.__resetManagedBehavior||e.addEventListener("removed",e.__resetManagedBehavior=function(){e.__resetManagedBehavior&&(e.removeEventListener("removed",e.__resetManagedBehavior),e.__resetManagedBehavior=null),e.traverse(function(t){if(t.__behaviorList)for(var e of t.__behaviorList)if(e.__isInitialized&&e.__isManaged)try{e.dispose&&e.dispose.call(e,t),e.__isInitialized=!1}catch(i){console.group(),(console.error||console.log).call(console,i.stack||i),console.log("[Behavior]"),console.log(e),console.log("[Object3D]"),console.log(t),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(t,e){t.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(t,e){var i=t.clone(!1);if(t.__behaviorList&&t.__behaviorList.length>0)for(var a of t.__behaviorList)try{if(a.clone){var s=a.clone.call(a,i,t);s&&(i.__behaviorList=i.__behaviorList||[],i.__behaviorList.push(s))}}catch(e){console.group(),(console.error||console.log).call(console,e.stack||e),console.log("[Behavior]"),console.log(a),console.log("[Object3D]"),console.log(t),console.groupEnd()}if(void 0===e||e)for(var n of t.children)i.add(n.cloneWithBehaviors(!0));return i},altspaceutil.behaviors.NativeComponentPlaceholderMesh=altspaceutil.behaviors.NativeComponentPlaceholderMesh||new THREE.Mesh(new THREE.BoxBufferGeometry(.001,.001,.001),Object.assign(new THREE.MeshBasicMaterial,{visible:!1})),altspaceutil.behaviors.NativeComponentDefaults={"n-object":{data:{res:"architecture/wall-4w-4h"}},"n-spawner":{data:{res:"interactables/basketball"}},"n-text":{data:{text:"",fontSize:10,width:10,height:1,horizontalAlign:"middle",verticalAlign:"middle"}},"n-sphere-collider":{data:{isTrigger:!1,center:{x:0,y:0,z:0},radius:0,type:"environment"},config:{meshComponent:!0},initComponent:initCollisionEventHandler},"n-box-collider":{data:{isTrigger:!1,center:{x:0,y:0,z:0},size:{x:0,y:0,z:0},type:"environment"},config:{meshComponent:!0},initComponent:initCollisionEventHandler},"n-capsule-collider":{data:{isTrigger:!1,center:{x:0,y:0,z:0},radius:0,height:0,direction:"y",type:"environment"},config:{meshComponent:!0},initComponent:initCollisionEventHandler},"n-mesh-collider":{data:{isTrigger:!1,convex:!0,type:"environment"},config:{recursiveMesh:!0,inheritParentData:!0,meshComponent:!0},initComponent:initCollisionEventHandler},"n-container":{data:{capacity:4},config:{meshComponent:!0},initComponent:function(){if(this.count=0,altspace.inClient&&(this.nativeEvents.NativeContainerCountChanged=altspaceutil.addNativeEventListener("NativeContainerCountChanged",function(t,e,i){var a=altspaceutil.getObject3DById(t);a&&a===this.component&&(this.count=e,a.dispatchEvent({type:"container-count-changed",detail:{count:e,oldCount:i},bubbles:!0,target:a}))}.bind(this)),this.nativeEvents.NativeContainerStateChanged=altspaceutil.addNativeEventListener("NativeContainerStateChanged",function(t,e,i){var a=altspaceutil.getObject3DById(t);if(a&&a===this.component){var s=this.state;this.state=i?e:void 0,a.dispatchEvent({type:i?"stateadded":"stateremoved",detail:{state:e},bubbles:!0,target:a}),this.state!==s&&this.state&&a.dispatchEvent({type:e,bubbles:!0,target:a})}}.bind(this))),this.placeholder){var t=function(t){this.object3d.dispatchEvent(t)}.bind(this);this.placeholder.addEventListener("container-count-changed",t),this.placeholder.addEventListener("container-empty",t),this.placeholder.addEventListener("container-full",t),this.placeholder.addEventListener("triggerenter",t),this.placeholder.addEventListener("triggerexit",t)}}},"n-sound":{data:{on:"",res:"",src:"",loop:!1,volume:1,autoplay:!1,oneshot:!1,spatialBlend:1,pitch:1,minDistance:1,maxDistance:12},initComponent:function(){if(this.data.src=altspaceutil.getAbsoluteURL(this.data.src),altspace.inClient&&(altspaceutil.overrideNativeSoundLoadedEvent||(altspaceutil.overrideNativeSoundLoadedEvent=!0,altspaceutil.removeAllNativeEventListeners("NativeSoundLoadedEvent"),altspaceutil.addNativeEventListener("NativeSoundLoadedEvent",function(t){altspace._internal.forwardEventToChildIFrames("NativeSoundLoadedEvent",arguments);var e=altspace._internal.getObject3DById(t);e&&e.el&&targetEl.emit("n-sound-loaded",null,!0)})),this.nativeEvents.NativeSoundLoadedEvent=altspaceutil.addNativeEventListener("NativeSoundLoadedEvent",function(t){var e=altspaceutil.getObject3DById(t);e&&e===this.component&&e.dispatchEvent({type:"n-sound-loaded",bubbles:!0,target:e})}.bind(this))),this.placeholder){var t=function(t){this.object3d.dispatchEvent(t)}.bind(this);this.placeholder.addEventListener("n-sound-loaded",t),this.placeholder.addEventListener("sound-paused",t),this.placeholder.addEventListener("sound-played",t)}},callComponent:function(t,e){"play"===t?this.component.dispatchEvent({type:"sound-played",bubbles:!0,target:this.component}):"pause"===t&&this.component.dispatchEvent({type:"sound-paused",bubbles:!0,target:this.component})},update:function(){this.initialized&&altspace.updateNativeComponent(this.component,this.type,this.data),this.playHandlerType&&(this.component.removeEventListener(this.playHandlerType,this.playHandler),this.playHandlerType=null),this.data.on&&""!==this.data.on&&(void 0===this.playHandler&&(this.playHandler=this.callComponent.bind(this,"play")),this.playHandlerType=this.data.on,this.component.addEventListener(this.playHandlerType,this.playHandler))}},"n-skeleton-parent":{data:{part:"head",side:"center",index:0,userId:null},config:{recursiveMesh:!0,inheritParentData:!0,meshComponent:!0}},"n-cockpit-parent":{config:{sendUpdates:!1,recursiveMesh:!0,inheritParentData:!0,meshComponent:!0}},"n-billboard":{config:{sendUpdates:!1,meshComponent:!0}},"n-layout-browser":{data:{url:"about:blank",isEnclosure:!1},initComponent:function(){this.data.url=altspaceutil.getAbsoluteURL(this.data.url),this.scene.userData.altspace=this.scene.userData.altspace||{},this.scene.userData.altspace.initialized=!0}},"n-portal":{data:{targetSpace:null,targetPosition:{x:0,y:0,z:0},targetQuaternion:{x:0,y:0,z:0,w:1}},update:function(){if(this.config.targetEntity){this.scene.updateMatrixWorld(!0),this.data.targetPosition=this.config.targetEntity.getWorldPosition();var t=this.config.targetEntity.getWorldQuaternion();this.data.targetQuaternion={x:t.x,y:t.y,z:t.z,w:t.w}}this.initialized&&altspace.updateNativeComponent(this.component,this.type,this.data)}},"n-gltf":{data:{url:"",sceneIndex:0},initComponent:function(){this.data.url=altspaceutil.getAbsoluteURL(this.data.url)}},"n-rigidbody":{data:{mass:1,drag:0,angularDrag:.05,useGravity:!0,isKinematic:!1,positionConstraints:[!1,!1,!1],rotationConstraints:[!1,!1,!1]},config:{meshComponent:!0},initComponent:function(){if(altspace.inClient&&this.placeholder){var t=function(t){this.object3d.dispatchEvent(t)}.bind(this);this.placeholder.addEventListener("native-transform-update",t)}}}},altspaceutil.behaviors.NativeComponent=function(t,e,i){this.type=t||"NativeComponent",this.nativeEvents={},this.defaults=altspaceutil.behaviors.NativeComponentDefaults[this.type],this.config=Object.assign({sendUpdates:!0,recursiveMesh:!1,recursive:!1,useCollider:!1,updateOnStaleData:!0,sharedComponent:!0,inheritParentData:!1,meshComponent:!1},this.defaults&&this.defaults.config?JSON.parse(JSON.stringify(this.defaults.config)):{},i),this.data=Object.assign(this.defaults&&this.defaults.data?JSON.parse(JSON.stringify(this.defaults.data)):{},e),this.awake=function(t,e){if(this.scene=e,this.component=this.object3d=t,this.initialized=!1,altspaceutil.manageBehavior(this,this.object3d),!(this.component instanceof THREE.Mesh)){if(this.config.sharedComponent&&this.object3d.userData._sharedNativeComponent)for(var i of this.object3d.userData._sharedNativeComponent.behaviors)if(i!==this&&i.type===this.type){this.config.sharedComponent=!1;break}this.config.sharedComponent&&(this.sharedData=this.object3d.userData._sharedNativeComponent=this.object3d.userData._sharedNativeComponent||{},this.sharedData.placeholder=this.sharedData.placeholder||altspaceutil.behaviors.NativeComponentPlaceholderMesh.clone(),this.sharedData.behaviors=this.sharedData.behaviors||[],this.sharedData.behaviors.push(this),this.sharedData.placeholder.parent||this.object3d.add(this.sharedData.placeholder)),this.component=this.placeholder=this.sharedData&&this.sharedData.placeholder?this.sharedData.placeholder:altspaceutil.behaviors.NativeComponentPlaceholderMesh.clone(),this.object3d.add(this.placeholder)}this.defaults&&this.defaults.initComponent&&this.defaults.initComponent.bind(this)(),this.config.useCollider||(this.component.userData.altspace=this.component.userData.altspace||{},this.component.userData.altspace.collider=this.component.userData.altspace.collider||{},this.component.userData.altspace.collider.enabled=!1);var a=!1;if(this.config.inheritParentData&&!this.parent)for(var s=this.object3d.parent;s;){var i=s.getBehaviorByType(this.type);if(i){this.parent=i.parent||i,a=!0;break}s=s.parent}this.update(),!this.config.recursive&&!this.config.recursiveMesh||this.parent&&!a||this.object3d.traverse(function(t){t!==this.object3d&&t!==this.placeholder&&(this.config.recursive||this.config.recursiveMesh&&t instanceof THREE.Mesh)&&(t.getBehaviorByType(this.type)||t.addBehavior(Object.assign(new altspaceutil.behaviors.NativeComponent(this.type,this.data,this.config),{parent:this})))}.bind(this))},this.update=function(){if(this.placeholder&&(this.object3d.userData.altspace&&(this.placeholder.userData.altspace=this.object3d.userData.altspace),this.placeholder.visible=this.object3d.visible),this.parent&&this.config.inheritParentData&&(this.data=Object.assign({},this.parent.data)),this.parent||!this.config.recursive&&!this.config.recursiveMesh||this.object3d.traverse(function(t){t!==this.object3d&&t!==this.placeholder&&(this.config.recursive||this.config.recursiveMesh&&t instanceof THREE.Mesh)&&(t.getBehaviorByType(this.type)||t.addBehavior(Object.assign(new altspaceutil.behaviors.NativeComponent(this.type,this.data,this.config),{parent:this})))}.bind(this)),altspace.inClient){if(!this.initialized){if(!this.config.meshComponent||this.object3d instanceof THREE.Mesh)this.initialized=!0;else if(this.config.sharedComponent&&this.sharedData)for(var t of this.sharedData.behaviors)if(t.initialized){this.initialized=!0;break}this.initialized&&altspace.addNativeComponent(this.component,this.type)}if(this.config.sendUpdates)if(this.config.updateOnStaleData){var e=JSON.stringify(this.data);this.oldData!==e&&(this.defaults&&this.defaults.update?this.defaults.update.bind(this)():this.initialized&&altspace.updateNativeComponent(this.component,this.type,this.data),this.oldData=e)}else this.defaults&&this.defaults.update?this.defaults.update.bind(this)():this.initialized&&altspace.updateNativeComponent(this.component,this.type,this.data)}},this.callComponent=function(t,e){this.initialized&&altspace.callNativeComponent(this.component,this.type,t,e),this.defaults&&this.defaults.callComponent&&this.defaults.callComponent.bind(this)(t,e),(this.config.recursive||this.config.recursiveMesh&&!this.parent)&&this.object3d.traverse(function(i){if(i!==this.object3d&&i!==this.placeholder&&(this.config.recursive||this.config.recursiveMesh&&i instanceof THREE.Mesh)){var a=i.getBehaviorByType(this.type);a&&a.parent===this&&i.callComponent(t,e)}}.bind(this))},this.dispose=function(){(this.config.recursive||this.config.recursiveMesh&&!this.parent)&&this.object3d.traverse(function(t){if(t!==this.object3d&&t!==this.placeholder&&(this.config.recursive||this.config.recursiveMesh&&t instanceof THREE.Mesh)){var e=t.getBehaviorByType(this.type);e&&e.parent===this&&t.removeBehavior(e)}}.bind(this));for(var t in this.nativeEvents)this.nativeEvents.hasOwnProperty(t)&&this.nativeEvents[t].clear();if(this.initialized&&altspace.removeNativeComponent(this.component,this.type),this.config.sharedComponent&&this.sharedData){var e=this.sharedData.behaviors.indexOf(this);e>=0&&this.sharedData.behaviors.splice(e,1),this.sharedData.behaviors.length<=0&&(this.sharedData.placeholder.parent&&this.sharedData.placeholder.parent.remove(this.sharedData.placeholder),delete this.object3d.userData._sharedNativeComponent)}else this.placeholder&&this.object3d.remove(this.placeholder);this.nativeEvents={},this.initialized=!1,this.object3d=null,this.placeholder=null,this.component=null,this.scene=null,this.sharedData=null,this.oldData=null,this.parent=null},this.clone=function(){return new altspaceutil.behaviors.NativeComponent(this.type,this.data,this.config)}},altspaceutil.behaviors.NativeComponentSync=function(t,e){this.componentType=t||"NativeComponent",this.type=t?"sync-"+t:"NativeComponentSync",this.config=e||{},this.awake=function(t){this.object3d=t,altspaceutil.manageBehavior(this,this.object3d),this.component=this.object3d.getBehaviorByType(this.componentType),this.sync=this.config.syncRef||this.object3d.getBehaviorByType("Object3DSync"),this.dataRef=this.sync.dataRef.child(this.componentType).child("data"),this.dataRefUpdate=this.dataRef.on("value",function(t){if(!this.sync.isMine){var e=t.val();if(e)return this.component||(this.component=this.object3d.getBehaviorByType(this.componentType),this.component)?void(this.component.data=e):(this.component=new altspaceutil.behaviors.NativeComponent(this.componentType,e),void this.object3d.addBehavior(this.component))}}.bind(this)),this.intervalId=setInterval(this.update.bind(this),this.sync.autoSendRateMS)},this.update=function(){if(this.sync.isMine&&this.component){var t=JSON.stringify(this.component.data);this.oldData!==t&&(this.dataRef.set(this.component.data),this.oldData=t)}},this.dispose=function(){this.intervalId&&clearInterval(this.intervalId),this.dataRefUpdate&&this.dataRef&&this.dataRef.off("value",this.dataRefUpdate),this.object3d=null,this.component=null,this.sync=null,this.dataRef=null,this.dataRefUpdate=null,this.oldData=null},this.clone=function(){return new altspaceutil.behaviors.NativeComponentSync(this.componentType,this.config)}},altspaceutil.behaviors.OrbitControls=function(){this.type="OrbitControls",this.awake=function(t){altspace.inClient||(this.controls=new THREE.OrbitControls(t)),altspaceutil.manageBehavior(this,t)},this.update=function(t){altspace.inClient||this.controls.update()},this.dispose=function(){this.controls=null}},altspaceutil.behaviors.UserEvents=function(t){this.config=t||{},this.type="UserEvents",this.onRequestData=this.config.onRequestData||null,this.refreshTime=this.config.refreshTime||5e3,this.trace=this.config.trace||!1,this.userIds=this.config.userIds||[],this.awake=function(t){if(this.object3d=t,this.time=0,this.loading=!1,this.users={},this.userIds=this.userIds.constructor===Array?this.userIds:[this.userIds],altspaceutil.manageBehavior(this,this.object3d),this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var e=this;altspace.getUser().then(function(t){e.userIds.push(t.userId),e.requestUserData()})}else this.requestUserData()},this.update=function(t){!this.loading&&this.userIds.length>0&&(this.time-=t,this.time<=0&&this.requestUserData())},this.onLoaded=function(t){if(this.loading){var e=JSON.parse(t),i=this;for(var a of e.users)if(a&&a.user_id){var s=a.user_id,n=this.users[s]||{userId:s};this.users[s]=n;var o=n.username;n.username=a.username||null;var r=n.displayName;n.displayName=a.display_name||null;var h=n.online;n.online=a.online||!1;var l=a.user_avatar.config.avatar,c=n.avatarId;n.avatarId=l.avatar_sid||null;var d,p=n.avatarColors,u=n.avatarTextures,v=n.avatarId!==c;switch(n.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":d="Rubenoid";var f="rubenoid-male-01"===n.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";n.avatarTextures={hair:l[f+"1"][0],skin:l[f+"2"][0],clothing:l[f+"3"][0]},n.avatarColors={},v||(v=u.hair!==n.avatarTextures.hair||u.skin!==n.avatarTextures.skin||u.clothing!==n.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":d="Robothead",n.avatarColors={highlight:this.getAvatarColor(l["robothead-highlight-color"])},n.avatarTextures={},v||(v=!p.highlight||!p.highlight.equals(n.avatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":d="Pod",n.avatarColors={primary:this.getAvatarColor(l["primary-color"]),highlight:this.getAvatarColor(l["highlight-color"])},n.avatarTextures={},v||(v=!(p.primary&&p.highlight&&p.primary.equals(n.avatarColors.primary)&&p.highlight.equals(n.avatarColors.highlight)));break;default:d="",n.avatarColors={},n.avatarTextures={},this.trace&&console.log("Unknown avatar type: "+n.avatarId)}n.username===o&&n.displayName===r||this.object3d.dispatchEvent({type:"userchange",detail:{userId:n.userId,username:n.username,displayName:n.displayName},bubbles:!0,target:i.object3d}),v&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:n.userId,avatarId:n.avatarId,avatarClass:d,colors:n.avatarColors,textures:n.avatarTextures},bubbles:!0,target:i.object3d}),n.online!==h&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:n.userId,displayName:n.displayName,online:!!n.online},bubbles:!0,target:i.object3d})}this.loading=!1}},this.onError=function(t){if(this.loading){if(this.trace){var e=t.target.responseURL||"";console.log("Error loading avatar data "+e)}this.loading=!1}},this.subscribeUser=function(t){var e=this.userIds.indexOf(t);e===-1&&this.userIds.push(t)},this.unsubscribeUser=function(t){var e=this.userIds.indexOf(t);e>=0&&this.userIds.splice(e,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var t=[];for(var e of this.userIds)this.onRequestData&&!this.onRequestData(e,this.object3d)||t.push(e);t.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+t.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.refreshTime,this.loading=!0)}},this.getAvatarColor=function(t){function e(t,e,i){return new THREE.Color(t/255,e/255,i/255)}function i(t){var e={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return t=t in e?t:"white",new THREE.Color(e[t].r,e[t].g,e[t].b)}return"string"==typeof t[0]?i(t[0]):e(t[0],t[1],t[2])},this.dispose=function(){this.dataRequest=null,this.object3d=null,this.time=0,this.loading=!1,this.users={}},this.clone=function(){return new altspaceutil.behaviors.UserEvents(this.config)}},altspaceutil.behaviors.PreloadNativeSounds=function(t){this.type="PreloadSoundEffects",this.sounds=t,this.awake=function(t){this.object3d=t,this.elapsedTime=0,altspaceutil.manageBehavior(this,this.object3d),this.components=new THREE.Group,this.object3d.add(this.components);for(var e of this.sounds)this.components.addBehavior(new altspaceutil.behaviors.NativeComponent("n-sound",{src:e,volume:0,oneshot:!0,autoplay:!0}))},this.update=function(t){this.elapsedTime+=t,this.elapsedTime>=1e4&&this.object3d&&this.object3d.removeBehavior(this)},this.dispose=function(){this.components&&this.components.parent&&this.components.parent.remove(this.components),this.components=null,this.object3d=null,this.elapsedTime=0},this.clone=function(){return new altspaceutil.behaviors.PreloadNativeSounds(this.sounds)}};
//# sourceMappingURL=altspaceutil.min.js.map