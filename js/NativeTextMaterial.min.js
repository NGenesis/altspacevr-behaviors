"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(t,e){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(t,e):null},altspaceutil.removeNativeEventListener=function(t,e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(t,e)},altspaceutil.removeAllNativeEventListeners=function(t){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[t]&&delete altspace._internal.couiEngine.events[t]},altspaceutil.getObject3DById=function(t){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(t):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.expandSerializationBuffer=function(t){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&t>0&&altspace._internal.ScratchThriftBuffer.grow(t)},altspaceutil.profileSerializationBuffer=function(t){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===t||t)},altspaceutil.isMobileApp=function(t){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){let t=altspace.inClient?altspace.getEnclosure:()=>{return altspaceutil._BrowserEnclosure||(altspaceutil._BrowserEnclosure=new class extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!0,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil._BrowserEnclosure)};return new Promise((e,a)=>{t().then(t=>t.requestFullspace().then(()=>{t.addEventListener("fullspacechange",()=>{t.fullspace||t.requestFullspace().catch(()=>a("enclosure.requestFullspace() after fullspacechange event failed"))}),e(t)})).catch(()=>a("Failed to get fullspace enclosure."))})},altspaceutil.getFullspaceAppManifest=function(){if(altspaceutil._fullspaceAppManifest)return Promise.resolve(altspaceutil._fullspaceAppManifest);let t=new URLSearchParams(window.location.search),e=e=>{for(let a of t.entries())if(/altvr\.enclosure\.(.*)/i.test(a[0])){let t=a[0].match(/altvr\.enclosure\.(.*)/i)[1],i=e.enclosure=Object.assign({},e.enclosure);switch(i.position=Object.assign({x:0,y:0,z:0},i.position),i.rotation=Object.assign({x:0,y:0,z:0},i.rotation),i.scale=i.hasOwnProperty("scale")&&"number"==typeof i.scale?{x:i.scale||1,y:anchormanifeste.scale||1,z:i.scale||1}:Object.assign({x:1,y:1,z:1},i.scale),t){case"position":case"rotation":{let e=a[1].split(",");e.length>=1&&(i[t].x=parseFloat(e[0])||0),e.length>=2&&(i[t].y=parseFloat(e[1])||0),e.length>=3&&(i[t].z=parseFloat(e[2])||0);break}case"scale":{let e=a[1].split(",");1===e.length?i[t].x=i[t].y=i[t].z=parseFloat(e[0])||1:(e.length>=1&&(i[t].x=parseFloat(e[0])||1),e.length>=2&&(i[t].y=parseFloat(e[1])||1),e.length>=3&&(i[t].z=parseFloat(e[2])||1));break}}}else if(/altvr\.anchors\.(.*)\.(.*)/i.test(a[0])){let[,t,i]=a[0].match(/altvr\.anchors\.(.*)\.(.*)/i),n=e.anchors.findIndex(e=>{return e.name===t});switch(n<0&&(n=e.anchors.push({name:t})-1),anchormanifest=e.anchors[n]=Object.assign({name:t},e.anchors[n]),anchormanifest.position=Object.assign({x:0,y:0,z:0},anchormanifest.position),anchormanifest.rotation=Object.assign({x:0,y:0,z:0},anchormanifest.rotation),anchormanifest.scale=anchormanifest.hasOwnProperty("scale")&&"number"==typeof anchormanifest.scale?{x:anchormanifest.scale||1,y:anchormanifeste.scale||1,z:anchormanifest.scale||1}:Object.assign({x:1,y:1,z:1},anchormanifest.scale),i){case"position":case"rotation":{let t=a[1].split(",");t.length>=1&&(anchormanifest[i].x=parseFloat(t[0])||0),t.length>=2&&(anchormanifest[i].y=parseFloat(t[1])||0),t.length>=3&&(anchormanifest[i].z=parseFloat(t[2])||0);break}case"scale":{let t=a[1].split(",");1===t.length?anchormanifest[i].x=anchormanifest[i].y=anchormanifest[i].z=parseFloat(t[0])||1:(t.length>=1&&(anchormanifest[i].x=parseFloat(t[0])||1),t.length>=2&&(anchormanifest[i].y=parseFloat(t[1])||1),t.length>=3&&(anchormanifest[i].z=parseFloat(t[2])||1));break}}}};return t.has("altvr.manifest")&&t.get("altvr.manifest").length>0?new Promise((a,i)=>{fetch(altspaceutil.getAbsoluteURL(t.get("altvr.manifest"))).then(t=>t.json()).then(t=>{altspaceutil._fullspaceAppManifest=t,e(altspaceutil._fullspaceAppManifest),a(altspaceutil._fullspaceAppManifest)}).catch(()=>i("Failed to download manifest from "+t.get("altvr.manifest")))}):(altspaceutil._fullspaceAppManifest={enclosure:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},anchors:[]},e(altspaceutil._fullspaceAppManifest),Promise.resolve(altspaceutil._fullspaceAppManifest))},altspaceutil.FullspaceApp=class{constructor(t){this.config=Object.assign({serializationBufferSize:5e5},t),this.config.serializationBufferSize&&altspaceutil.expandSerializationBuffer(this.config.serializationBufferSize)}initialize(){let t=()=>{return this._isInitializing||this._isInitialized?new Promise((t,e)=>{let a=setInterval(()=>{this._isInitializing||(clearInterval(a),t())},10)}):(this._isInitializing=!0,Promise.resolve())},e=altspace.inClient?altspace.getSpace():Promise.resolve({sid:"browser",name:"Web Space",templateSid:"browser"});return new Promise((a,i)=>{t().then(()=>{return this._isInitialized?a(this):(this._isInitializing=!0,Promise.all([altspaceutil.getFullspaceEnclosure(),altspaceutil.getFullspaceAppManifest(),e]).then(t=>{let[e,i,n]=t;if(this._enclosure=e,this._manifest=i,this._space=n,this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera,altspace.inClient)this._renderer=altspace.getThreeJSRenderer();else{this._renderer=new THREE.WebGLRenderer({antialias:!0}),Object.assign(this._camera,{fov:90,near:1,far:2e3}),this._camera.position.z=20;let t=()=>{this._renderer.setClearColor("#99AACC"),document.body.style.margin="0px",document.body.style.overflow="hidden",document.body.appendChild(this._renderer.domElement)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t();let e=()=>{this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",e),e(),this._scene.add(this._camera),this._scene.add(new THREE.AmbientLight("white")),altspace.utilities.shims.cursor.init(this._scene,this._camera,{renderer:this._renderer})}this._anchors={},this._anchor=Object.assign(new THREE.Group,{name:"altvr.enclosure"}),this._scene.add(this._anchor);let s=this._manifest?this._manifest.enclosure:null;s&&(this._anchor.position.copy(s.position),this._anchor.rotation.set(THREE.Math.degToRad(s.rotation.x),THREE.Math.degToRad(s.rotation.y),THREE.Math.degToRad(s.rotation.z)),this._anchor.scale.copy(s.scale)),this._anchorsGroup=Object.assign(new THREE.Group,{name:"altvr.anchors"}),this._anchorsGroup.addBehavior(new class t{get type(){return"_ApplyAppAnchorTransform"}constructor(t){this.anchor=t}awake(t){this.object3d=t,this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}update(){this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}}(this._anchor)),this._scene.add(this._anchorsGroup),this._isInitialized=!0;let o=()=>{window.requestAnimationFrame(o),this._scene.updateAllBehaviors(),this._renderer.render(this._scene,this._camera)};o(),this._isInitializing=!1,a(this)}))}).catch(()=>{this._isInitializing=!1,i("Failed to initialize fullspace app.")})})}anchors(t){if(this._anchors[t])return this._anchors[t];let e=this._anchors[t]=Object.assign(new THREE.Group,{name:t});this._anchorsGroup.add(e);let a=this._manifest.anchors.find(e=>{return e.name===t});return a&&(e.position.copy(a.position),e.rotation.set(THREE.Math.degToRad(a.rotation.x),THREE.Math.degToRad(a.rotation.y),THREE.Math.degToRad(a.rotation.z)),e.scale.copy(a.scale)),e}get scene(){return this._scene}get renderer(){return this._renderer}get camera(){return this._camera}get anchor(){return this._anchor}get enclosure(){return this._enclosure}get space(){return this._space}},altspaceutil.getFullspaceApp=function(t){return altspaceutil._fullspaceApp||(altspaceutil._fullspaceApp=new altspaceutil.FullspaceApp(t)),altspaceutil._fullspaceApp.initialize()},altspaceutil.getAbsoluteURL=function(t){return new URL(t,window.location).toString()},altspaceutil.getBasePath=function(t){return t.split("/").slice(0,-1).join("/")+"/"},altspaceutil.loadTexture=function(t,e){if(altspace.inClient)return new THREE.Texture({src:altspaceutil.getAbsoluteURL(t)});e=Object.assign({crossOrigin:"anonymous"},e);var a=new THREE.TextureLoader;return"anonymous"!==e.crossOrigin&&a.setCrossOrigin(e.crossOrigin),void 0!==e.withCredentials&&a.setWithCredentials(e.withCredentials),void 0!==e.path&&a.setPath(e.path),a.load(t)},altspaceutil.setCursorCollider=function(t,e,a){t&&(a?t.traverse(t=>{t.userData.altspace||(t.userData.altspace={}),t.userData.altspace.collider||(t.userData.altspace.collider={}),t.userData.altspace.collider.enabled=e}):(t.userData.altspace||(t.userData.altspace={}),t.userData.altspace.collider||(t.userData.altspace.collider={}),t.userData.altspace.collider.enabled=e))},altspaceutil.isCursorCollider=function(t){return!!t&&(!t.userData.altspace||!t.userData.altspace.collider||void 0===t.userData.altspace.enabled||t.userData.altspace.enabled)},altspaceutil.manageBehavior=function(t,e){t.__isManaged=!0,e.__resetManagedBehavior||e.addEventListener("removed",e.__resetManagedBehavior=function(){e.__resetManagedBehavior&&(e.removeEventListener("removed",e.__resetManagedBehavior),e.__resetManagedBehavior=null),e.traverse(function(t){if(t.__behaviorList)for(var e of t.__behaviorList)if(e.__isInitialized&&e.__isManaged)try{e.dispose&&e.dispose.call(e,t),e.__isInitialized=!1}catch(a){console.group(),(console.error||console.log).call(console,a.stack||a),console.log("[Behavior]"),console.log(e),console.log("[Object3D]"),console.log(t),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(t,e){t.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(t,e){var a=t.clone(!1);if(t.__behaviorList&&t.__behaviorList.length>0)for(var i of t.__behaviorList)try{if(i.clone){var n=i.clone.call(i,a,t);n&&(a.__behaviorList=a.__behaviorList||[],a.__behaviorList.push(n))}}catch(e){console.group(),(console.error||console.log).call(console,e.stack||e),console.log("[Behavior]"),console.log(i),console.log("[Object3D]"),console.log(t),console.groupEnd()}if(void 0===e||e)for(var s of t.children)a.add(s.cloneWithBehaviors(!0));return a},altspaceutil.loadScript=((t,e)=>{if(e=Object.assign({loadOnce:!0},e),altspaceutil._loadedScripts=altspaceutil._loadedScripts||{},e.scriptTest&&e.scriptTest(t))return Promise.resolve();if(e.loadOnce){if(altspaceutil._loadedScripts[t]&&altspaceutil._loadedScripts[t].loaded)return Promise.resolve();if(altspaceutil._loadedScripts[t]&&altspaceutil._loadedScripts[t].waiting)return altspaceutil._loadedScripts[t].waiting}let a=document.createElement("script");a.src=new URL(t,window.location).toString(),a.async=!1;let i=void 0===altspaceutil._loadedScripts[t],n=new Promise((n,s)=>{a.onload=(()=>{!e.scriptTest||e.scriptTest(t)?n():(console.warn("Script test failed for script at "+a.src),s("Script test failed for script at "+a.src)),i&&(altspaceutil._loadedScripts[t].loaded=!0,altspaceutil._loadedScripts[t].waiting=null)}),a.onerror=(()=>{i&&(altspaceutil._loadedScripts[t].waiting=null,delete altspaceutil._loadedScripts[t]),console.warn("Failed to load script at "+a.src),s("Failed to load script at "+a.src)})});if(i&&(altspaceutil._loadedScripts[t]={waiting:n}),altspaceutil._lastLoadScript)altspaceutil._lastLoadScript.parentNode.insertBefore(a,altspaceutil._lastLoadScript.nextSibling);else{let t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(a,t)}return altspaceutil._lastLoadScript=a,n}),altspaceutil.loadScripts=(t=>{return!t||t.length<=0?Promise.resolve():Promise.all(t.map(t=>"string"==typeof t||t instanceof String?altspaceutil.loadScript(t):altspaceutil.loadScript(t.url,t)))}),altspaceutil.behaviors.NativeTextMaterial=function(t){t=t||{},this.type="NativeTextMaterial",this.awake=function(e){this.object3d=e,this.component=this.object3d.getBehaviorByType("n-text"),this.material=t.material||this.object3d.material||new THREE.MeshBasicMaterial({transparent:!0}),this.hasColor=void 0===t.color||t.color,this.hasOpacity=void 0===t.opacity||t.opacity},this.update=function(t){this.removeMaterialTags(),this.component.data.text=this.getMaterialTags()+this.component.data.text},this.dispose=function(){this.removeMaterialTags()},this.removeMaterialTags=function(){var t=this.component.data.text.indexOf('<link id="n-text-material">'),e=t>=0?this.component.data.text.indexOf("</link>",t):-1;t>=0&&e>=0&&(this.component.data.text=this.component.data.text.slice(0,t)+this.component.data.text.slice(e+7))},this.getMaterialTags=function(){var t='<link id="n-text-material">';return this.hasColor?t+="<color=#"+this.getColorHexString()+this.getOpacityHexString()+">":this.hasOpacity&&(t+="<alpha=#"+this.getOpacityHexString()+">"),t+="</link>"},this.getColorHexString=function(){return this.material.color.getHexString()},this.getOpacityHexString=function(){var t=(+Math.floor(this.hasOpacity&&this.material.transparent?255*this.material.opacity:255)).toString(16).toUpperCase();return t.length<2&&(t="0"+t),t}},window.AFRAME&&(AFRAME.components["n-text-material"]&&delete AFRAME.components["n-text-material"],AFRAME.registerComponent("n-text-material",{dependencies:["n-text"],schema:{material:{type:"selector"},color:{type:"boolean",default:!0},opacity:{type:"boolean",default:!0}},init:function(){this.component=this.el.getAttribute("n-text"),this.material=this.data.material?this.data.material.object3DMap.mesh.material:this.el.object3DMap.mesh.material},remove:function(){this.removeMaterialTags()},tick:function(t){this.removeMaterialTags(),this.el.setAttribute("n-text","text",this.getMaterialTags()+this.component.text)},removeMaterialTags:function(){var t=this.component.text.indexOf('<link id="n-text-material">'),e=t>=0?this.component.text.indexOf("</link>",t):-1;t>=0&&e>=0&&(this.component.text=this.component.text.slice(0,t)+this.component.text.slice(e+7))},getMaterialTags:function(){var t='<link id="n-text-material">';return this.data.color?t+="<color=#"+this.getColorHexString()+this.getOpacityHexString()+">":this.data.opacity&&(t+="<alpha=#"+this.getOpacityHexString()+">"),t+="</link>"},getColorHexString:function(){return this.material.color.getHexString()},getOpacityHexString:function(){var t=(+Math.floor(this.data.opacity&&this.material.transparent?255*this.material.opacity:255)).toString(16).toUpperCase();return t.length<2&&(t="0"+t),t}}));