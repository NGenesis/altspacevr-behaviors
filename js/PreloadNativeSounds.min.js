"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(e,t){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,t):null},altspaceutil.removeNativeEventListener=function(e,t){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,t)},altspaceutil.removeAllNativeEventListeners=function(e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(e):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.expandSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&e>0&&altspace._internal.ScratchThriftBuffer.grow(e)},altspaceutil.profileSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===e||e)},altspaceutil.isMobileApp=function(e){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){return new Promise(function(e,t){altspace.getEnclosure().then(function(i){i.requestFullspace().then(function(){i.addEventListener("fullspacechange",function(){i.fullspace||i.requestFullspace().catch(function(){t("enclosure.requestFullspace() after fullspacechange event failed")})}),e(i)}).catch(function(){t("enclosure.requestFullspace() failed")})}).catch(function(){t("altspace.getEnclosure() failed")})})},altspaceutil.getAbsoluteURL=function(e){if(e&&!e.startsWith("http"))if(e.startsWith("/"))e=location.origin+e;else{var t=location.pathname;t.endsWith("/")||(t=location.pathname.split("/").slice(0,-1).join("/")+"/"),e=location.origin+t+e}return e},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.manageBehavior=function(e,t){e.__isManaged=!0,t.__resetManagedBehavior||t.addEventListener("removed",t.__resetManagedBehavior=function(){t.__resetManagedBehavior&&(t.removeEventListener("removed",t.__resetManagedBehavior),t.__resetManagedBehavior=null),t.traverse(function(e){if(e.__behaviorList)for(var t of e.__behaviorList)if(t.__isInitialized&&t.__isManaged)try{t.dispose&&t.dispose.call(t,e),t.__isInitialized=!1}catch(i){console.group(),(console.error||console.log).call(console,i.stack||i),console.log("[Behavior]"),console.log(t),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,t){e.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(e,t){var i=e.clone(!1);if(e.__behaviorList&&e.__behaviorList.length>0)for(var n of e.__behaviorList)try{if(n.clone){var a=n.clone.call(n,i,e);a&&(i.__behaviorList=i.__behaviorList||[],i.__behaviorList.push(a))}}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(n),console.log("[Object3D]"),console.log(e),console.groupEnd()}if(void 0===t||t)for(var s of e.children)i.add(s.cloneWithBehaviors(!0));return i},altspaceutil.behaviors.PreloadNativeSounds=function(e,t){this.type="PreloadSoundEffects",this.sounddata=e,this.config=Object.assign({timeout:1e4,dispose:!0},t||{}),this.awake=function(e){this.object3d=e,this.elapsedTime=0,this.preloadedCount=0,this.isTimedOut=!1,this.sounds=[],altspaceutil.manageBehavior(this,this.object3d),this.soundLoadedEventHandler=function(e){if(this.preloadedCount>0&&--this.preloadedCount,!this.isTimedOut&&this.preloadedCount<=0){var t=this;this.object3d.dispatchEvent({type:"n-sound-preloaded",behavior:t,sounds:t.sounds,timeout:!1,bubbles:!0}),this.object3d.removeBehavior(this)}}.bind(this);for(var t of this.sounddata){++this.preloadedCount;var i=new THREE.Object3D;i.addBehavior(new altspaceutil.behaviors.NativeComponent("n-sound","string"==typeof t||t instanceof String?{src:t}:t)),i.addEventListener("n-sound-loaded",this.soundLoadedEventHandler),this.object3d.add(i),this.sounds.push(i)}},this.update=function(e){if(this.elapsedTime+=e,this.preloadedCount>0&&!this.isTimedOut&&this.config.timeout>0&&this.elapsedTime>=this.config.timeout&&this.object3d){this.isTimedOut=!0;var t=this;this.object3d.dispatchEvent({type:"n-sound-preloaded",behavior:t,sounds:t.sounds,timeout:!0,bubbles:!0}),this.object3d.removeBehavior(this)}},this.dispose=function(){for(var e of this.sounds)e.removeEventListener("n-sound-loaded",this.soundLoadedEventHandler),this.config.dispose&&e.parent&&e.parent.remove(e);this.soundLoadedEventHandler=null,this.sounds=null,this.object3d=null,this.elapsedTime=0,this.preloadedCount=0},this.clone=function(){return new altspaceutil.behaviors.PreloadNativeSounds(this.sounddata,this.config)}};