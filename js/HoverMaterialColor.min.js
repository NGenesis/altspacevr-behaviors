"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(e,t){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,t):null},altspaceutil.removeNativeEventListener=function(e,t){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,t)},altspaceutil.removeAllNativeEventListeners=function(e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(e):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.expandSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&e>0&&altspace._internal.ScratchThriftBuffer.grow(e)},altspaceutil.profileSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===e||e)},altspaceutil.isMobileApp=function(e){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){let e=altspace.inClient?altspace.getEnclosure:()=>{return altspaceutil._BrowserEnclosure||(altspaceutil._BrowserEnclosure=new class extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!0,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil._BrowserEnclosure)};return new Promise((t,i)=>{e().then(e=>e.requestFullspace().then(()=>{e.addEventListener("fullspacechange",()=>{e.fullspace||e.requestFullspace().catch(()=>i("enclosure.requestFullspace() after fullspacechange event failed"))}),t(e)})).catch(()=>i("Failed to get fullspace enclosure."))})},altspaceutil.getFullspaceAppManifest=function(){if(altspaceutil._fullspaceAppManifest)return Promise.resolve(altspaceutil._fullspaceAppManifest);let e=new URLSearchParams(window.location.search),t=t=>{for(let i of e.entries())if(/altvr\.enclosure\.(.*)/i.test(i[0])){let e=i[0].match(/altvr\.enclosure\.(.*)/i)[1],a=t.enclosure=Object.assign({},t.enclosure);switch(a.position=Object.assign({x:0,y:0,z:0},a.position),a.rotation=Object.assign({x:0,y:0,z:0},a.rotation),a.scale=a.hasOwnProperty("scale")&&"number"==typeof a.scale?{x:a.scale||1,y:anchormanifeste.scale||1,z:a.scale||1}:Object.assign({x:1,y:1,z:1},a.scale),e){case"position":case"rotation":{let t=i[1].split(",");t.length>=1&&(a[e].x=parseFloat(t[0])||0),t.length>=2&&(a[e].y=parseFloat(t[1])||0),t.length>=3&&(a[e].z=parseFloat(t[2])||0);break}case"scale":{let t=i[1].split(",");1===t.length?a[e].x=a[e].y=a[e].z=parseFloat(t[0])||1:(t.length>=1&&(a[e].x=parseFloat(t[0])||1),t.length>=2&&(a[e].y=parseFloat(t[1])||1),t.length>=3&&(a[e].z=parseFloat(t[2])||1));break}}}else if(/altvr\.anchors\.(.*)\.(.*)/i.test(i[0])){let[,e,a]=i[0].match(/altvr\.anchors\.(.*)\.(.*)/i),s=t.anchors.findIndex(t=>{return t.name===e});switch(s<0&&(s=t.anchors.push({name:e})-1),anchormanifest=t.anchors[s]=Object.assign({name:e},t.anchors[s]),anchormanifest.position=Object.assign({x:0,y:0,z:0},anchormanifest.position),anchormanifest.rotation=Object.assign({x:0,y:0,z:0},anchormanifest.rotation),anchormanifest.scale=anchormanifest.hasOwnProperty("scale")&&"number"==typeof anchormanifest.scale?{x:anchormanifest.scale||1,y:anchormanifeste.scale||1,z:anchormanifest.scale||1}:Object.assign({x:1,y:1,z:1},anchormanifest.scale),a){case"position":case"rotation":{let e=i[1].split(",");e.length>=1&&(anchormanifest[a].x=parseFloat(e[0])||0),e.length>=2&&(anchormanifest[a].y=parseFloat(e[1])||0),e.length>=3&&(anchormanifest[a].z=parseFloat(e[2])||0);break}case"scale":{let e=i[1].split(",");1===e.length?anchormanifest[a].x=anchormanifest[a].y=anchormanifest[a].z=parseFloat(e[0])||1:(e.length>=1&&(anchormanifest[a].x=parseFloat(e[0])||1),e.length>=2&&(anchormanifest[a].y=parseFloat(e[1])||1),e.length>=3&&(anchormanifest[a].z=parseFloat(e[2])||1));break}}}};return e.has("altvr.manifest")&&e.get("altvr.manifest").length>0?new Promise((i,a)=>{fetch(altspaceutil.getAbsoluteURL(e.get("altvr.manifest"))).then(e=>e.json()).then(e=>{altspaceutil._fullspaceAppManifest=e,t(altspaceutil._fullspaceAppManifest),i(altspaceutil._fullspaceAppManifest)}).catch(()=>a("Failed to download manifest from "+e.get("altvr.manifest")))}):(altspaceutil._fullspaceAppManifest={enclosure:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},anchors:[]},t(altspaceutil._fullspaceAppManifest),Promise.resolve(altspaceutil._fullspaceAppManifest))},altspaceutil.FullspaceApp=class{constructor(e){this.config=Object.assign({serializationBufferSize:5e5},e),this.config.serializationBufferSize&&altspaceutil.expandSerializationBuffer(this.config.serializationBufferSize)}initialize(){let e=()=>{return this._isInitializing||this._isInitialized?new Promise((e,t)=>{let i=setInterval(()=>{this._isInitializing||(clearInterval(i),e())},10)}):(this._isInitializing=!0,Promise.resolve())},t=altspace.inClient?altspace.getSpace():Promise.resolve({sid:"browser",name:"Web Space",templateSid:"browser"});return new Promise((i,a)=>{e().then(()=>{return this._isInitialized?i(this):(this._isInitializing=!0,Promise.all([altspaceutil.getFullspaceEnclosure(),altspaceutil.getFullspaceAppManifest(),t]).then(e=>{let[t,a,s]=e;if(this._enclosure=t,this._manifest=a,this._space=s,this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera,altspace.inClient)this._renderer=altspace.getThreeJSRenderer();else{this._renderer=new THREE.WebGLRenderer({antialias:!0}),Object.assign(this._camera,{fov:90,near:1,far:2e3}),this._camera.position.z=20;let e=()=>{this._renderer.setClearColor("#99AACC"),document.body.style.margin="0px",document.body.style.overflow="hidden",document.body.appendChild(this._renderer.domElement)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e();let t=()=>{this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",t),t(),this._scene.add(this._camera),this._scene.add(new THREE.AmbientLight("white")),altspace.utilities.shims.cursor.init(this._scene,this._camera,{renderer:this._renderer})}this._anchors={},this._anchor=Object.assign(new THREE.Group,{name:"altvr.enclosure"}),this._scene.add(this._anchor);let n=this._manifest?this._manifest.enclosure:null;n&&(this._anchor.position.copy(n.position),this._anchor.rotation.set(THREE.Math.degToRad(n.rotation.x),THREE.Math.degToRad(n.rotation.y),THREE.Math.degToRad(n.rotation.z)),this._anchor.scale.copy(n.scale)),this._anchorsGroup=Object.assign(new THREE.Group,{name:"altvr.anchors"}),this._anchorsGroup.addBehavior(new class e{get type(){return"_ApplyAppAnchorTransform"}constructor(e){this.anchor=e}awake(e){this.object3d=e,this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}update(){this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}}(this._anchor)),this._scene.add(this._anchorsGroup),this._isInitialized=!0;let r=()=>{window.requestAnimationFrame(r),this._scene.updateAllBehaviors(),this._renderer.render(this._scene,this._camera)};r(),this._isInitializing=!1,i(this)}))}).catch(()=>{this._isInitializing=!1,a("Failed to initialize fullspace app.")})})}anchors(e){if(this._anchors[e])return this._anchors[e];let t=this._anchors[e]=Object.assign(new THREE.Group,{name:e});this._anchorsGroup.add(t);let i=this._manifest.anchors.find(t=>{return t.name===e});return i&&(t.position.copy(i.position),t.rotation.set(THREE.Math.degToRad(i.rotation.x),THREE.Math.degToRad(i.rotation.y),THREE.Math.degToRad(i.rotation.z)),t.scale.copy(i.scale)),t}get scene(){return this._scene}get renderer(){return this._renderer}get camera(){return this._camera}get anchor(){return this._anchor}get enclosure(){return this._enclosure}get space(){return this._space}},altspaceutil.getFullspaceApp=function(e){return altspaceutil._fullspaceApp||(altspaceutil._fullspaceApp=new altspaceutil.FullspaceApp(e)),altspaceutil._fullspaceApp.initialize()},altspaceutil.getAbsoluteURL=function(e){return new URL(e,window.location).toString()},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.loadTexture=function(e,t){if(altspace.inClient)return new THREE.Texture({src:altspaceutil.getAbsoluteURL(e)});t=Object.assign({crossOrigin:"anonymous"},t);var i=new THREE.TextureLoader;return"anonymous"!==t.crossOrigin&&i.setCrossOrigin(t.crossOrigin),void 0!==t.withCredentials&&i.setWithCredentials(t.withCredentials),void 0!==t.path&&i.setPath(t.path),i.load(e)},altspaceutil.setCursorCollider=function(e,t,i){e&&(i?e.traverse(e=>{e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t}):(e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t))},altspaceutil.isCursorCollider=function(e){return!!e&&(!e.userData.altspace||!e.userData.altspace.collider||void 0===e.userData.altspace.enabled||e.userData.altspace.enabled)},altspaceutil.manageBehavior=function(e,t){e.__isManaged=!0,t.__resetManagedBehavior||t.addEventListener("removed",t.__resetManagedBehavior=function(){t.__resetManagedBehavior&&(t.removeEventListener("removed",t.__resetManagedBehavior),t.__resetManagedBehavior=null),t.traverse(function(e){if(e.__behaviorList)for(var t of e.__behaviorList)if(t.__isInitialized&&t.__isManaged)try{t.dispose&&t.dispose.call(t,e),t.__isInitialized=!1}catch(i){console.group(),(console.error||console.log).call(console,i.stack||i),console.log("[Behavior]"),console.log(t),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,t){e.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(e,t){var i=e.clone(!1);if(e.__behaviorList&&e.__behaviorList.length>0)for(var a of e.__behaviorList)try{if(a.clone){var s=a.clone.call(a,i,e);s&&(i.__behaviorList=i.__behaviorList||[],i.__behaviorList.push(s))}}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(a),console.log("[Object3D]"),console.log(e),console.groupEnd()}if(void 0===t||t)for(var n of e.children)i.add(n.cloneWithBehaviors(!0));return i},altspaceutil.loadScript=((e,t)=>{if(t=Object.assign({loadOnce:!0},t),altspaceutil._loadedScripts=altspaceutil._loadedScripts||{},t.scriptTest&&t.scriptTest(e))return Promise.resolve();if(t.loadOnce){if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].loaded)return Promise.resolve();if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].waiting)return altspaceutil._loadedScripts[e].waiting}let i=document.createElement("script");i.src=new URL(e,window.location).toString(),i.async=!1;let a=void 0===altspaceutil._loadedScripts[e],s=new Promise((s,n)=>{i.onload=(()=>{!t.scriptTest||t.scriptTest(e)?s():(console.warn("Script test failed for script at "+i.src),n("Script test failed for script at "+i.src)),a&&(altspaceutil._loadedScripts[e].loaded=!0,altspaceutil._loadedScripts[e].waiting=null)}),i.onerror=(()=>{a&&(altspaceutil._loadedScripts[e].waiting=null,delete altspaceutil._loadedScripts[e]),console.warn("Failed to load script at "+i.src),n("Failed to load script at "+i.src)})});if(a&&(altspaceutil._loadedScripts[e]={waiting:s}),altspaceutil._lastLoadScript)altspaceutil._lastLoadScript.parentNode.insertBefore(i,altspaceutil._lastLoadScript.nextSibling);else{let e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(i,e)}return altspaceutil._lastLoadScript=i,s}),altspaceutil.loadScripts=(e=>{return!e||e.length<=0?Promise.resolve():Promise.all(e.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadScript(e):altspaceutil.loadScript(e.url,e)))}),altspaceutil.behaviors.HoverMaterialColor=function(e){e=e||{},this.type="HoverMaterialColor",this.awake=function(t){this.color=e.color||new THREE.Color("yellow"),this.beginDuration=e.beginDuration||75,this.endDuration=e.endDuration||75,this.revertOnDispose=void 0===e.revertOnDispose||e.revertOnDispose,this.hoverChildren=void 0===e.hoverChildren||e.hoverChildren,this.object3d=t,this.eventListener=e.eventListener||this.object3d,this.material=e.material||this.object3d.material,this.originalColor=this.material.color.clone(),this.srcColor=this.color,this.destColor=this.originalColor,this.srcDuration=this.beginDuration,this.destDuration=this.endDuration,this.duration=this.destDuration,this.progress=1,this.elapsedTime=this.duration,this.eventListener.addEventListener("cursorenter",this.onHoverStateChange.bind(this)),this.eventListener.addEventListener("cursorleave",this.onHoverStateChange.bind(this))},this.update=function(e){this.progress<1&&(this.elapsedTime+=e,this.elapsedTime=THREE.Math.clamp(this.elapsedTime,0,this.duration),this.progress=THREE.Math.clamp(this.elapsedTime/this.duration,0,1),this.material.color.copy(this.srcColor).lerp(this.destColor,this.progress))},this.dispose=function(){this.eventListener.removeEventListener("cursorenter",this.onHoverStateChange.bind(this)),this.eventListener.removeEventListener("cursorleave",this.onHoverStateChange.bind(this)),this.revertOnDispose&&this.material.color.copy(this.originalColor)},this.onHoverStateChange=function(e){if(this.hoverChildren||this.eventListener===e.target){var t=this.srcColor;this.srcColor=this.destColor,this.destColor=t;var t=this.srcDuration;this.srcDuration=this.destDuration,this.destDuration=t,this.duration=this.destDuration,this.progress=1-this.progress,this.elapsedTime=this.duration*this.progress}}};