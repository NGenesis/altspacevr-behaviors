"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.VERSION=altspaceutil.VERSION||"1.1.2",altspaceutil.addNativeEventListener=function(e,t){return altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,t):null},altspaceutil.removeNativeEventListener=function(e,t){altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,t)},altspaceutil.removeAllNativeEventListeners=function(e){altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace._internal&&altspace._internal.getObject3DById?altspace._internal.getObject3DById(e):null},altspaceutil._currentThreeJSScene=null,altspaceutil.getThreeJSScene=function(){return altspace._internal&&altspace._internal.getThreeJSScene?altspace._internal.getThreeJSScene():altspaceutil._currentThreeJSScene},altspaceutil.setThreeJSScene=function(e){altspace._internal&&altspace._internal.setThreeJSScene?altspace._internal.setThreeJSScene(e):altspaceutil._currentThreeJSScene=e},altspaceutil.expandSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&e>0&&altspace._internal.ScratchThriftBuffer.grow(e)},altspaceutil.profileSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===e||e)},altspaceutil.isMobileApp=function(e){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){let e=altspace.inClient?altspace.getEnclosure:()=>{return altspaceutil._BrowserEnclosure||(altspaceutil._BrowserEnclosure=new class extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!0,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil._BrowserEnclosure)};return new Promise((t,s)=>{e().then(e=>e.requestFullspace().then(()=>{e.addEventListener("fullspacechange",()=>{e.fullspace||e.requestFullspace().catch(()=>s("enclosure.requestFullspace() after fullspacechange event failed"))}),t(e)})).catch(()=>s("Failed to get fullspace enclosure."))})},altspaceutil.getFullspaceAppManifest=function(){if(altspaceutil._fullspaceAppManifest)return Promise.resolve(altspaceutil._fullspaceAppManifest);let e=new URLSearchParams(window.location.search),t=t=>{for(let s of e.entries())if(/altvr\.enclosure\.(.*)/i.test(s[0])){let e=s[0].match(/altvr\.enclosure\.(.*)/i)[1],i=t.enclosure=Object.assign({},t.enclosure);switch(i.position=Object.assign({x:0,y:0,z:0},i.position),i.rotation=Object.assign({x:0,y:0,z:0},i.rotation),i.scale=i.hasOwnProperty("scale")&&"number"==typeof i.scale?{x:i.scale||1,y:i.scale||1,z:i.scale||1}:Object.assign({x:1,y:1,z:1},i.scale),e){case"position":case"rotation":{let t=s[1].split(",");t.length>=1&&(i[e].x=parseFloat(t[0])||0),t.length>=2&&(i[e].y=parseFloat(t[1])||0),t.length>=3&&(i[e].z=parseFloat(t[2])||0);break}case"scale":{let t=s[1].split(",");1===t.length?i[e].x=i[e].y=i[e].z=parseFloat(t[0])||1:(t.length>=1&&(i[e].x=parseFloat(t[0])||1),t.length>=2&&(i[e].y=parseFloat(t[1])||1),t.length>=3&&(i[e].z=parseFloat(t[2])||1));break}}}else if(/altvr\.anchors\.(.*)\.(.*)/i.test(s[0])){let[,e,i]=s[0].match(/altvr\.anchors\.(.*)\.(.*)/i),a=t.anchors.findIndex(t=>{return t.name===e});switch(a<0&&(a=t.anchors.push({name:e})-1),anchormanifest=t.anchors[a]=Object.assign({name:e},t.anchors[a]),anchormanifest.position=Object.assign({x:0,y:0,z:0},anchormanifest.position),anchormanifest.rotation=Object.assign({x:0,y:0,z:0},anchormanifest.rotation),anchormanifest.scale=anchormanifest.hasOwnProperty("scale")&&"number"==typeof anchormanifest.scale?{x:anchormanifest.scale||1,y:anchormanifest.scale||1,z:anchormanifest.scale||1}:Object.assign({x:1,y:1,z:1},anchormanifest.scale),i){case"position":case"rotation":{let e=s[1].split(",");e.length>=1&&(anchormanifest[i].x=parseFloat(e[0])||0),e.length>=2&&(anchormanifest[i].y=parseFloat(e[1])||0),e.length>=3&&(anchormanifest[i].z=parseFloat(e[2])||0);break}case"scale":{let e=s[1].split(",");1===e.length?anchormanifest[i].x=anchormanifest[i].y=anchormanifest[i].z=parseFloat(e[0])||1:(e.length>=1&&(anchormanifest[i].x=parseFloat(e[0])||1),e.length>=2&&(anchormanifest[i].y=parseFloat(e[1])||1),e.length>=3&&(anchormanifest[i].z=parseFloat(e[2])||1));break}}}};return e.has("altvr.manifest")&&e.get("altvr.manifest").length>0?new Promise((s,i)=>{fetch(altspaceutil.getAbsoluteURL(e.get("altvr.manifest"))).then(e=>e.json()).then(e=>{altspaceutil._fullspaceAppManifest=e,t(altspaceutil._fullspaceAppManifest),s(altspaceutil._fullspaceAppManifest)}).catch(()=>i("Failed to download manifest from "+e.get("altvr.manifest")))}):(altspaceutil._fullspaceAppManifest={enclosure:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},anchors:[]},t(altspaceutil._fullspaceAppManifest),Promise.resolve(altspaceutil._fullspaceAppManifest))},altspaceutil.FullspaceApp=class{constructor(e){this.config=Object.assign({serializationBufferSize:5e5},e),this.config.serializationBufferSize&&altspaceutil.expandSerializationBuffer(this.config.serializationBufferSize)}initialize(){let e=()=>{return this._isInitializing||this._isInitialized?new Promise((e,t)=>{let s=setInterval(()=>{this._isInitializing||(clearInterval(s),e())},10)}):(this._isInitializing=!0,Promise.resolve())},t=altspace.inClient?altspace.getSpace():Promise.resolve({sid:"browser",name:"Web Space",templateSid:"browser"});return new Promise((s,i)=>{e().then(()=>{return this._isInitialized?s(this):(this._isInitializing=!0,Promise.all([altspaceutil.getFullspaceEnclosure(),altspaceutil.getFullspaceAppManifest(),t]).then(e=>{let[t,i,a]=e;if(this._enclosure=t,this._manifest=i,this._space=a,this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera,altspace.inClient)this._renderer=altspace.getThreeJSRenderer();else{this._renderer=new THREE.WebGLRenderer({antialias:!0}),Object.assign(this._camera,{fov:90,near:1,far:2e3}),this._camera.position.z=20;let e=()=>{this._renderer.setClearColor("#99AACC"),document.body.style.margin="0px",document.body.style.overflow="hidden",document.body.appendChild(this._renderer.domElement),this._renderer.domElement.oncontextmenu=(()=>!1)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e();let t=()=>{this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",t),t(),this._scene.add(this._camera),this._scene.add(new THREE.AmbientLight("white")),altspace.utilities.shims.cursor.init(this._scene,this._camera,{renderer:this._renderer})}this._anchors={},this._anchor=Object.assign(new THREE.Group,{name:"altvr.enclosure"}),this._scene.add(this._anchor);let n=this._manifest?this._manifest.enclosure:null;n&&(this._anchor.position.copy(n.position),this._anchor.rotation.set(THREE.Math.degToRad(n.rotation.x),THREE.Math.degToRad(n.rotation.y),THREE.Math.degToRad(n.rotation.z)),this._anchor.scale.copy(n.scale)),this._anchorsGroup=Object.assign(new THREE.Group,{name:"altvr.anchors"}),this._anchorsGroup.addBehavior(new class e{get type(){return"_ApplyAppAnchorTransform"}constructor(e){this.anchor=e}awake(e){this.object3d=e,this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}update(){this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}}(this._anchor)),this._scene.add(this._anchorsGroup),this._isInitialized=!0;let o=()=>{window.requestAnimationFrame(o),this._scene.updateAllBehaviors(),this._renderer.render(this._scene,this._camera)};o(),this._isInitializing=!1,s(this)}))}).catch(()=>{this._isInitializing=!1,i("Failed to initialize fullspace app.")})})}anchors(e){if(this._anchors[e])return this._anchors[e];let t=this._anchors[e]=Object.assign(new THREE.Group,{name:e});this._anchorsGroup.add(t);let s=this._manifest.anchors.find(t=>{return t.name===e});return s&&(t.position.copy(s.position),t.rotation.set(THREE.Math.degToRad(s.rotation.x),THREE.Math.degToRad(s.rotation.y),THREE.Math.degToRad(s.rotation.z)),t.scale.copy(s.scale)),t}get scene(){return this._scene}get renderer(){return this._renderer}get camera(){return this._camera}get anchor(){return this._anchor}get enclosure(){return this._enclosure}get space(){return this._space}},altspaceutil.getFullspaceApp=function(e){return altspaceutil._fullspaceApp||(altspaceutil._fullspaceApp=new altspaceutil.FullspaceApp(e)),altspaceutil._fullspaceApp.initialize()},altspaceutil.getAbsoluteURL=function(e){return new URL(e,window.location).toString()},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.loadTexture=function(e,t){if(altspace.inClient){if(e.startsWith("blob:")){let t=new THREE.Texture;return fetch(e).then(e=>e.blob()).then(s=>{let i=new FileReader;i.onerror=(()=>console.warn("Failed to load blob texture at "+e)),i.onload=(()=>Object.assign(t,{image:{nodeName:"CANVAS",toDataURL:()=>i.result},needsUpdate:!0})),i.readAsDataURL(s)}),t}return e.startsWith("data:")?Object.assign(new THREE.Texture({nodeName:"CANVAS",toDataURL:()=>e}),{needsUpdate:!0}):new THREE.Texture({src:altspaceutil.getAbsoluteURL(e)})}t=Object.assign({crossOrigin:"anonymous"},t);var s=new THREE.TextureLoader;return"anonymous"!==t.crossOrigin&&s.setCrossOrigin(t.crossOrigin),void 0!==t.withCredentials&&s.setWithCredentials(t.withCredentials),void 0!==t.path&&s.setPath(t.path),s.load(e)},altspaceutil.setCursorCollider=function(e,t,s){e&&(s?e.traverse(e=>{e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t}):(e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t))},altspaceutil.isCursorCollider=function(e){return!!e&&(!e.userData.altspace||!e.userData.altspace.collider||void 0===e.userData.altspace.enabled||e.userData.altspace.enabled)},altspaceutil.manageBehavior=function(e,t){e.__isManaged=!0,t.__resetManagedBehavior||t.addEventListener("removed",t.__resetManagedBehavior=function(){t.__resetManagedBehavior&&(t.removeEventListener("removed",t.__resetManagedBehavior),t.__resetManagedBehavior=null),t.traverse(function(e){if(e.__behaviorList)for(var t of e.__behaviorList)if(t.__isInitialized&&t.__isManaged)try{t.dispose&&t.dispose.call(t,e),t.__isInitialized=!1}catch(s){console.group(),(console.error||console.log).call(console,s.stack||s),console.log("[Behavior]"),console.log(t),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,t){e.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(e,t){var s=e.clone(!1);if(e.__behaviorList&&e.__behaviorList.length>0)for(var i of e.__behaviorList)try{if(i.clone){var a=i.clone.call(i,s,e);a&&(s.__behaviorList=s.__behaviorList||[],s.__behaviorList.push(a))}}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(i),console.log("[Object3D]"),console.log(e),console.groupEnd()}if(void 0===t||t)for(var n of e.children)s.add(n.cloneWithBehaviors(!0));return s},altspaceutil.loadScript=((e,t)=>{if(t=Object.assign({loadOnce:!0},t),altspaceutil._loadedScripts=altspaceutil._loadedScripts||{},t.scriptTest&&t.scriptTest(e))return Promise.resolve();if(t.loadOnce){if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].loaded)return Promise.resolve();if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].waiting)return altspaceutil._loadedScripts[e].waiting}let s=document.createElement("script");s.src=new URL(e,window.location).toString(),s.async=!1;let i=void 0===altspaceutil._loadedScripts[e],a=new Promise((a,n)=>{s.onload=(()=>{!t.scriptTest||t.scriptTest(e)?a():(console.warn("Script test failed for script at "+s.src),n("Script test failed for script at "+s.src)),i&&(altspaceutil._loadedScripts[e].loaded=!0,altspaceutil._loadedScripts[e].waiting=null)}),s.onerror=(()=>{i&&(altspaceutil._loadedScripts[e].waiting=null,delete altspaceutil._loadedScripts[e]),console.warn("Failed to load script at "+s.src),n("Failed to load script at "+s.src)})});if(i&&(altspaceutil._loadedScripts[e]={waiting:a}),altspaceutil._lastLoadScript)altspaceutil._lastLoadScript.parentNode.insertBefore(s,altspaceutil._lastLoadScript.nextSibling);else{let e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(s,e)}return altspaceutil._lastLoadScript=s,a}),altspaceutil.loadScripts=(e=>{return!e||e.length<=0?Promise.resolve():Promise.all(e.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadScript(e):altspaceutil.loadScript(e.url,e)))}),altspaceutil.overrideTextureLoader=(e=>{altspace.inClient&&(altspaceutil._isTextureLoaderOverridden=e)}),altspace.inClient&&(altspaceutil._originalTextureLoaderFunc||(altspaceutil._originalTextureLoaderFunc=THREE.TextureLoader.prototype.load),altspaceutil._isTextureLoaderOverridden=!0,THREE.TextureLoader.prototype.load=function(e,t){if(!altspaceutil._isTextureLoaderOverridden)return altspaceutil._originalTextureLoaderFunc.apply(this,arguments);let s=altspaceutil.loadTexture(e);return t&&t(s),s}),altspaceutil._assetLoaders||(altspaceutil._assetLoaders=new class{constructor(){this.handlers=[],this.add(/\.obj$/i,(e,t)=>{return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/combine/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/MTLLoader.min.js,npm/three@0."+THREE.REVISION+".0/examples/js/loaders/OBJLoader.min.js",{scriptTest:()=>THREE.MTLLoader&&THREE.OBJLoader}).then(()=>{let a=new THREE.FileLoader;a.load(e,a=>{let n=/^[\s]*mtllib[\s]+(.*\.mtl)[\s]*$/m.exec(a);if(n){n=new URL(n[1],e).toString();let o=new THREE.MTLLoader;o.setCrossOrigin(t.crossOrigin),o.setTexturePath(altspaceutil.getBasePath(n)),o.load(n,e=>{e.preload(),s((new THREE.OBJLoader).setMaterials(e).parse(a))},null,()=>i("Could not retrieve materials from "+n))}else s((new THREE.OBJLoader).parse(a))},null,()=>i("Could not retrieve asset from "+e))}).catch(()=>i("Could not load scripts for MTLLoader/OBJLoader"))})}),this.add(/\.gltf|\.glb$/i,(e,t)=>{if(altspace.inClient&&(void 0===t.native||t.native)){let s=new THREE.Object3D;return s.addBehavior(new altspaceutil.behaviors.NativeComponent("n-gltf",{url:e},{useCollider:t.cursorCollider})),Promise.resolve(s)}return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/GLTFLoader.min.js",{scriptTest:()=>THREE.GLTFLoader}).then(()=>{let a=new THREE.GLTFLoader;a.setCrossOrigin(t.crossOrigin),a.load(e,e=>s(e.scene),null,()=>i("Could not retrieve asset from "+e))}).catch(()=>i("Could not load scripts for GLTFLoader"))})}),this.add(/\.dae$/i,(e,t)=>{return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/ColladaLoader.min.js",{scriptTest:()=>THREE.ColladaLoader}).then(()=>{if(altspace.inClient){let a=new THREE.FileLoader;a.load(e,i=>{let a=THREE.TextureLoader.prototype.load;THREE.TextureLoader.prototype.load=((t,...s)=>a.call(this,new URL(t,e).toString(),...s));let n=new THREE.ColladaLoader;n.setCrossOrigin(t.crossOrigin);let o=n.parse(i,altspaceutil.getBasePath(e));THREE.TextureLoader.prototype.load=a,s(o.scene)},null,()=>i("Could not retrieve asset from "+e))}else{let a=new THREE.ColladaLoader;a.setCrossOrigin(t.crossOrigin),a.load(e,e=>s(e.scene),null,()=>i("Could not retrieve asset from "+e))}}).catch(()=>i("Could not load scripts for ColladaLoader"))})}),this.add(/\.fbx$/i,(e,t)=>{return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/combine/npm/three@0."+THREE.REVISION+".0/examples/js/libs/inflate.min.js,npm/three@0."+THREE.REVISION+".0/examples/js/loaders/FBXLoader.min.js",{scriptTest:()=>THREE.FBXLoader}).then(()=>{let a=new THREE.FBXLoader;a.setCrossOrigin(t.crossOrigin),a.load(e,e=>s(e),null,()=>i("Could not retrieve asset from "+e))}).catch(()=>i("Could not load scripts for FBXLoader"))})}),this.add(/\.stl$/i,(e,t)=>{return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/STLLoader.min.js",{scriptTest:()=>THREE.STLLoader}).then(()=>{let a=new THREE.STLLoader;a.setCrossOrigin&&a.setCrossOrigin(t.crossOrigin),a.load(e,e=>s(new THREE.Mesh(e,e.hasColors?new THREE.MeshBasicMaterial({opacity:e.alpha,transparent:e.alpha<1,vertexColors:THREE.VertexColors}):void 0)),null,()=>i("Could not retrieve asset from "+e))}).catch(()=>i("Could not load scripts for STLLoader"))})}),this.add(/\.assimp$/i,(e,t)=>{return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/AssimpLoader.min.js",{scriptTest:()=>THREE.AssimpLoader}).then(()=>{if(altspace.inClient){let a=new THREE.FileLoader;a.setResponseType("arraybuffer"),a.load(e,i=>{let a=THREE.TextureLoader.prototype.load;THREE.TextureLoader.prototype.load=((t,...s)=>a.call(this,new URL(t,e).toString(),...s));let n=new THREE.AssimpLoader;n.setCrossOrigin(t.crossOrigin);let o=n.parse(i,altspaceutil.getBasePath(e));THREE.TextureLoader.prototype.load=a,s(o.object)},null,()=>i("Could not retrieve asset from "+e))}else{let a=new THREE.AssimpLoader;a.setCrossOrigin(t.crossOrigin),a.load(e,e=>s(e.object),null,()=>i("Could not retrieve asset from "+e))}}).catch(()=>i("Could not load scripts for AssimpLoader"))})}),this.add(/\.bom$/i,(e,t)=>{return new Promise((s,i)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/gh/NGenesis/bom-three.js@v0.6.3/examples/js/loaders/BOMLoader.min.js",{scriptTest:()=>THREE.BOMLoader}).then(()=>{let a=new THREE.BOMLoader;a.setCrossOrigin(t.crossOrigin),a.load(e,e=>s(e),null,()=>i("Could not retrieve asset from "+e))}).catch(()=>i("Could not load scripts for BOMLoader"))})})}add(e,t){this.handlers.push({regex:e,handler:t})}remove(e,t){this.handlers=this.handlers.filter(s=>s.regex.toString()!==e.toString()&&(!t||s.handler!==t))}get(e){let t=new URL(e).pathname;for(let s of this.handlers)if(s.regex.test(t))return s.handler;return null}}),altspaceutil.addAssetLoader=((e,t)=>{altspaceutil._assetLoaders.add(e,t)}),altspaceutil.removeAssetLoader=((e,t)=>{altspaceutil._assetLoaders.remove(e,t)}),altspaceutil.loadAsset=((e,t)=>{e=altspaceutil.getAbsoluteURL(e),t=Object.assign({applyTransform:!0,cursorCollider:!1,crossOrigin:"anonymous"},t);let s=e=>{return altspaceutil.setCursorCollider(e,!!t.cursorCollider,!0),t.applyTransform&&(t.position&&(t.position=Object.assign({x:0,y:0,z:0},t.position),e.position.copy(t.position)),t.quaternion?(t.quaternion=Object.assign({x:0,y:0,z:0,w:1},t.quaternion),e.quaternion.copy(t.quaternion)):t.rotation&&(t.rotation=Object.assign({x:0,y:0,z:0},t.rotation),e.rotation.set(t.rotation.x,t.rotation.y,t.rotation.z)),t.scale&&(t.scale=t.hasOwnProperty("scale")&&"number"==typeof t.scale?{x:t.scale||1,y:t.scale||1,z:t.scale||1}:Object.assign({x:1,y:1,z:1},t.scale),e.scale.copy(t.scale))),new Promise((s,i)=>{let a=t.onLoaded?t.onLoaded(e):null;a instanceof Promise?a.then(()=>s(e)).catch(e=>i("Error occurred while processing onLoaded asset handler",e)):s(e)})},i=altspaceutil._assetLoaders.get(e,t);return i?i(e,t).then(s):Promise.reject("Could not get asset handler for "+e)}),altspaceutil.loadAssets=(e=>{return e?new Promise((t,s)=>{let i=Array.isArray(e)?e:Object.values(e);Promise.all(i.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadAsset(e):altspaceutil.loadAsset(e.url,e))).then(s=>{if(Array.isArray(e))t(s);else{let i={};Object.keys(e).forEach((e,t)=>{i[e]=s[t]}),t(i)}}).catch(e=>s("Could not load assets",e))}):Promise.resolve(e)}),window.altspaceutil=window.altspaceutil||{},altspaceutil.shims=altspaceutil.shims||{},altspaceutil.shims.sdk=altspaceutil.shims.sdk||{},void 0===altspaceutil.shims.sdk.inClient&&(altspaceutil.shims.sdk.inClient=!!altspace.inClient),altspaceutil.shims._currentThreeJSScene=null,altspaceutil.shims.sdk.getThreeJSScene=function(){return altspace.inClient&&altspace._internal&&altspace._internal.getThreeJSScene&&(altspaceutil.shims.sdk._currentThreeJSScene=altspace._internal.getThreeJSScene()),altspaceutil.shims.sdk._currentThreeJSScene},altspaceutil.shims.sdk.setThreeJSScene=function(e){altspace.inClient&&altspace._internal&&altspace._internal.setThreeJSScene&&altspace._internal.setThreeJSScene(e),altspaceutil.shims._currentThreeJSScene=e},altspaceutil.shims.sdk.getEnclosure=function(){return altspaceutil.shims.sdk._EnclosureBrowserShim||(altspaceutil.shims.sdk._EnclosureBrowserShim=new class e extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!1,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil.shims.sdk._EnclosureBrowserShim)},altspaceutil.shims.sdk.getDocument=function(){return new Promise((e,t)=>{altspace.getEnclosure().then(t=>{return altspaceutil.shims.sdk._DocumentBrowserShim||(altspaceutil.shims.sdk._DocumentBrowserShim=new class e extends THREE.Mesh{constructor(){super(new THREE.PlaneBufferGeometry(-t.innerWidth/1e3,t.innerHeight/1e3,1,1),Object.assign(new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:new THREE.Texture}),{uuid:"altspace-document",visible:!1})),this.type="Document",this.originalGeometry=this.geometry,this.originalMaterial=this.material,this.inputEnabled=!1,this.audioSpatializationEnabled=!0,this.reset()}get inputEnabled(){return this._inputEnabled}set inputEnabled(e){this._inputEnabled=e}get audioSpatializationEnabled(){return this._audioSpatializationEnabled}set audioSpatializationEnabled(e){this._audioSpatializationEnabled=e}reset(){this.geometry=this.originalGeometry,this.geometry.verticesNeedUpdate=!0,this.geometry.uvsNeedUpdate=!0,this.material=this.originalMaterial,this.material.map.repeat.set(1,1),this.material.map.offset.set(0,0),this.material.side=THREE.DoubleSide;let e=altspaceutil.shims.sdk.getThreeJSScene()||this.parent;e&&(e.add(this),this.matrix.identity(),this.matrix.getInverse(e.matrix),this.applyMatrix(this.matrix))}}),e(altspaceutil.shims.sdk._DocumentBrowserShim)}).catch(e=>t(e))})},altspaceutil.shims.sdk.getSpace=function(){return altspaceutil.shims.sdk._SpaceBrowserShim||(altspaceutil.shims.sdk._SpaceBrowserShim=new class e{constructor(){this.sid="browser",this.name="Web Space",this.templateSid="browser"}}),Promise.resolve(altspaceutil.shims.sdk._SpaceBrowserShim)},altspaceutil.shims.sdk.getUser=function(){return altspaceutil.shims.sdk._UserBrowserShim||(altspaceutil.shims.sdk._UserBrowserShim=new class e{constructor(){this.userId="BrowserGuest",this.displayName="Guest",this.isModerator=!0,this.avatarInfo={sid:"s-series-m01",primaryColor:"rgb(0,0,0)",highlightColor:"rgb(255,255,255)"}}}),Promise.resolve(altspaceutil.shims.sdk._UserBrowserShim)},altspaceutil.shims.sdk.getThreeJSDebugInfo=function(){return Promise.resolve([])},altspaceutil.shims.sdk.getThreeJSTrackingSkeleton=function(){if(!altspaceutil.shims.sdk._ThreeJSTrackingSkeletonBrowserShim){class e extends THREE.Object3D{constructor(e,t,s,i){super(),this.type="TrackingJoint",this.confidence=i,this.name=this.location=e,this.position.copy(t),this.quaternion.copy(s)}getJoint(e,t,s){t=t||"Center",s=void 0===s?0:s,this.trackingJoints[t+e+s]}}altspaceutil.shims.sdk._ThreeJSTrackingSkeletonBrowserShim=new class t extends THREE.Object3D{constructor(){super(),this.type="TrackingSkeleton",Object.values(this.trackingJoints={LeftEye0:new e("LeftEye0",{x:-1.97182,y:1.80098,z:5.81021},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3),RightEye0:new e("RightEye0",{x:-1.96686,y:1.80098,z:5.74999},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3),CenterHead0:new e("CenterHead0",{x:-1.89206,y:1.78727,z:5.78686},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3),CenterNeck0:new e("CenterNeck0",{x:-1.81299,y:1.69395,z:5.79299},{x:-1.8530686175238797e-17,y:-.8420416245242373,z:-1.8530686175238797e-17,w:.539412553217464},3),CenterSpine0:new e("CenterSpine0",{x:-1.81298,y:1.27273,z:5.79299},{x:10001753394771951e-21,y:-.8420524879699061,z:10001753394771948e-21,w:.539395594442169},0),CenterSpine1:new e("CenterSpine1",{x:-1.81299,y:1.3994,z:5.79299},{x:10001753394771951e-21,y:-.8420524879699061,z:10001753394771948e-21,w:.539395594442169},0),CenterSpine2:new e("CenterSpine2",{x:-1.81299,y:1.52607,z:5.79299},{x:10001753394771951e-21,y:-.8420524879699061,z:10001753394771948e-21,w:.539395594442169},0),CenterHips0:new e("CenterHips0",{x:-1.81298,y:1.20273,z:5.79299},{x:-1.8533002074052303e-17,y:-.8420563923075377,z:-1.8533002074052303e-17,w:.5393894995029234},0),CenterEye0:new e("CenterEye0",{x:-1.96934,y:1.80098,z:5.7801},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3)}).forEach(e=>this.add(e))}getJoint(e,t,s){t=t||"Center",s=void 0===s?0:s,this.trackingJoints[t+e+s]}}}return Promise.resolve(altspaceutil.shims.sdk._ThreeJSTrackingSkeletonBrowserShim)},altspaceutil.shims.sdk.getGamepads=function(){return navigator.getGamepads()},altspaceutil.shims.sdk.getThreeJSRenderer=function(e){return altspaceutil.shims.sdk._ThreeJSRendererBrowserShim||(e=Object.assign({antialias:!0,version:"0.2.0"},e),altspaceutil.shims.sdk._ThreeJSRendererBrowserShim=new class e extends THREE.WebGLRenderer{constructor(e){console.log("THREE.AltRenderer",THREE.REVISION),console.log("AltRenderer version "+e.version),super(e)}render(e,t,s,i){altspaceutil.shims.sdk.setThreeJSScene(e),super.render(e,t,s,i)}}(e)),altspaceutil.shims.sdk._ThreeJSRendererBrowserShim},altspaceutil.shims.sdk.open=function(e,t,s){t=t||"_blank",s=Object.assign({hidden:!1},s);let i=new class i{constructor(){this.window=null,this.url=e,this.closed=!1,s.hidden&&"_blank"===t||(this.window=window.open(this.url,"_blank"))}show(){return this.closed||this.window||(this.window=window.open(this.url,"_blank")),Promise.resolve()}close(){return!this.closed&&this.window&&(this.closed=!0,this.window.close(),this.window=null),Promise.resolve()}};return Promise.resolve(i)},altspaceutil.initializeAltspaceShims=function(e){return altspace.inClient&&!e||(altspace.inClient=altspaceutil.shims.sdk.inClient,altspace.getDocument=altspaceutil.shims.sdk.getDocument,altspace.getEnclosure=altspaceutil.shims.sdk.getEnclosure,altspace.getSpace=altspaceutil.shims.sdk.getSpace,altspace.getUser=altspaceutil.shims.sdk.getUser,altspace.getThreeJSDebugInfo=altspaceutil.shims.sdk.getThreeJSDebugInfo,altspace.getThreeJSTrackingSkeleton=altspaceutil.shims.sdk.getThreeJSTrackingSkeleton,altspace.getGamepads=altspaceutil.shims.sdk.getGamepads,altspace.getThreeJSRenderer=altspaceutil.shims.sdk.getThreeJSRenderer,altspace.open=altspaceutil.shims.sdk.open),Promise.resolve()},altspaceutil.initializeAltspaceShims(),altspaceutil.behaviors.TransformControls=function(e){this.type="TransformControls",this.config=Object.assign({controlType:"none",showButtons:!1,followTarget:!0,target:null,scale:1,allowNegativeScale:!1,disableColliders:!0,disableChildColliders:!0},e),this.config.positionAxisLock=Object.assign({x:!0,y:!0,z:!0},this.config.positionAxisLock),this.config.rotateAxisLock=Object.assign({x:!0,y:!0,z:!0},this.config.rotateAxisLock),this.config.scaleAxisLock=Object.assign({x:!0,y:!0,z:!0},this.config.scaleAxisLock),this.awake=function(e,t){this.object3d=e,this.scene=t,this.target=this.config.target||this.object3d,altspaceutil.behaviors.TransformControls.Materials||(altspaceutil.behaviors.TransformControls.Materials={red:new THREE.MeshBasicMaterial({color:16711680}),green:new THREE.MeshBasicMaterial({color:65280}),blue:new THREE.MeshBasicMaterial({color:255}),yellow:new THREE.MeshBasicMaterial({color:16776960}),orange:new THREE.MeshBasicMaterial({color:16763904}),hidden:new THREE.MeshBasicMaterial({side:THREE.DoubleSide,visible:!1}),"red-transclucent":new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.2}),"green-transclucent":new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:.2}),"blue-transclucent":new THREE.MeshBasicMaterial({color:255,transparent:!0,opacity:.2})}),altspaceutil.behaviors.TransformControls.Geometries||(altspaceutil.behaviors.TransformControls.Geometries={button:new THREE.BoxBufferGeometry(.2,.2,.2),intersector:new THREE.PlaneBufferGeometry(1e5,1e5)}),altspaceutil.manageBehavior(this,this.object3d),this.objectState={},this.controls={none:null,position:new THREE.Group,rotate:new THREE.Group,scale:new THREE.Group},this.selectedControlType=this.config.controlType,this.selectedControl=null,this.controlTypeButtons=null,this.scene.addEventListener("cursormove",function(e){if(!this.selectedControl)return void(this.hoveredAxis&&(this.hoveredAxis.traverse(function(e){e instanceof THREE.Mesh&&e.userData.material&&(e.material=e.userData.material,delete e.userData.material,e.geometry.uvsNeedUpdate=!0)}.bind(this)),this.hoveredAxis=null));this.raycaster.set(e.ray.origin,e.ray.direction);var t=this.raycaster.intersectObject(this.selectedControl,!0)[0];!this.hoveredAxis||t&&this.hoveredAxis===t.object||(this.dragAxis||this.hoveredAxis.traverse(function(e){e instanceof THREE.Mesh&&e.userData.material&&(e.material=e.userData.material,delete e.userData.material,e.geometry.uvsNeedUpdate=!0)}.bind(this)),this.hoveredAxis=null),t&&(this.hoveredAxis=t.object,this.dragAxis||this.hoveredAxis.traverse(function(e){e instanceof THREE.Mesh&&!e.userData.material&&e.material.visible&&(e.userData.material=e.material,e.material=altspaceutil.behaviors.TransformControls.Materials.orange,e.geometry.uvsNeedUpdate=!0)}.bind(this)))}.bind(this));var s=function(e,t,s,i){return Object.assign(i?new THREE.Mesh(new THREE.BoxBufferGeometry(s.width,s.height,s.depth),altspaceutil.behaviors.TransformControls.Materials[t]):new THREE.Group,{name:e})}.bind(this),i=function(e,t,s,i,a,n){if(!n)return Object.assign(new THREE.Object3D,{name:e});if(altspaceutil.behaviors.TransformControls.Geometries["axis-position-"+e]){var o=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries["axis-position-"+e].clone(),altspaceutil.behaviors.TransformControls.Materials[t]),{name:e});return o.position.set(i.x,i.y,i.z),o.rotation.set(a.x,a.y,a.z),o}var o=Object.assign(new THREE.Mesh(new THREE.BoxGeometry(s.width,s.height,s.depth),altspaceutil.behaviors.TransformControls.Materials[t]),{name:e});o.position.set(i.x,i.y,i.z),o.rotation.set(a.x,a.y,a.z);var r=new THREE.Object3D;r.position.set(s.width/2,0,0),r.rotation.set(0,0,-Math.PI/2),r.updateMatrix();var l=new THREE.CylinderGeometry(0,2*s.depth,4*s.depth,4,1,!1,Math.PI/4);return l.applyMatrix(r.matrix),o.geometry.merge(l),o.geometry=(new THREE.BufferGeometry).fromGeometry(o.geometry),altspaceutil.behaviors.TransformControls.Geometries["axis-position-"+e]=o.geometry,
o}.bind(this),a=function(e,t,s,i,a){if(!a)return Object.assign(new THREE.Object3D,{name:e});altspaceutil.behaviors.TransformControls.Geometries["axis-rotate-"+e]||(altspaceutil.behaviors.TransformControls.Geometries["axis-rotate-"+e]=new THREE.RingBufferGeometry(.8*s.radius,1.5*s.radius,10,1));var n=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries["axis-rotate-"+e],altspaceutil.behaviors.TransformControls.Materials.hidden),{name:e});n.rotation.set(i.x,i.y,i.z);var o=Object.assign(new THREE.Mesh(new THREE.TorusBufferGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments),altspaceutil.behaviors.TransformControls.Materials[t]),{name:e});return n.add(o),n}.bind(this),n=function(e,t,s,i,a,n){if(!n)return Object.assign(new THREE.Object3D,{name:e});if(altspaceutil.behaviors.TransformControls.Geometries["axis-scale-"+e]){var o=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries["axis-scale-"+e].clone(),altspaceutil.behaviors.TransformControls.Materials[t]),{name:e});return o.position.set(i.x,i.y,i.z),o.rotation.set(a.x,a.y,a.z),o}var o=Object.assign(new THREE.Mesh(new THREE.BoxGeometry(s.width,s.height,s.depth),altspaceutil.behaviors.TransformControls.Materials[t]),{name:e});o.position.set(i.x,i.y,i.z),o.rotation.set(a.x,a.y,a.z);var r=new THREE.Object3D;r.position.set(s.width/2,0,0),r.rotation.set(0,0,-Math.PI/2),r.updateMatrix();var l=new THREE.BoxGeometry(2*s.depth,2*s.depth,2*s.depth);return l.applyMatrix(r.matrix),o.geometry.merge(l),o.geometry=(new THREE.BufferGeometry).fromGeometry(o.geometry),altspaceutil.behaviors.TransformControls.Geometries["axis-scale-"+e]=o.geometry,o}.bind(this);if(this.controls.position.name="position",this.controls.position.add(s("xyz","yellow",{width:.15,height:.15,depth:.15},this.config.positionAxisLock.x||this.config.positionAxisLock.y||this.config.positionAxisLock.z).add(i("x","red",{width:1,height:.05,depth:.05},{x:.5,y:0,z:0},{x:0,y:0,z:0},this.config.positionAxisLock.x),i("y","green",{width:1,height:.05,depth:.05},{x:0,y:.5,z:0},{x:0,y:0,z:Math.PI/2},this.config.positionAxisLock.y),i("z","blue",{width:1,height:.05,depth:.05},{x:0,y:0,z:.5},{x:Math.PI/2,y:0,z:Math.PI/2},this.config.positionAxisLock.z))),this.controls.rotate.name="rotate",this.controls.rotate.add(s("xyz","yellow",{width:.05,height:.05,depth:.05},this.config.rotateAxisLock.x||this.config.rotateAxisLock.y||this.config.rotateAxisLock.z).add(a("x","red",{radius:.7,tube:.03,radialSegments:8,tubularSegments:28},{x:0,y:Math.PI/2,z:0},this.config.rotateAxisLock.x),a("y","green",{radius:.7,tube:.03,radialSegments:8,tubularSegments:28},{x:Math.PI/2,y:0,z:0},this.config.rotateAxisLock.y),a("z","blue",{radius:.7,tube:.03,radialSegments:8,tubularSegments:28},{x:0,y:0,z:0},this.config.rotateAxisLock.z))),this.controls.scale.name="scale",this.controls.scale.add(s("xyz","yellow",{width:.15,height:.15,depth:.15},this.config.scaleAxisLock.x||this.config.scaleAxisLock.y||this.config.scaleAxisLock.z).add(n("x","red",{width:1,height:.05,depth:.05},{x:.5,y:0,z:0},{x:0,y:0,z:0},this.config.scaleAxisLock.x),n("y","green",{width:1,height:.05,depth:.05},{x:0,y:.5,z:0},{x:0,y:0,z:Math.PI/2},this.config.scaleAxisLock.y),n("z","blue",{width:1,height:.05,depth:.05},{x:0,y:0,z:.5},{x:Math.PI/2,y:0,z:Math.PI/2},this.config.scaleAxisLock.z))),this.onDragBegin=function(e){if(this.dragAxis=null,this.selectedControl){this.raycaster.set(e.ray.origin,e.ray.direction);var t=this.raycaster.intersectObject(this.selectedControl,!0)[0];if(t){this.dragAxis=t.object.name,this.hoveredAxis&&this.hoveredAxis.traverse(function(e){e instanceof THREE.Mesh&&e.userData.material&&(e.material=e.userData.material,delete e.userData.material,e.geometry.uvsNeedUpdate=!0)}.bind(this));var s=this.selectedControl.getObjectByName(this.dragAxis);s&&s.traverse(function(e){e instanceof THREE.Mesh&&!e.userData.material&&e.material.visible&&(e.userData.material=e.material,e.material=altspaceutil.behaviors.TransformControls.Materials.orange,e.geometry.uvsNeedUpdate=!0)}.bind(this)),this.scene.updateMatrixWorld(),this.dragPointBegin=t.point.clone(),this.controlbase.removeEventListener("cursordown",this.onDragBegin),this.scene.addEventListener("cursorup",this.onDragEnd),this.scene.addEventListener("cursormove",this.onDragMove),this.intersector.quaternion.copy(this.selectedControl.getObjectByName(this.dragAxis).quaternion),"xyz"===this.dragAxis&&(this.originIntersectors.traverse(function(e){e instanceof THREE.Mesh&&(e.visible=!0)}),t=this.raycaster.intersectObjects([this.originIntersectors.children[0],this.originIntersectors.children[1],this.originIntersectors.children[2]],!0)[0],this.originIntersector=t&&t.object?t.object:this.intersector,t&&(this.dragPointBegin=t.point.clone()),this.originIntersectors.traverse(function(e){e instanceof THREE.Mesh&&(e.visible=!1)})),this.dispatchDragBeginEvent()}}}.bind(this),this.onDragMove=function(e){if(!this.selectedControl)return this.scene.removeEventListener("cursorup",this.onDragEnd),this.scene.removeEventListener("cursormove",this.onDragMove),this.controlbase.addEventListener("cursordown",this.onDragBegin),void(this.dragAxis=null);var t;if(this.raycaster.set(e.ray.origin,e.ray.direction),"xyz"===this.dragAxis?(this.originIntersector.visible=!0,t=this.raycaster.intersectObject(this.originIntersector,!0)[0],this.originIntersector.visible=!1):(this.intersector.quaternion.copy(this.selectedControl.getObjectByName(this.dragAxis).quaternion),this.intersector.visible=!0,t=this.raycaster.intersectObject(this.intersector,!0)[0],this.intersector.visible=!1),t){var s=this.dragPointBegin.clone().sub(this.object3d.position),i=t.point.clone().sub(this.object3d.position),a=t.point.clone().sub(this.dragPointBegin);this.dragPointBegin=t.point.clone();var n=new THREE.Vector3;if("position"===this.selectedControlType)switch(this.dragAxis){case"x":case"y":case"z":this.config.positionAxisLock[this.dragAxis]&&(n[this.dragAxis]+=a[this.dragAxis],this.target.position.add(n));break;case"xyz":(this.config.positionAxisLock.x||this.config.positionAxisLock.y||this.config.positionAxisLock.z)&&("x"===this.originIntersector.name?n.set(this.config.positionAxisLock.x?a.x:0,this.config.positionAxisLock.y?a.y:0,0):"y"===this.originIntersector.name?n.set(0,this.config.positionAxisLock.y?a.y:0,this.config.positionAxisLock.z?a.z:0):"z"===this.originIntersector.name?n.set(this.config.positionAxisLock.x?a.x:0,0,this.config.positionAxisLock.z?a.z:0):n.set(this.config.positionAxisLock.x?a.x:0,this.config.positionAxisLock.y?a.y:0,this.config.positionAxisLock.z?a.z:0),this.target.position.add(n))}else if("scale"===this.selectedControlType)switch(this.dragAxis){case"x":case"y":case"z":this.config.scaleAxisLock[this.dragAxis]&&(n[this.dragAxis]+=a[this.dragAxis],this.target.scale.add(n),(void 0===this.target.scale[this.dragAxis]||isNaN(this.target.scale[this.dragAxis])||!this.config.allowNegativeScale&&this.target.scale[this.dragAxis]<0)&&(this.target.scale[this.dragAxis]=Number.EPSILON));break;default:if(this.config.scaleAxisLock.x||this.config.scaleAxisLock.y||this.config.scaleAxisLock.z){var o=a.x;Math.abs(a.y)>Math.abs(o)&&(o=a.y),Math.abs(a.z)>Math.abs(o)&&(o=a.z),n.set(this.config.scaleAxisLock.x?o:0,this.config.scaleAxisLock.y?o:0,this.config.scaleAxisLock.z?o:0),this.target.scale.add(n),(void 0===this.target.scale.x||isNaN(this.target.scale.x)||!this.config.allowNegativeScale&&this.target.scale.x<0)&&(this.target.scale.x=Number.EPSILON),(void 0===this.target.scale.y||isNaN(this.target.scale.y)||!this.config.allowNegativeScale&&this.target.scale.y<0)&&(this.target.scale.y=Number.EPSILON),(void 0===this.target.scale.z||isNaN(this.target.scale.z)||!this.config.allowNegativeScale&&this.target.scale.z<0)&&(this.target.scale.z=Number.EPSILON)}}else if("rotate"===this.selectedControlType&&this.config.rotateAxisLock[this.dragAxis]){switch(this.dragAxis){case"x":var r=Math.atan2(i.z,i.y)-Math.atan2(s.z,s.y);n[this.dragAxis]+=r;break;case"y":var r=Math.atan2(i.x,i.z)-Math.atan2(s.x,s.z);n[this.dragAxis]+=r;break;case"z":var r=Math.atan2(i.y,i.x)-Math.atan2(s.y,s.x);n[this.dragAxis]+=r}this.target.rotation[this.dragAxis]+=n[this.dragAxis]}this.updateTransform(),this.dispatchDragMoveEvent(n)}}.bind(this),this.onDragEnd=function(e){this.scene.removeEventListener("cursorup",this.onDragEnd),this.scene.removeEventListener("cursormove",this.onDragMove),this.controlbase.addEventListener("cursordown",this.onDragBegin);var t=this.dragAxis;if(this.dragAxis=null,this.selectedControl&&t){var s=this.selectedControl.getObjectByName(t);s&&s.traverse(function(e){e instanceof THREE.Mesh&&e.userData.material&&(e.material=e.userData.material,delete e.userData.material,e.geometry.uvsNeedUpdate=!0)}.bind(this)),this.hoveredAxis&&this.hoveredAxis.traverse(function(e){e instanceof THREE.Mesh&&!e.userData.material&&e.material.visible&&(e.userData.material=e.material,e.material=altspaceutil.behaviors.TransformControls.Materials.orange,e.geometry.uvsNeedUpdate=!0)}.bind(this))}if(this.selectedControl){var i;if(this.raycaster.set(e.ray.origin,e.ray.direction),"xyz"===t?(this.originIntersector.visible=!0,i=this.raycaster.intersectObject(this.originIntersector,!0)[0],this.originIntersector.visible=!1):(this.intersector.quaternion.copy(this.selectedControl.getObjectByName(t).quaternion),this.intersector.visible=!0,i=this.raycaster.intersectObject(this.intersector,!0)[0],this.intersector.visible=!1),i){var a=this.dragPointBegin.clone().sub(this.object3d.position),n=i.point.clone().sub(this.object3d.position),o=i.point.clone().sub(this.dragPointBegin);this.dragPointBegin=i.point.clone();var r=new THREE.Vector3;if("position"===this.selectedControlType)switch(t){case"x":case"y":case"z":this.config.positionAxisLock[t]&&(r[t]+=o[t],this.target.position.add(r));break;case"xyz":(this.config.positionAxisLock.x||this.config.positionAxisLock.y||this.config.positionAxisLock.z)&&("x"===this.originIntersector.name?r.set(this.config.positionAxisLock.x?o.x:0,this.config.positionAxisLock.y?o.y:0,0):"y"===this.originIntersector.name?r.set(0,this.config.positionAxisLock.y?o.y:0,this.config.positionAxisLock.z?o.z:0):"z"===this.originIntersector.name?r.set(this.config.positionAxisLock.x?o.x:0,0,this.config.positionAxisLock.z?o.z:0):r.set(this.config.positionAxisLock.x?o.x:0,this.config.positionAxisLock.y?o.y:0,this.config.positionAxisLock.z?o.z:0),this.target.position.add(r))}else if("scale"===this.selectedControlType)switch(t){case"x":case"y":case"z":this.config.scaleAxisLock[t]&&(r[t]+=o[t],this.target.scale.add(r),(void 0===this.target.scale[t]||isNaN(this.target.scale[t])||!this.config.allowNegativeScale&&this.target.scale[t]<0)&&(this.target.scale[t]=Number.EPSILON));break;default:if(this.config.scaleAxisLock.x||this.config.scaleAxisLock.y||this.config.scaleAxisLock.z){var l=o.x;Math.abs(o.y)>Math.abs(l)&&(l=o.y),Math.abs(o.z)>Math.abs(l)&&(l=o.z),r.set(this.config.scaleAxisLock.x?l:0,this.config.scaleAxisLock.y?l:0,this.config.scaleAxisLock.z?l:0),this.target.scale.add(r),(void 0===this.target.scale.x||isNaN(this.target.scale.x)||!this.config.allowNegativeScale&&this.target.scale.x<0)&&(this.target.scale.x=Number.EPSILON),(void 0===this.target.scale.y||isNaN(this.target.scale.y)||!this.config.allowNegativeScale&&this.target.scale.y<0)&&(this.target.scale.y=Number.EPSILON),(void 0===this.target.scale.z||isNaN(this.target.scale.z)||!this.config.allowNegativeScale&&this.target.scale.z<0)&&(this.target.scale.z=Number.EPSILON)}}else if("rotate"===this.selectedControlType&&this.config.rotateAxisLock[t]){switch(t){case"x":var c=Math.atan2(n.z,n.y)-Math.atan2(a.z,a.y);r[t]+=c;break;case"y":var c=Math.atan2(n.x,n.z)-Math.atan2(a.x,a.z);r[t]+=c;break;case"z":var c=Math.atan2(n.y,n.x)-Math.atan2(a.y,a.x);r[t]+=c}this.target.rotation[t]+=r[t]}this.updateTransform(),this.dispatchDragMoveEvent(r),this.dispatchDragEndEvent(t)}}}.bind(this),this.config.showButtons){var o=function(e){this.buttonDownControlType=e.target.name}.bind(this),r=function(e){e.target.name===this.buttonDownControlType&&this.setActiveControl(this.buttonDownControlType===this.selectedControlType?"none":this.buttonDownControlType)}.bind(this);this.controlTypeButtons=new THREE.Group,this.controlTypeButtons.position.set(.5,1,0);var l=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.button,altspaceutil.behaviors.TransformControls.Materials["red-transclucent"]),{name:"position"}),c=this.controls.position.clone();c.position.set(-.025,-.025,-.025),c.scale.multiplyScalar(.1),l.add(c),l.addEventListener("cursordown",o),l.addEventListener("cursorup",r);var h=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.button,altspaceutil.behaviors.TransformControls.Materials["green-transclucent"]),{name:"rotate"}),u=this.controls.rotate.clone();u.scale.multiplyScalar(.1),h.add(u),h.position.set(.25,0,0),h.addEventListener("cursordown",o),h.addEventListener("cursorup",r);var d=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.button,altspaceutil.behaviors.TransformControls.Materials["blue-transclucent"]),{name:"scale"}),p=this.controls.scale.clone();p.position.set(-.025,-.025,-.025),p.scale.multiplyScalar(.1),d.add(p),d.position.set(.5,0,0),d.addEventListener("cursordown",o),d.addEventListener("cursorup",r),this.controlTypeButtons.add(l,h,d)}this.raycaster=new THREE.Raycaster,this.intersector=Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.intersector,altspaceutil.behaviors.TransformControls.Materials.hidden),{visible:!1}),this.originIntersectors=new THREE.Group,this.originIntersectors.add(Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.intersector,altspaceutil.behaviors.TransformControls.Materials.hidden),{name:"x",visible:!1}),Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.intersector,altspaceutil.behaviors.TransformControls.Materials.hidden),{name:"y",visible:!1}),Object.assign(new THREE.Mesh(altspaceutil.behaviors.TransformControls.Geometries.intersector,altspaceutil.behaviors.TransformControls.Materials.hidden),{name:"z",visible:!1})),this.originIntersectors.children[1].rotation.y=Math.PI/2,this.originIntersectors.children[2].rotation.x=Math.PI/2,this.controlbase=new THREE.Group,this.controlbase.add(this.controls.position,this.controls.rotate,this.controls.scale,this.intersector,this.originIntersectors),this.controlbase.traverse(function(e){e.userData.isTransformControl=!0,e.visible=!1}),this.controlbase.addEventListener("cursordown",this.onDragBegin),this.scene.add(this.controlbase),this.controlbase.scale.setScalar(this.config.scale),this.controlTypeButtons&&this.controlbase.add(this.controlTypeButtons),this.setActiveControl(this.selectedControlType)},this.dispatchDragMoveEvent=function(e){if(0!==e.x||0!==e.y||0!==e.z){var t=this;this.object3d.dispatchEvent({type:"transform-controls-dragmove",detail:{behavior:t,parent:t.object3d,transformTarget:t.target,transformType:t.selectedControlType,transformAxis:t.dragAxis,transformDelta:e},bubbles:!0,target:t.object3d})}},this.dispatchDragBeginEvent=function(){var e=this;this.object3d.dispatchEvent({type:"transform-controls-dragbegin",detail:{behavior:e,parent:e.object3d,transformTarget:e.target,transformType:e.selectedControlType,transformAxis:e.dragAxis},bubbles:!0,target:e.object3d})},this.dispatchDragEndEvent=function(e){var t=this;this.object3d.dispatchEvent({type:"transform-controls-dragend",detail:{behavior:t,parent:t.object3d,transformTarget:t.target,transformType:t.selectedControlType,transformAxis:e},bubbles:!0,target:t.object3d})},this.updateTransform=function(){this.scene.updateMatrixWorld(),this.controlbase.position.copy((this.config.followTarget?this.target:this.object3d).getWorldPosition(new THREE.Vector3))},this.update=function(){this.updateTransform(),this.target&&(this.config.disableColliders||this.config.disableChildColliders)&&this.target.traverse(function(e){e===this.target&&!this.config.disableColliders||e!==this.target&&!this.config.disableChildColliders||e.userData.isTransformControl||e.userData.altspace&&e.userData.altspace.collider&&!e.userData.altspace.collider.enabled||(this.objectState[e.uuid]=Object.assign(this.objectState[e.uuid]||{},{collider:{enabled:!0}}),e.userData.altspace={collider:{enabled:!1}})}.bind(this))},this.dispose=function(){this.setActiveControl("none"),this.intersector&&this.intersector.parent&&this.intersector.parent.remove(this.intersector),this.controlTypeButtons&&this.controlTypeButtons.parent&&this.controlTypeButtons.parent.remove(this.controlTypeButtons),this.target&&(this.config.disableColliders||this.config.disableChildColliders)&&this.target.traverse(function(e){e===this.target&&!this.config.disableColliders||e!==this.target&&!this.config.disableChildColliders||!e.userData.isTransformControl&&this.objectState[e.uuid]&&(e.userData.altspace=Object.assign(e.userData.altspace||{},{collider:this.objectState[e.uuid].collider}),delete this.objectState[e.uuid])}.bind(this)),this.object3d=null,this.target=null,this.scene=null,this.objectState=null,this.controls=null,this.selectedControlType=null,this.selectedControl=null,this.controlbase=null,this.controlTypeButtons=null,this.buttonDownControlType=null,this.intersector=null,this.raycaster=null,this.originIntersectors=null,this.originIntersector=null,this.dragPointBegin=null,this.dragAxis=null,this.hoveredAxis=null,this.onDragBegin=null,this.onDragEnd=null,this.onDragMove=null},this.setActiveControl=function(e){if(!this.controls&&["none","position","rotate","scale"].indexOf(e)>=0)return void(this.config.controlType=e);if(this.controls&&this.object3d&&this.target&&this.controls.hasOwnProperty(e)){if(this.selectedControl){if(e===this.selectedControl.name)return;this.selectedControl.traverse(function(e){e.visible=!1})}else if("none"===e)return;this.selectedControl=this.controls[e],this.selectedControlType=this.selectedControl?this.selectedControl.name:"none",this.selectedControl&&this.selectedControl.traverse(function(e){e.visible=!0}),this.update()}},this.getActiveControl=function(){return this.selectedControlType},this.setTarget=function(e){this.target&&(this.config.disableColliders||this.config.disableChildColliders)&&this.target.traverse(function(e){e===this.target&&!this.config.disableColliders||e!==this.target&&!this.config.disableChildColliders||!e.userData.isTransformControl&&this.objectState[e.uuid]&&(e.userData.altspace=Object.assign(e.userData.altspace||{},{collider:this.objectState[e.uuid].collider}),delete this.objectState[e.uuid])}.bind(this)),this.target=this.config.target=e,this.target&&(this.config.disableColliders||this.config.disableChildColliders)&&this.target.traverse(function(e){e===this.target&&!this.config.disableColliders||e!==this.target&&!this.config.disableChildColliders||e.userData.isTransformControl||e.userData.altspace&&e.userData.altspace.collider&&!e.userData.altspace.collider.enabled||(this.objectState[e.uuid]=Object.assign(this.objectState[e.uuid]||{},{collider:{enabled:!0}}),e.userData.altspace={collider:{enabled:!1}})}.bind(this))},this.getTarget=function(){return this.target}},window.AFRAME&&(AFRAME.components["altspace-transform-controls"]&&delete AFRAME.components["altspace-transform-controls"],AFRAME.registerComponent("altspace-transform-controls",{schema:{controlType:{type:"string",default:"none"},showButtons:{type:"boolean",default:!1},followTarget:{type:"boolean",default:!0},target:{type:"selector"},scale:{type:"number",default:1},allowNegativeScale:{type:"boolean",default:!1},syncEvents:{type:"boolean",default:!0},positionAxisLock:{default:"xyz",parse:function(e){return{x:e.indexOf("x")!==-1,y:e.indexOf("y")!==-1,z:e.indexOf("z")!==-1}}},rotateAxisLock:{default:"xyz",parse:function(e){return{x:e.indexOf("x")!==-1,y:e.indexOf("y")!==-1,z:e.indexOf("z")!==-1}}},scaleAxisLock:{default:"xyz",parse:function(e){return{x:e.indexOf("x")!==-1,y:e.indexOf("y")!==-1,z:e.indexOf("z")!==-1}}},disableColliders:{type:"boolean",default:!0},disableChildColliders:{type:"boolean",default:!0}},init:function(){if(this.behavior=new altspaceutil.behaviors.TransformControls({controlType:this.data.controlType,showButtons:this.data.showButtons,followTarget:this.data.followTarget,target:this.data.target?this.data.target.object3D:null,scale:this.data.scale,allowNegativeScale:this.data.allowNegativeScale,positionAxisLock:this.data.positionAxisLock,rotateAxisLock:this.data.rotateAxisLock,scaleAxisLock:this.data.scaleAxisLock,disableColliders:this.data.disableColliders,disableChildColliders:this.data.disableChildColliders}),this.el.object3D.addBehavior(this.behavior),this.data.syncEvents){var e=function(e){var t=this.el.object3D.getBehaviorByType("TransformControls").getTarget().el;t&&t.components.sync&&t.components.sync.isConnected&&(t.components.sync.takeOwnership(),t.setAttribute("position",t.object3D.position),t.setAttribute("rotation",{x:THREE.Math.radToDeg(t.object3D.rotation.x),y:THREE.Math.radToDeg(t.object3D.rotation.y),z:THREE.Math.radToDeg(t.object3D.rotation.z)}),t.setAttribute("scale",t.object3D.scale))}.bind(this);this.el.object3D.addEventListener("transform-controls-dragbegin",e),this.el.object3D.addEventListener("transform-controls-dragmove",e),this.el.object3D.addEventListener("transform-controls-dragend",e)}},remove:function(){this.behavior&&this.el.object3D.removeBehavior(this.behavior)}}));