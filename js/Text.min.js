"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.VERSION=altspaceutil.VERSION||"1.1.3",altspaceutil.addNativeEventListener=function(e,t){return altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,t):null},altspaceutil.removeNativeEventListener=function(e,t){altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,t)},altspaceutil.removeAllNativeEventListeners=function(e){altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace._internal&&altspace._internal.getObject3DById?altspace._internal.getObject3DById(e):null},altspaceutil._currentThreeJSScene=null,altspaceutil.getThreeJSScene=function(){return altspace._internal&&altspace._internal.getThreeJSScene?altspace._internal.getThreeJSScene():altspaceutil._currentThreeJSScene},altspaceutil.setThreeJSScene=function(e){altspace._internal&&altspace._internal.setThreeJSScene?altspace._internal.setThreeJSScene(e):altspaceutil._currentThreeJSScene=e},altspaceutil.expandSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&e>0&&altspace._internal.ScratchThriftBuffer.grow(e)},altspaceutil.profileSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===e||e)},altspaceutil.isMobileApp=function(e){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){let e=altspace.inClient?altspace.getEnclosure:()=>{return altspaceutil._BrowserEnclosure||(altspaceutil._BrowserEnclosure=new class extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!0,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil._BrowserEnclosure)};return new Promise((t,i)=>{e().then(e=>e.requestFullspace().then(()=>{e.addEventListener("fullspacechange",()=>{e.fullspace||e.requestFullspace().catch(()=>i("enclosure.requestFullspace() after fullspacechange event failed"))}),t(e)})).catch(()=>i("Failed to get fullspace enclosure."))})},altspaceutil.getFullspaceAppManifest=function(){if(altspaceutil._fullspaceAppManifest)return Promise.resolve(altspaceutil._fullspaceAppManifest);let e=new URLSearchParams(window.location.search),t=t=>{for(let i of e.entries())if(/altvr\.enclosure\.(.*)/i.test(i[0])){let e=i[0].match(/altvr\.enclosure\.(.*)/i)[1],n=t.enclosure=Object.assign({},t.enclosure);switch(n.position=Object.assign({x:0,y:0,z:0},n.position),n.rotation=Object.assign({x:0,y:0,z:0},n.rotation),n.scale=n.hasOwnProperty("scale")&&"number"==typeof n.scale?{x:n.scale||1,y:n.scale||1,z:n.scale||1}:Object.assign({x:1,y:1,z:1},n.scale),e){case"position":case"rotation":{let t=i[1].split(",");t.length>=1&&(n[e].x=parseFloat(t[0])||0),t.length>=2&&(n[e].y=parseFloat(t[1])||0),t.length>=3&&(n[e].z=parseFloat(t[2])||0);break}case"scale":{let t=i[1].split(",");1===t.length?n[e].x=n[e].y=n[e].z=parseFloat(t[0])||1:(t.length>=1&&(n[e].x=parseFloat(t[0])||1),t.length>=2&&(n[e].y=parseFloat(t[1])||1),t.length>=3&&(n[e].z=parseFloat(t[2])||1));break}}}else if(/altvr\.anchors\.(.*)\.(.*)/i.test(i[0])){let[,e,n]=i[0].match(/altvr\.anchors\.(.*)\.(.*)/i),s=t.anchors.findIndex(t=>{return t.name===e});switch(s<0&&(s=t.anchors.push({name:e})-1),anchormanifest=t.anchors[s]=Object.assign({name:e},t.anchors[s]),anchormanifest.position=Object.assign({x:0,y:0,z:0},anchormanifest.position),anchormanifest.rotation=Object.assign({x:0,y:0,z:0},anchormanifest.rotation),anchormanifest.scale=anchormanifest.hasOwnProperty("scale")&&"number"==typeof anchormanifest.scale?{x:anchormanifest.scale||1,y:anchormanifest.scale||1,z:anchormanifest.scale||1}:Object.assign({x:1,y:1,z:1},anchormanifest.scale),n){case"position":case"rotation":{let e=i[1].split(",");e.length>=1&&(anchormanifest[n].x=parseFloat(e[0])||0),e.length>=2&&(anchormanifest[n].y=parseFloat(e[1])||0),e.length>=3&&(anchormanifest[n].z=parseFloat(e[2])||0);break}case"scale":{let e=i[1].split(",");1===e.length?anchormanifest[n].x=anchormanifest[n].y=anchormanifest[n].z=parseFloat(e[0])||1:(e.length>=1&&(anchormanifest[n].x=parseFloat(e[0])||1),e.length>=2&&(anchormanifest[n].y=parseFloat(e[1])||1),e.length>=3&&(anchormanifest[n].z=parseFloat(e[2])||1));break}}}};return e.has("altvr.manifest")&&e.get("altvr.manifest").length>0?new Promise((i,n)=>{fetch(altspaceutil.getAbsoluteURL(e.get("altvr.manifest"))).then(e=>e.json()).then(e=>{altspaceutil._fullspaceAppManifest=e,t(altspaceutil._fullspaceAppManifest),i(altspaceutil._fullspaceAppManifest)}).catch(()=>n("Failed to download manifest from "+e.get("altvr.manifest")))}):(altspaceutil._fullspaceAppManifest={enclosure:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},anchors:[]},t(altspaceutil._fullspaceAppManifest),Promise.resolve(altspaceutil._fullspaceAppManifest))},altspaceutil.FullspaceApp=class{constructor(e){this.config=Object.assign({serializationBufferSize:5e5},e),this.config.serializationBufferSize&&altspaceutil.expandSerializationBuffer(this.config.serializationBufferSize)}initialize(){let e=()=>{return this._isInitializing||this._isInitialized?new Promise((e,t)=>{let i=setInterval(()=>{this._isInitializing||(clearInterval(i),e())},10)}):(this._isInitializing=!0,Promise.resolve())},t=altspace.inClient?altspace.getSpace():Promise.resolve({sid:"browser",name:"Web Space",templateSid:"browser"});return new Promise((i,n)=>{e().then(()=>{return this._isInitialized?i(this):(this._isInitializing=!0,Promise.all([altspaceutil.getFullspaceEnclosure(),altspaceutil.getFullspaceAppManifest(),t]).then(e=>{let[t,n,s]=e;if(this._enclosure=t,this._manifest=n,this._space=s,this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera,altspace.inClient)this._renderer=altspace.getThreeJSRenderer();else{this._renderer=new THREE.WebGLRenderer({antialias:!0}),Object.assign(this._camera,{fov:90,near:1,far:2e3}),this._camera.position.z=20;let e=()=>{this._renderer.setClearColor("#99AACC"),document.body.style.margin="0px",document.body.style.overflow="hidden",document.body.appendChild(this._renderer.domElement),this._renderer.domElement.oncontextmenu=(()=>!1)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e();let t=()=>{this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",t),t(),this._scene.add(this._camera),this._scene.add(new THREE.AmbientLight("white")),altspace.utilities.shims.cursor.init(this._scene,this._camera,{renderer:this._renderer})}this._anchors={},this._anchor=Object.assign(new THREE.Group,{name:"altvr.enclosure"}),this._scene.add(this._anchor);let a=this._manifest?this._manifest.enclosure:null;a&&(this._anchor.position.copy(a.position),this._anchor.rotation.set(THREE.Math.degToRad(a.rotation.x),THREE.Math.degToRad(a.rotation.y),THREE.Math.degToRad(a.rotation.z)),this._anchor.scale.copy(a.scale)),this._anchorsGroup=Object.assign(new THREE.Group,{name:"altvr.anchors"}),this._anchorsGroup.addBehavior(new class e{get type(){return"_ApplyAppAnchorTransform"}constructor(e){this.anchor=e}awake(e){this.object3d=e,this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}update(){this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}}(this._anchor)),this._scene.add(this._anchorsGroup),this._isInitialized=!0;let o=()=>{window.requestAnimationFrame(o),this._scene.updateAllBehaviors(),this._renderer.render(this._scene,this._camera)};o(),this._isInitializing=!1,i(this)}))}).catch(()=>{this._isInitializing=!1,n("Failed to initialize fullspace app.")})})}anchors(e){if(this._anchors[e])return this._anchors[e];let t=this._anchors[e]=Object.assign(new THREE.Group,{name:e});this._anchorsGroup.add(t);let i=this._manifest.anchors.find(t=>{return t.name===e});return i&&(t.position.copy(i.position),t.rotation.set(THREE.Math.degToRad(i.rotation.x),THREE.Math.degToRad(i.rotation.y),THREE.Math.degToRad(i.rotation.z)),t.scale.copy(i.scale)),t}get scene(){return this._scene}get renderer(){return this._renderer}get camera(){return this._camera}get anchor(){return this._anchor}get enclosure(){return this._enclosure}get space(){return this._space}},altspaceutil.getFullspaceApp=function(e){return altspaceutil._fullspaceApp||(altspaceutil._fullspaceApp=new altspaceutil.FullspaceApp(e)),altspaceutil._fullspaceApp.initialize()},altspaceutil.getAbsoluteURL=function(e){return new URL(e,window.location).toString()},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.loadTexture=function(e,t){if(altspace.inClient){if(e.startsWith("blob:")){let t=new THREE.Texture;return fetch(e).then(e=>e.blob()).then(i=>{let n=new FileReader;n.onerror=(()=>console.warn("Failed to load blob texture at "+e)),n.onload=(()=>Object.assign(t,{image:{nodeName:"CANVAS",toDataURL:()=>n.result},needsUpdate:!0})),n.readAsDataURL(i)}),t}return e.startsWith("data:")?Object.assign(new THREE.Texture({nodeName:"CANVAS",toDataURL:()=>e}),{needsUpdate:!0}):new THREE.Texture({src:altspaceutil.getAbsoluteURL(e)})}t=Object.assign({crossOrigin:"anonymous"},t);var i=new THREE.TextureLoader;return"anonymous"!==t.crossOrigin&&i.setCrossOrigin(t.crossOrigin),void 0!==t.withCredentials&&i.setWithCredentials(t.withCredentials),void 0!==t.path&&i.setPath(t.path),i.load(e)},altspaceutil.setCursorCollider=function(e,t,i){e&&(i?e.traverse(e=>{e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t}):(e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t))},altspaceutil.isCursorCollider=function(e){return!!e&&(!e.userData.altspace||!e.userData.altspace.collider||void 0===e.userData.altspace.enabled||e.userData.altspace.enabled)},altspaceutil.manageBehavior=function(e,t){e.__isManaged=!0,t.__resetManagedBehavior||t.addEventListener("removed",t.__resetManagedBehavior=function(){t.__resetManagedBehavior&&(t.removeEventListener("removed",t.__resetManagedBehavior),t.__resetManagedBehavior=null),t.traverse(function(e){if(e.__behaviorList)for(var t of e.__behaviorList)if(t.__isInitialized&&t.__isManaged)try{t.dispose&&t.dispose.call(t,e),t.__isInitialized=!1}catch(i){console.group(),(console.error||console.log).call(console,i.stack||i),console.log("[Behavior]"),console.log(t),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,t){e.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(e,t){var i=e.clone(!1);if(e.__behaviorList&&e.__behaviorList.length>0)for(var n of e.__behaviorList)try{if(n.clone){var s=n.clone.call(n,i,e);s&&(i.__behaviorList=i.__behaviorList||[],i.__behaviorList.push(s))}}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(n),console.log("[Object3D]"),console.log(e),console.groupEnd()}if(void 0===t||t)for(var a of e.children)i.add(a.cloneWithBehaviors(!0));return i},altspaceutil.loadScript=((e,t)=>{if(t=Object.assign({loadOnce:!0},t),altspaceutil._loadedScripts=altspaceutil._loadedScripts||{},t.scriptTest&&t.scriptTest(e))return Promise.resolve();if(t.loadOnce){if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].loaded)return Promise.resolve();if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].waiting)return altspaceutil._loadedScripts[e].waiting}let i=document.createElement("script");i.src=new URL(e,window.location).toString(),i.async=!1;let n=void 0===altspaceutil._loadedScripts[e],s=new Promise((s,a)=>{i.onload=(()=>{!t.scriptTest||t.scriptTest(e)?s():(console.warn("Script test failed for script at "+i.src),a("Script test failed for script at "+i.src)),n&&(altspaceutil._loadedScripts[e].loaded=!0,altspaceutil._loadedScripts[e].waiting=null)}),i.onerror=(()=>{n&&(altspaceutil._loadedScripts[e].waiting=null,delete altspaceutil._loadedScripts[e]),console.warn("Failed to load script at "+i.src),a("Failed to load script at "+i.src)})});if(n&&(altspaceutil._loadedScripts[e]={waiting:s}),altspaceutil._lastLoadScript)altspaceutil._lastLoadScript.parentNode.insertBefore(i,altspaceutil._lastLoadScript.nextSibling);else{let e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(i,e)}return altspaceutil._lastLoadScript=i,s}),altspaceutil.loadScripts=(e=>{return!e||e.length<=0?Promise.resolve():Promise.all(e.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadScript(e):altspaceutil.loadScript(e.url,e)))}),altspaceutil.overrideTextureLoader=(e=>{altspace.inClient&&(altspaceutil._isTextureLoaderOverridden=e)}),altspace.inClient&&(altspaceutil._originalTextureLoaderFunc||(altspaceutil._originalTextureLoaderFunc=THREE.TextureLoader.prototype.load),altspaceutil._isTextureLoaderOverridden=!0,THREE.TextureLoader.prototype.load=function(e,t){if(!altspaceutil._isTextureLoaderOverridden)return altspaceutil._originalTextureLoaderFunc.apply(this,arguments);let i=altspaceutil.loadTexture(e);return t&&t(i),i}),altspaceutil._assetLoaders||(altspaceutil._assetLoaders=new class{constructor(){this.handlers=[],this.add(/\.obj$/i,(e,t)=>{return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/combine/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/MTLLoader.min.js,npm/three@0."+THREE.REVISION+".0/examples/js/loaders/OBJLoader.min.js",{scriptTest:()=>THREE.MTLLoader&&THREE.OBJLoader}).then(()=>{let s=new THREE.FileLoader;s.load(e,s=>{let a=/^[\s]*mtllib[\s]+(.*\.mtl)[\s]*$/m.exec(s);if(a){a=new URL(a[1],e).toString();let o=new THREE.MTLLoader;o.setCrossOrigin(t.crossOrigin),o.setTexturePath(altspaceutil.getBasePath(a)),o.load(a,e=>{e.preload(),i((new THREE.OBJLoader).setMaterials(e).parse(s))},null,()=>n("Could not retrieve materials from "+a))}else i((new THREE.OBJLoader).parse(s))},null,()=>n("Could not retrieve asset from "+e))}).catch(()=>n("Could not load scripts for MTLLoader/OBJLoader"))})}),this.add(/\.gltf|\.glb$/i,(e,t)=>{if(altspace.inClient&&(void 0===t.native||t.native)){let i=new THREE.Object3D;return i.addBehavior(new altspaceutil.behaviors.NativeComponent("n-gltf",{url:e},{useCollider:t.cursorCollider})),Promise.resolve(i)}return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/GLTFLoader.min.js",{scriptTest:()=>THREE.GLTFLoader}).then(()=>{let s=new THREE.GLTFLoader;s.setCrossOrigin(t.crossOrigin),s.load(e,e=>i(e.scene),null,()=>n("Could not retrieve asset from "+e))}).catch(()=>n("Could not load scripts for GLTFLoader"))})}),this.add(/\.dae$/i,(e,t)=>{return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/ColladaLoader.min.js",{scriptTest:()=>THREE.ColladaLoader}).then(()=>{if(altspace.inClient){let s=new THREE.FileLoader;s.load(e,n=>{let s=THREE.TextureLoader.prototype.load;THREE.TextureLoader.prototype.load=((t,...i)=>s.call(this,new URL(t,e).toString(),...i));let a=new THREE.ColladaLoader;a.setCrossOrigin(t.crossOrigin);let o=a.parse(n,altspaceutil.getBasePath(e));THREE.TextureLoader.prototype.load=s,i(o.scene)},null,()=>n("Could not retrieve asset from "+e))}else{let s=new THREE.ColladaLoader;s.setCrossOrigin(t.crossOrigin),s.load(e,e=>i(e.scene),null,()=>n("Could not retrieve asset from "+e))}}).catch(()=>n("Could not load scripts for ColladaLoader"))})}),this.add(/\.fbx$/i,(e,t)=>{return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/combine/npm/three@0."+THREE.REVISION+".0/examples/js/libs/inflate.min.js,npm/three@0."+THREE.REVISION+".0/examples/js/loaders/FBXLoader.min.js",{scriptTest:()=>THREE.FBXLoader}).then(()=>{let s=new THREE.FBXLoader;s.setCrossOrigin(t.crossOrigin),s.load(e,e=>i(e),null,()=>n("Could not retrieve asset from "+e))}).catch(()=>n("Could not load scripts for FBXLoader"))})}),this.add(/\.stl$/i,(e,t)=>{return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/STLLoader.min.js",{scriptTest:()=>THREE.STLLoader}).then(()=>{let s=new THREE.STLLoader;s.setCrossOrigin&&s.setCrossOrigin(t.crossOrigin),s.load(e,e=>i(new THREE.Mesh(e,e.hasColors?new THREE.MeshBasicMaterial({opacity:e.alpha,transparent:e.alpha<1,vertexColors:THREE.VertexColors}):void 0)),null,()=>n("Could not retrieve asset from "+e))}).catch(()=>n("Could not load scripts for STLLoader"))})}),this.add(/\.assimp$/i,(e,t)=>{return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/AssimpLoader.min.js",{scriptTest:()=>THREE.AssimpLoader}).then(()=>{if(altspace.inClient){let s=new THREE.FileLoader;s.setResponseType("arraybuffer"),s.load(e,n=>{let s=THREE.TextureLoader.prototype.load;THREE.TextureLoader.prototype.load=((t,...i)=>s.call(this,new URL(t,e).toString(),...i));let a=new THREE.AssimpLoader;a.setCrossOrigin(t.crossOrigin);let o=a.parse(n,altspaceutil.getBasePath(e));THREE.TextureLoader.prototype.load=s,i(o.object)},null,()=>n("Could not retrieve asset from "+e))}else{let s=new THREE.AssimpLoader;s.setCrossOrigin(t.crossOrigin),s.load(e,e=>i(e.object),null,()=>n("Could not retrieve asset from "+e))}}).catch(()=>n("Could not load scripts for AssimpLoader"))})}),this.add(/\.bom$/i,(e,t)=>{return new Promise((i,n)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/gh/NGenesis/bom-three.js@v0.6.3/examples/js/loaders/BOMLoader.min.js",{scriptTest:()=>THREE.BOMLoader}).then(()=>{let s=new THREE.BOMLoader;s.setCrossOrigin(t.crossOrigin),s.load(e,e=>i(e),null,()=>n("Could not retrieve asset from "+e))}).catch(()=>n("Could not load scripts for BOMLoader"))})})}add(e,t){this.handlers.push({regex:e,handler:t})}remove(e,t){this.handlers=this.handlers.filter(i=>i.regex.toString()!==e.toString()&&(!t||i.handler!==t))}get(e){let t=new URL(e).pathname;for(let i of this.handlers)if(i.regex.test(t))return i.handler;return null}}),altspaceutil.addAssetLoader=((e,t)=>{altspaceutil._assetLoaders.add(e,t)}),altspaceutil.removeAssetLoader=((e,t)=>{altspaceutil._assetLoaders.remove(e,t)}),altspaceutil.loadAsset=((e,t)=>{e=altspaceutil.getAbsoluteURL(e),t=Object.assign({applyTransform:!0,cursorCollider:!1,crossOrigin:"anonymous"},t);let i=e=>{return altspaceutil.setCursorCollider(e,!!t.cursorCollider,!0),t.applyTransform&&(t.position&&(t.position=Object.assign({x:0,y:0,z:0},t.position),e.position.copy(t.position)),t.quaternion?(t.quaternion=Object.assign({x:0,y:0,z:0,w:1},t.quaternion),e.quaternion.copy(t.quaternion)):t.rotation&&(t.rotation=Object.assign({x:0,y:0,z:0},t.rotation),e.rotation.set(t.rotation.x,t.rotation.y,t.rotation.z)),t.scale&&(t.scale=t.hasOwnProperty("scale")&&"number"==typeof t.scale?{x:t.scale||1,y:t.scale||1,z:t.scale||1}:Object.assign({x:1,y:1,z:1},t.scale),e.scale.copy(t.scale))),new Promise((i,n)=>{let s=t.onLoaded?t.onLoaded(e):null;s instanceof Promise?s.then(()=>i(e)).catch(e=>n("Error occurred while processing onLoaded asset handler",e)):i(e)})},n=altspaceutil._assetLoaders.get(e,t);return n?n(e,t).then(i):Promise.reject("Could not get asset handler for "+e)}),altspaceutil.loadAssets=(e=>{return e?new Promise((t,i)=>{let n=Array.isArray(e)?e:Object.values(e);Promise.all(n.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadAsset(e):altspaceutil.loadAsset(e.url,e))).then(i=>{if(Array.isArray(e))t(i);else{let n={};Object.keys(e).forEach((e,t)=>{n[e]=i[t]}),t(n)}}).catch(e=>i("Could not load assets",e))}):Promise.resolve(e)}),window.altspaceutil=window.altspaceutil||{},altspaceutil.shims=altspaceutil.shims||{},altspaceutil.shims.sdk=altspaceutil.shims.sdk||{},void 0===altspaceutil.shims.sdk.inClient&&(altspaceutil.shims.sdk.inClient=!!altspace.inClient),altspaceutil.shims._currentThreeJSScene=null,altspaceutil.shims.sdk.getThreeJSScene=function(){return altspace.inClient&&altspace._internal&&altspace._internal.getThreeJSScene&&(altspaceutil.shims.sdk._currentThreeJSScene=altspace._internal.getThreeJSScene()),altspaceutil.shims.sdk._currentThreeJSScene},altspaceutil.shims.sdk.setThreeJSScene=function(e){altspace.inClient&&altspace._internal&&altspace._internal.setThreeJSScene&&altspace._internal.setThreeJSScene(e),altspaceutil.shims._currentThreeJSScene=e},altspaceutil.shims.sdk.getEnclosure=function(){return altspaceutil.shims.sdk._EnclosureBrowserShim||(altspaceutil.shims.sdk._EnclosureBrowserShim=new class e extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!1,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil.shims.sdk._EnclosureBrowserShim)},altspaceutil.shims.sdk.getDocument=function(){return new Promise((e,t)=>{altspace.getEnclosure().then(t=>{return altspaceutil.shims.sdk._DocumentBrowserShim||(altspaceutil.shims.sdk._DocumentBrowserShim=new class e extends THREE.Mesh{constructor(){super(new THREE.PlaneBufferGeometry(-t.innerWidth/1e3,t.innerHeight/1e3,1,1),Object.assign(new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:new THREE.Texture}),{uuid:"altspace-document",visible:!1})),this.type="Document",this.originalGeometry=this.geometry,this.originalMaterial=this.material,this.inputEnabled=!1,this.audioSpatializationEnabled=!0,this.reset()}get inputEnabled(){return this._inputEnabled}set inputEnabled(e){this._inputEnabled=e}get audioSpatializationEnabled(){return this._audioSpatializationEnabled}set audioSpatializationEnabled(e){this._audioSpatializationEnabled=e}reset(){this.geometry=this.originalGeometry,this.geometry.verticesNeedUpdate=!0,this.geometry.uvsNeedUpdate=!0,this.material=this.originalMaterial,this.material.map.repeat.set(1,1),this.material.map.offset.set(0,0),this.material.side=THREE.DoubleSide;let e=altspaceutil.shims.sdk.getThreeJSScene()||this.parent;e&&(e.add(this),this.matrix.identity(),this.matrix.getInverse(e.matrix),this.applyMatrix(this.matrix))}}),e(altspaceutil.shims.sdk._DocumentBrowserShim)}).catch(e=>t(e))})},altspaceutil.shims.sdk.getSpace=function(){return altspaceutil.shims.sdk._SpaceBrowserShim||(altspaceutil.shims.sdk._SpaceBrowserShim=new class e{constructor(){this.sid="browser",this.name="Web Space",this.templateSid="browser"}}),Promise.resolve(altspaceutil.shims.sdk._SpaceBrowserShim)},altspaceutil.shims.sdk.getUser=function(){return altspaceutil.shims.sdk._UserBrowserShim||(altspaceutil.shims.sdk._UserBrowserShim=new class e{constructor(){this.userId="BrowserGuest",this.displayName="Guest",this.isModerator=!0,this.avatarInfo={sid:"s-series-m01",primaryColor:"rgb(0,0,0)",highlightColor:"rgb(255,255,255)"}}}),Promise.resolve(altspaceutil.shims.sdk._UserBrowserShim)},altspaceutil.shims.sdk.getThreeJSDebugInfo=function(){return Promise.resolve([])},altspaceutil.shims.sdk.getThreeJSTrackingSkeleton=function(){if(!altspaceutil.shims.sdk._ThreeJSTrackingSkeletonBrowserShim){class e extends THREE.Object3D{constructor(e,t,i,n){super(),this.type="TrackingJoint",this.confidence=n,this.name=this.location=e,this.position.copy(t),this.quaternion.copy(i)}getJoint(e,t,i){t=t||"Center",i=void 0===i?0:i,this.trackingJoints[t+e+i]}}altspaceutil.shims.sdk._ThreeJSTrackingSkeletonBrowserShim=new class t extends THREE.Object3D{constructor(){super(),this.type="TrackingSkeleton",Object.values(this.trackingJoints={LeftEye0:new e("LeftEye0",{x:-1.97182,y:1.80098,z:5.81021},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3),RightEye0:new e("RightEye0",{x:-1.96686,y:1.80098,z:5.74999},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3),CenterHead0:new e("CenterHead0",{x:-1.89206,y:1.78727,z:5.78686},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3),CenterNeck0:new e("CenterNeck0",{x:-1.81299,y:1.69395,z:5.79299},{x:-1.8530686175238797e-17,y:-.8420416245242373,z:-1.8530686175238797e-17,w:.539412553217464},3),CenterSpine0:new e("CenterSpine0",{x:-1.81298,y:1.27273,z:5.79299},{x:10001753394771951e-21,y:-.8420524879699061,z:10001753394771948e-21,w:.539395594442169},0),CenterSpine1:new e("CenterSpine1",{x:-1.81299,y:1.3994,z:5.79299},{x:10001753394771951e-21,y:-.8420524879699061,z:10001753394771948e-21,w:.539395594442169},0),CenterSpine2:new e("CenterSpine2",{x:-1.81299,y:1.52607,z:5.79299},{x:10001753394771951e-21,y:-.8420524879699061,z:10001753394771948e-21,w:.539395594442169},0),CenterHips0:new e("CenterHips0",{x:-1.81298,y:1.20273,z:5.79299},{x:-1.8533002074052303e-17,y:-.8420563923075377,z:-1.8533002074052303e-17,w:.5393894995029234},0),CenterEye0:new e("CenterEye0",{x:-1.96934,y:1.80098,z:5.7801},{x:.04939496774553409,y:-.7336266303864485,z:.05363520622544854,w:.6756296093292512},3)}).forEach(e=>this.add(e))}getJoint(e,t,i){t=t||"Center",i=void 0===i?0:i,this.trackingJoints[t+e+i]}}}return Promise.resolve(altspaceutil.shims.sdk._ThreeJSTrackingSkeletonBrowserShim)},altspaceutil.shims.sdk.getGamepads=function(){return navigator.getGamepads()},altspaceutil.shims.sdk.getThreeJSRenderer=function(e){return altspaceutil.shims.sdk._ThreeJSRendererBrowserShim||(e=Object.assign({antialias:!0,version:"0.2.0"},e),altspaceutil.shims.sdk._ThreeJSRendererBrowserShim=new class e extends THREE.WebGLRenderer{constructor(e){console.log("THREE.AltRenderer",THREE.REVISION),console.log("AltRenderer version "+e.version),super(e)}render(e,t,i,n){altspaceutil.shims.sdk.setThreeJSScene(e),super.render(e,t,i,n)}}(e)),altspaceutil.shims.sdk._ThreeJSRendererBrowserShim},altspaceutil.shims.sdk.open=function(e,t,i){t=t||"_blank",i=Object.assign({hidden:!1},i);let n=new class n{constructor(){this.window=null,this.url=e,this.closed=!1,i.hidden&&"_blank"===t||(this.window=window.open(this.url,"_blank"))}show(){return this.closed||this.window||(this.window=window.open(this.url,"_blank")),Promise.resolve()}close(){return!this.closed&&this.window&&(this.closed=!0,this.window.close(),this.window=null),Promise.resolve()}};return Promise.resolve(n)},altspaceutil.initializeAltspaceShims=function(e){return altspace.inClient&&!e||(altspace.inClient=altspaceutil.shims.sdk.inClient,altspace.getDocument=altspaceutil.shims.sdk.getDocument,altspace.getEnclosure=altspaceutil.shims.sdk.getEnclosure,altspace.getSpace=altspaceutil.shims.sdk.getSpace,altspace.getUser=altspaceutil.shims.sdk.getUser,altspace.getThreeJSDebugInfo=altspaceutil.shims.sdk.getThreeJSDebugInfo,altspace.getThreeJSTrackingSkeleton=altspaceutil.shims.sdk.getThreeJSTrackingSkeleton,altspace.getGamepads=altspaceutil.shims.sdk.getGamepads,altspace.getThreeJSRenderer=altspaceutil.shims.sdk.getThreeJSRenderer,altspace.open=altspaceutil.shims.sdk.open),Promise.resolve()},altspaceutil.initializeAltspaceShims(),altspaceutil._FontGlobals={fontUrl:"https://cdn.jsdelivr.net/npm/altspacevr-behaviors@"+altspaceutil.VERSION+"/fonts/Varela_Round/Varela_Round.json",textureUrl:"https://cdn.jsdelivr.net/npm/altspacevr-behaviors@"+altspaceutil.VERSION+"/fonts/Varela_Round/Varela_Round.png",width:510,height:250,scale:.001945,letterSpacing:1.9,lineHeight:62,tabSize:9,anisotropy:16,alphaTest:1e-4,italicOffset:8,fontStrength:1,boldStrength:.75,uniforms:{map:{type:"t",value:null}},font:null,createShaderUniforms:()=>{return THREE.UniformsUtils.clone(altspaceutil._FontGlobals.uniforms)},createVertexShader:()=>{return`varying vec2 vUv;
\t\tvarying vec4 vColor;
\t\tattribute vec4 color;
\t\tvarying float vBold;
\t\tattribute float bold;
\t\tvoid main() {
\t\t\tvUv = uv;
\t\t\tvColor = color;
\t\t\tvBold = bold;
\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
\t\t}`},createFragmentShader:()=>{return`varying vec2 vUv;
\t\tvarying vec4 vColor;
\t\tvarying float vBold;
\t\tuniform sampler2D map;
\t\t#ifdef GL_OES_standard_derivatives
\t\t\t#extension GL_OES_standard_derivatives : enable
\t\t#endif
\t\tprecision highp float;
\t\tvoid main() {
\t\t\tfloat distance = texture2D(map, vUv).a;
\t\t\t#ifdef GL_OES_standard_derivatives
\t\t\t\tfloat afwidth = length(vec2(dFdx(distance), dFdy(distance))) * 0.70710678118654757;
\t\t\t#else
\t\t\t\tfloat afwidth = (1.0 / 32.0) * (1.4142135623730951 / (2.0 * gl_FragCoord.w));
\t\t\t#endif
\t\t\tfloat alpha = smoothstep(0.5 * vBold - afwidth, 0.5 * vBold + afwidth, distance) * vColor.w;
\t\t\tgl_FragColor = vec4(vColor.xyz, alpha);`+(altspaceutil._FontGlobals.alphaTest?"if(gl_FragColor.a < "+altspaceutil._FontGlobals.alphaTest+") discard;":"")+"}"},loadMaterial:()=>{let e=(new THREE.TextureLoader).load(altspaceutil._FontGlobals.textureUrl,()=>{e.needsUpdate=!0,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,e.anisotropy=altspaceutil._FontGlobals.anisotropy}),t=new THREE.ShaderMaterial({uniforms:altspaceutil._FontGlobals.createShaderUniforms(),fragmentShader:altspaceutil._FontGlobals.createFragmentShader(),vertexShader:altspaceutil._FontGlobals.createVertexShader(),side:THREE.DoubleSide,transparent:!0});return t.uniforms.map.value=e,t},loadFont:()=>{return altspaceutil._FontGlobals.font?Promise.resolve(altspaceutil._FontGlobals.font):new Promise((e,t)=>{fetch(altspaceutil._FontGlobals.fontUrl).then(e=>e.json()).then(t=>{altspaceutil._FontGlobals.font=t,e(t)})})}},altspaceutil.behaviors.Text=class{get type(){return"Text"}constructor(e){this.config=Object.assign({text:"",fontSize:10,width:10,height:1,horizontalAlign:"middle",verticalAlign:"middle",native:!0},e)}awake(e){this.object3d=e,this.loading=!0,altspaceutil.manageBehavior(this,this.object3d),this.config.native&&altspace.inClient?(this.nativeComponent=new altspaceutil.behaviors.NativeComponent("n-text",{text:this.config.text,fontSize:this.config.fontSize,width:this.config.width,height:this.config.height,horizontalAlign:this.config.horizontalAlign,verticalAlign:this.config.verticalAlign}),this.object3d.addBehavior(this.nativeComponent)):Promise.all([altspaceutil._FontGlobals.loadFont(),altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/altspacevr-behaviors@"+altspaceutil.VERSION+"/lib/three-bmfont-text/three-bmfont-text.min.js",{scriptTest:()=>window.createGeometry})]).then(()=>{this.loading&&(this.loading=!1,this._updateText(!0))})}update(){this.config.native&&altspace.inClient&&this.nativeComponent?(this.nativeComponent.data.text=this.config.text,this.nativeComponent.data.fontSize=this.config.fontSize,this.nativeComponent.data.width=this.config.width,this.nativeComponent.data.height=this.config.height,this.nativeComponent.data.horizontalAlign=this.config.horizontalAlign,this.nativeComponent.data.verticalAlign=this.config.verticalAlign):!this.mesh||this.text===this.config.text&&this.fontSize===this.config.fontSize&&this.width===this.config.width&&this.height===this.config.height&&this.horizontalAlign===this.config.horizontalAlign&&this.verticalAlign===this.config.verticalAlign||this._updateText()}dispose(){this.object3d&&this.config.native&&altspace.inClient?this.nativeComponent&&this.object3d.removeBehavior(this.nativeComponent):(this.loading&&(this.loading=!1),this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh))}clone(){return new altspaceutil.behaviors.Text(this.config)}_updateText(e){this.text=this.config.text,this.fontSize=this.config.fontSize,this.width=this.config.width,this.height=this.config.height,this.horizontalAlign=this.config.horizontalAlign,this.verticalAlign=this.config.verticalAlign,this.bmconfig=this._createFontConfig();let t=this._parseText();this.bmconfig.text=t.text,e?(this.mesh=new THREE.Mesh(createGeometry(this.bmconfig),altspaceutil._FontGlobals.loadMaterial()),this.object3d.add(this.mesh)):this.mesh.geometry.update(this.bmconfig),this.mesh.geometry.computeBoundingBox(),this._updateTextStyles(t.styles),this._updateTextLayout()}_parseText(){let e=this.config.text,t="",i="",n=!1,s=!1,a=[],o=[],r={color:{r:1,g:1,b:1,a:1},tag:"color"},l=null,c=!1,u=!1,h=!1,p=!1;a.push(JSON.parse(JSON.stringify(r)));let d=e=>{t+=e;let i={color:{r:r.color.r,g:r.color.g,b:r.color.b,a:r.color.a}};c&&(i.bold=!0),u&&(i.italic=!0),h&&(i.strikethrough=!0),p&&(i.underline=!0),l&&(i.link=l),delete i.tag;for(let n=0;n<e.length;++n)/\s/.test(e.charAt(n))||o.push(i)},f=e=>{let t=JSON.parse(JSON.stringify(r));return t.tag=e,a.push(t),t},g=e=>{let t=0;for(;a.length>1&&!(a[a.length-1].tag===e&&t++>0);)a.pop();r=JSON.parse(JSON.stringify(a[a.length-1]))},m=e=>{return/^#[0-9A-F]{8}$/i.test(e)?(r.color.r=parseInt(e.substring(1,3),16)/255,r.color.g=parseInt(e.substring(3,5),16)/255,r.color.b=parseInt(e.substring(5,7),16)/255,r.color.a=parseInt(e.substring(7,9),16)/255,!0):/^#[0-9A-F]{6}$/i.test(e)?(r.color.r=parseInt(e.substring(1,3),16)/255,r.color.g=parseInt(e.substring(3,5),16)/255,r.color.b=parseInt(e.substring(5,7),16)/255,r.color.a=1,!0):/^#[0-9A-F]{4}$/i.test(e)?(r.color.r=parseInt(e.charAt(1)+e.charAt(1),16)/255,r.color.g=parseInt(e.charAt(2)+e.charAt(2),16)/255,r.color.b=parseInt(e.charAt(3)+e.charAt(3),16)/255,r.color.a=parseInt(e.charAt(4)+e.charAt(4),16)/255,!0):!!/^#[0-9A-F]{3}$/i.test(e)&&(r.color.r=parseInt(e.charAt(1)+e.charAt(1),16)/255,r.color.g=parseInt(e.charAt(2)+e.charAt(2),16)/255,r.color.b=parseInt(e.charAt(3)+e.charAt(3),16)/255,r.color.a=1,!0)},_=e=>{switch(e.substring(1,e.length-1)){case"black":r.color.r=r.color.g=r.color.b=0;break;case"blue":r.color.r=r.color.g=0,r.color.b=1;break;case"green":r.color.r=r.color.b=0,r.color.g=1;break;case"orange":r.color.r=1,r.color.g=.6039215686,r.color.b=0;break;case"purple":r.color.r=r.color.b=1,r.color.g=0;break;case"red":r.color.r=1,r.color.g=r.color.b=0;break;case"yellow":r.color.r=r.color.g=1,r.color.g=1;break;case"white":default:r.color.r=r.color.g=r.color.b=1}return!0},E=e=>{return!!/^#[0-9A-F]{2}$/i.test(e)&&(r.color.a=parseInt(e.substring(1,3),16)/255,!0)};for(let b=0;b<e.length;){let t=e.charAt(b);if(++b,s)if("<"===t)d(i),i=t;else if(">"===t){s=!1,i+=t;let e="/"===i.charAt(1),[a,o]=i.substring(e?2:1,i.length-1).split("=");a.length>0?"noparse"===a?n=!e:n?d(i):"b"===a?c=!e:"i"===a?u=!e:"s"===a?h=!e:"u"===a?p=!e:"#"!==a.charAt(0)||o||e?"color"===a?e?g("color"):o&&(o.length>1&&"#"===o.charAt(0)&&m(o)||o.length>2&&'"'===o.charAt(0)&&'"'===o.charAt(o.length-1)&&_(o))?f("color"):d(i):"alpha"!==a||e?"link"===a||"link"===a.substring(0,a.indexOf(" ")).trimEnd()?e?l=null:o&&o.length>2&&'"'===o.charAt(0)&&'"'===o.charAt(o.length-1)?l=o.substring(1,o.length-1):d(i):d(i):o&&o.length>1&&"#"===o.charAt(0)&&E(o)?f("alpha"):d(i):m(a)?f("color"):d(i):d(i)}else i+=t;else"<"===t?(s=!0,i=t):d(t)}return{text:t,styles:o}}_updateTextStyles(e){let t=new Float32Array(4*this.mesh.geometry.attributes.position.count);for(let i=0;i<t.length;){let n=e[Math.floor(i/16)].color;for(let s=0;s<4;++s)t[i++]=n.r,t[i++]=n.g,t[i++]=n.b,t[i++]=n.a}this.mesh.geometry.addAttribute("color",new THREE.BufferAttribute(t,4));let n=new Float32Array(this.mesh.geometry.attributes.position.count);for(let i=0;i<n.length;){let t=e[Math.floor(i/4)].bold?altspaceutil._FontGlobals.boldStrength:altspaceutil._FontGlobals.fontStrength;for(let s=0;s<4;++s)n[i++]=t}this.mesh.geometry.addAttribute("bold",new THREE.BufferAttribute(n,1));let s=this.mesh.geometry.attributes.position.array;for(let i=0;i<s.length;i+=8)e[Math.floor(i/8)].italic&&(s[i]+=altspaceutil._FontGlobals.italicOffset,s[i+2]-=altspaceutil._FontGlobals.italicOffset,s[i+4]-=altspaceutil._FontGlobals.italicOffset,s[i+6]+=altspaceutil._FontGlobals.italicOffset);this.mesh.geometry.attributes.position.needsUpdate=!0}_updateTextLayout(){switch(this.mesh.position.x=-this.mesh.geometry.layout.width/2,this.mesh.position.z=0,this.config.verticalAlign){case"top":this.mesh.position.y=this.mesh.geometry.boundingBox.min.y+this.bmconfig.height;break;case"bottom":this.mesh.position.y=this.mesh.geometry.boundingBox.max.y-this.bmconfig.height;break;case"middle":default:this.mesh.position.y=(this.mesh.geometry.boundingBox.max.y+this.mesh.geometry.boundingBox.min.y)/2}this.mesh.position.multiplyScalar(this.bmconfig.scale),this.mesh.rotation.x=Math.PI,this.mesh.scale.setScalar(this.bmconfig.scale)}_createFontConfig(){return{text:this.config.text,width:altspaceutil._FontGlobals.width*this.config.width*(1/this.config.fontSize),height:altspaceutil._FontGlobals.height*this.config.height*(1/this.config.fontSize),align:"middle"!==this.config.horizontalAlign?this.config.horizontalAlign:"center",font:altspaceutil._FontGlobals.font,lineHeight:altspaceutil._FontGlobals.lineHeight,letterSpacing:altspaceutil._FontGlobals.letterSpacing,tabSize:altspaceutil._FontGlobals.tabSize,scale:altspaceutil._FontGlobals.scale*this.config.fontSize,trimWhitespace:!1}}};