"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(e,a){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,a):null},altspaceutil.removeNativeEventListener=function(e,a){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,a)},altspaceutil.removeAllNativeEventListeners=function(e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(e):null},altspaceutil.getThreeJSScene=function(e){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.getAbsoluteURL=function(e){if(e&&!e.startsWith("http"))if(e.startsWith("/"))e=location.origin+e;else{var a=location.pathname;a.endsWith("/")||(a=location.pathname.split("/").slice(0,-1).join("/")+"/"),e=location.origin+a+e}return e},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.manageBehavior=function(e,a){e.__isManaged=!0,a.__resetManagedBehavior||a.addEventListener("removed",a.__resetManagedBehavior=function(){a.__resetManagedBehavior&&(a.removeEventListener("removed",a.__resetManagedBehavior),a.__resetManagedBehavior=null),a.traverse(function(e){if(e.__behaviorList)for(var a of e.__behaviorList)if(a.__isInitialized&&a.__isManaged)try{a.dispose&&a.dispose.call(a,e),a.__isInitialized=!1}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(a),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,a){e.__isManaged=!1},window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.behaviors.UserEvents=function(e){e=e||{},this.type="UserEvents",this.onRequestData=e.onRequestData||null,this.refreshTime=e.refreshTime||5e3,this.trace=e.trace||!1,this.userIds=e.userIds||[],this.awake=function(e){if(this.object3d=e,this.time=0,this.loading=!1,this.users={},this.userIds=this.userIds.constructor===Array?this.userIds:[this.userIds],altspaceutil.manageBehavior(this,this.object3d),this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var a=this;altspace.getUser().then(function(e){a.userIds.push(e.userId),a.requestUserData()})}else this.requestUserData()},this.update=function(e){!this.loading&&this.userIds.length>0&&(this.time-=e,this.time<=0&&this.requestUserData())},this.onLoaded=function(e){if(this.loading){var a=JSON.parse(e),t=this;for(var s of a.users)if(s&&s.user_id){var i=s.user_id,r=this.users[i]||{userId:i};this.users[i]=r;var n=r.username;r.username=s.username||null;var l=r.displayName;r.displayName=s.display_name||null;var o=r.online;r.online=s.online||!1;var u=s.user_avatar.config.avatar,h=r.avatarId;r.avatarId=u.avatar_sid||null;var c,d=r.avatarColors,v=r.avatarTextures,g=r.avatarId!==h;switch(r.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":c="Rubenoid";var p="rubenoid-male-01"===r.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";r.avatarTextures={hair:u[p+"1"][0],skin:u[p+"2"][0],clothing:u[p+"3"][0]},r.avatarColors={},g||(g=v.hair!==r.avatarTextures.hair||v.skin!==r.avatarTextures.skin||v.clothing!==r.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":c="Robothead",r.avatarColors={highlight:this.getAvatarColor(u["robothead-highlight-color"])},r.avatarTextures={},g||(g=!d.highlight||!d.highlight.equals(r.avatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":c="Pod",r.avatarColors={primary:this.getAvatarColor(u["primary-color"]),highlight:this.getAvatarColor(u["highlight-color"])},r.avatarTextures={},g||(g=!(d.primary&&d.highlight&&d.primary.equals(r.avatarColors.primary)&&d.highlight.equals(r.avatarColors.highlight)));break;default:c="",r.avatarColors={},r.avatarTextures={},this.trace&&console.log("Unknown avatar type: "+r.avatarId)}r.username===n&&r.displayName===l||this.object3d.dispatchEvent({type:"userchange",detail:{userId:r.userId,username:r.username,displayName:r.displayName},bubbles:!0,target:t.object3d}),g&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:r.userId,avatarId:r.avatarId,avatarClass:c,colors:r.avatarColors,textures:r.avatarTextures},bubbles:!0,target:t.object3d}),r.online!==o&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:r.userId,displayName:r.displayName,online:!!r.online},bubbles:!0,target:t.object3d})}this.loading=!1}},this.onError=function(e){if(this.loading){if(this.trace){var a=e.target.responseURL||"";console.log("Error loading avatar data "+a)}this.loading=!1}},this.subscribeUser=function(e){var a=this.userIds.indexOf(e);a===-1&&this.userIds.push(e)},this.unsubscribeUser=function(e){var a=this.userIds.indexOf(e);a>=0&&this.userIds.splice(a,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var e=[];for(var a of this.userIds)this.onRequestData&&!this.onRequestData(a,this.object3d)||e.push(a);e.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+e.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.refreshTime,this.loading=!0)}},this.getAvatarColor=function(e){function a(e,a,t){return new THREE.Color(e/255,a/255,t/255)}function t(e){var a={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return e=e in a?e:"white",new THREE.Color(a[e].r,a[e].g,a[e].b)}return"string"==typeof e[0]?t(e[0]):a(e[0],e[1],e[2])},this.dispose=function(){this.dataRequest=null,this.object3d=null,this.time=0,this.loading=!1,this.users={}}};