"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(e,t){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,t):null},altspaceutil.removeNativeEventListener=function(e,t){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,t)},altspaceutil.removeAllNativeEventListeners=function(e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(e):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.getAbsoluteURL=function(e){if(e&&!e.startsWith("http"))if(e.startsWith("/"))e=location.origin+e;else{var t=location.pathname;t.endsWith("/")||(t=location.pathname.split("/").slice(0,-1).join("/")+"/"),e=location.origin+t+e}return e},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.manageBehavior=function(e,t){e.__isManaged=!0,t.__resetManagedBehavior||t.addEventListener("removed",t.__resetManagedBehavior=function(){t.__resetManagedBehavior&&(t.removeEventListener("removed",t.__resetManagedBehavior),t.__resetManagedBehavior=null),t.traverse(function(e){if(e.__behaviorList)for(var t of e.__behaviorList)if(t.__isInitialized&&t.__isManaged)try{t.dispose&&t.dispose.call(t,e),t.__isInitialized=!1}catch(a){console.group(),(console.error||console.log).call(console,a.stack||a),console.log("[Behavior]"),console.log(t),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,t){e.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(e,t){var a=e.clone(!1);if(e.__behaviorList&&e.__behaviorList.length>0)for(var i of e.__behaviorList)try{if(i.clone){var s=i.clone.call(i,a,e);s&&(a.__behaviorList=a.__behaviorList||[],a.__behaviorList.push(s))}}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(i),console.log("[Object3D]"),console.log(e),console.groupEnd()}if(void 0===t||t)for(var r of e.children)a.add(r.cloneWithBehaviors(!0));return a},altspaceutil.behaviors.UserEvents=function(e){this.config=e||{},this.type="UserEvents",this.onRequestData=this.config.onRequestData||null,this.refreshTime=this.config.refreshTime||5e3,this.trace=this.config.trace||!1,this.userIds=this.config.userIds||[],this.awake=function(e){if(this.object3d=e,this.time=0,this.loading=!1,this.users={},this.userIds=this.userIds.constructor===Array?this.userIds:[this.userIds],altspaceutil.manageBehavior(this,this.object3d),this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var t=this;altspace.getUser().then(function(e){t.userIds.push(e.legacyUserId?e.legacyUserId:e.userId),t.requestUserData()})}else this.requestUserData()},this.update=function(e){!this.loading&&this.userIds.length>0&&(this.time-=e,this.time<=0&&this.requestUserData())},this.onLoaded=function(e){if(this.loading){var t=JSON.parse(e),a=this;for(var i of t.users)if(i&&i.user_id){var s=i.user_id,r=this.users[s]||{userId:s};this.users[s]=r;var n=r.username;r.username=i.username||null;var o=r.displayName;r.displayName=i.display_name||null;var l=r.online;r.online=i.online||!1;var h=i.user_avatar.config.avatar,c=r.avatarId;r.avatarId=h.avatar_sid||null;var u,d=r.rawAvatarColors,g=r.avatarTextures,v=r.avatarId!==c;switch(r.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":u="Rubenoid";var p="rubenoid-male-01"===r.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";r.avatarTextures={hair:h[p+"1"][0],skin:h[p+"2"][0],clothing:h[p+"3"][0]},r.avatarColors={},r.rawAvatarColors={},v||(v=g.hair!==r.avatarTextures.hair||g.skin!==r.avatarTextures.skin||g.clothing!==r.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":u="Robothead",r.avatarColors={highlight:this.getAvatarColor(h["robothead-highlight-color"])},r.rawAvatarColors={highlight:h["robothead-highlight-color"]},r.avatarTextures={},v||(v=!d.highlight||JSON.stringify(d.highlight)!==JSON.stringify(r.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":u="Pod",r.avatarColors={primary:this.getAvatarColor(h["primary-color"]),highlight:this.getAvatarColor(h["highlight-color"])},r.rawAvatarColors={primary:h["primary-color"],highlight:h["highlight-color"]},r.avatarTextures={},v||(v=!d.primary||!d.highlight||JSON.stringify(d.primary)!==JSON.stringify(r.rawAvatarColors.primary)||JSON.stringify(d.highlight)!==JSON.stringify(r.rawAvatarColors.highlight));break;default:u="",r.avatarColors={},r.rawAvatarColors={},r.avatarTextures={},this.trace&&console.log("Unknown avatar type: "+r.avatarId)}r.username===n&&r.displayName===o||this.object3d.dispatchEvent({type:"userchange",detail:{userId:r.userId,username:r.username,displayName:r.displayName},bubbles:!0,target:a.object3d}),v&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:r.userId,avatarId:r.avatarId,avatarClass:u,colors:r.avatarColors,rawColors:r.rawAvatarColors,textures:r.avatarTextures},bubbles:!0,target:a.object3d}),r.online!==l&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:r.userId,displayName:r.displayName,online:!!r.online},bubbles:!0,target:a.object3d})}this.loading=!1}},this.onError=function(e){if(this.loading){if(this.trace){var t=e.target.responseURL||"";console.log("Error loading avatar data "+t)}this.loading=!1}},this.subscribeUser=function(e){var t=this.userIds.indexOf(e);t===-1&&this.userIds.push(e)},this.unsubscribeUser=function(e){var t=this.userIds.indexOf(e);t>=0&&this.userIds.splice(t,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var e=[];for(var t of this.userIds)this.onRequestData&&!this.onRequestData(t,this.object3d)||e.push(t);e.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+e.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.refreshTime,this.loading=!0)}},this.getAvatarColor=function(e){function t(e,t,a){var i=Math.max(e,t,a);return i>255&&(e=Math.floor(e/i*255),t=Math.floor(t/i*255),a=Math.floor(a/i*255)),new THREE.Color(e/255,t/255,a/255)}function a(e){var t={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return e=e in t?e:"white",new THREE.Color(t[e].r,t[e].g,t[e].b)}return"string"==typeof e[0]?a(e[0]):t(e[0],e[1],e[2])},this.dispose=function(){this.dataRequest=null,this.object3d=null,this.time=0,this.loading=!1,this.users={}},this.clone=function(){return new altspaceutil.behaviors.UserEvents(this.config)}};