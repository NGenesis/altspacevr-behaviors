"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.behaviors.UserEvents=function(a){a=a||{},this.type="UserEvents",this.onRequestData=a.onRequestData||null,this.refreshTime=a.refreshTime||5e3,this.trace=a.trace||!1,this.time=0,this.loading=!1,this.users={},this.userIds=a.userIds||[],this.awake=function(a){if(this.object3d=a,this.userIds=this.userIds.constructor===Array?this.userIds:[this.userIds],this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var e=this;altspace.getUser().then(function(a){e.userIds.push(a.userId),e.requestUserData()})}else this.requestUserData()},this.update=function(a){!this.loading&&this.userIds.length>0&&(this.time-=a,this.time<=0&&this.requestUserData())},this.onLoaded=function(a){var e=JSON.parse(a),t=this;for(var s of e.users)if(s&&s.user_id){var r=s.user_id,i=this.users[r]||{userId:r};this.users[r]=i;var o=i.username;i.username=s.username||null;var h=i.displayName;i.displayName=s.display_name||null;var n=i.online;i.online=s.online||!1;var u=s.user_avatar.config.avatar,l=i.avatarId;i.avatarId=u.avatar_sid||null;var d,c=i.avatarColors,v=i.avatarTextures,g=i.avatarId!==l;switch(i.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":d="Rubenoid";var b="rubenoid-male-01"===i.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";i.avatarTextures={hair:u[b+"1"][0],skin:u[b+"2"][0],clothing:u[b+"3"][0]},i.avatarColors={},g||(g=v.hair!==i.avatarTextures.hair||v.skin!==i.avatarTextures.skin||v.clothing!==i.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":d="Robothead",i.avatarColors={highlight:this.getAvatarColor(u["robothead-highlight-color"])},i.avatarTextures={},g||(g=!c.highlight||!c.highlight.equals(i.avatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":d="Pod",i.avatarColors={primary:this.getAvatarColor(u["primary-color"]),highlight:this.getAvatarColor(u["highlight-color"])},i.avatarTextures={},g||(g=!(c.primary&&c.highlight&&c.primary.equals(i.avatarColors.primary)&&c.highlight.equals(i.avatarColors.highlight)));break;default:d="",i.avatarColors={},i.avatarTextures={},this.trace&&console.log("Unknown avatar type: "+i.avatarId)}i.username===o&&i.displayName===h||this.object3d.dispatchEvent({type:"userchange",detail:{userId:i.userId,username:i.username,displayName:i.displayName},bubbles:!0,target:t.object3d}),g&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:i.userId,avatarId:i.avatarId,avatarClass:d,colors:i.avatarColors,textures:i.avatarTextures},bubbles:!0,target:t.object3d}),i.online!==n&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:i.userId,displayName:i.displayName,online:!!i.online},bubbles:!0,target:t.object3d})}this.loading=!1},this.onError=function(a){if(this.trace){var e=a.target.responseURL||"";console.log("Error loading avatar data "+e)}this.loading=!1},this.subscribeUser=function(a){var e=this.userIds.indexOf(a);e===-1&&this.userIds.push(a)},this.unsubscribeUser=function(a){var e=this.userIds.indexOf(a);e>=0&&this.userIds.splice(e,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var a=[];for(var e of this.userIds)this.onRequestData&&!this.onRequestData(e,this.object3d)||a.push(e);a.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+a.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.refreshTime,this.loading=!0)}},this.getAvatarColor=function(a){function e(a,e,t){return new THREE.Color(a/255,e/255,t/255)}function t(a){var e={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return a=a in e?a:"white",new THREE.Color(e[a].r,e[a].g,e[a].b)}return"string"==typeof a[0]?t(a[0]):e(a[0],a[1],a[2])}};