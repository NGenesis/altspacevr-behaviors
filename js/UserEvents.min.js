"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(e,t){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(e,t):null},altspaceutil.removeNativeEventListener=function(e,t){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(e,t)},altspaceutil.removeAllNativeEventListeners=function(e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[e]&&delete altspace._internal.couiEngine.events[e]},altspaceutil.getObject3DById=function(e){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(e):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.expandSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&e>0&&altspace._internal.ScratchThriftBuffer.grow(e)},altspaceutil.profileSerializationBuffer=function(e){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===e||e)},altspaceutil.isMobileApp=function(e){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){let e=altspace.inClient?altspace.getEnclosure:()=>{return altspaceutil._BrowserEnclosure||(altspaceutil._BrowserEnclosure=new class extends THREE.EventDispatcher{constructor(){super(),this.innerWidth=1280,this.innerHeight=720,this.innerDepth=1280,this.pixelsPerMeter=1,this.hasFocus=document.hasFocus(),this.fullspace=!0,window.addEventListener("focus",()=>this.hasFocus=document.hasFocus()),window.addEventListener("blur",()=>this.hasFocus=document.hasFocus())}requestFullspace(){return this.fullspace||(this.fullspace=!0,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}exitFullspace(){return this.fullspace&&(this.fullspace=!1,this.dispatchEvent({type:"fullspacechange"})),Promise.resolve()}}),Promise.resolve(altspaceutil._BrowserEnclosure)};return new Promise((t,a)=>{e().then(e=>e.requestFullspace().then(()=>{e.addEventListener("fullspacechange",()=>{e.fullspace||e.requestFullspace().catch(()=>a("enclosure.requestFullspace() after fullspacechange event failed"))}),t(e)})).catch(()=>a("Failed to get fullspace enclosure."))})},altspaceutil.getFullspaceAppManifest=function(){if(altspaceutil._fullspaceAppManifest)return Promise.resolve(altspaceutil._fullspaceAppManifest);let e=new URLSearchParams(window.location.search),t=t=>{for(let a of e.entries())if(/altvr\.enclosure\.(.*)/i.test(a[0])){let e=a[0].match(/altvr\.enclosure\.(.*)/i)[1],s=t.enclosure=Object.assign({},t.enclosure);switch(s.position=Object.assign({x:0,y:0,z:0},s.position),s.rotation=Object.assign({x:0,y:0,z:0},s.rotation),s.scale=s.hasOwnProperty("scale")&&"number"==typeof s.scale?{x:s.scale||1,y:s.scale||1,z:s.scale||1}:Object.assign({x:1,y:1,z:1},s.scale),e){case"position":case"rotation":{let t=a[1].split(",");t.length>=1&&(s[e].x=parseFloat(t[0])||0),t.length>=2&&(s[e].y=parseFloat(t[1])||0),t.length>=3&&(s[e].z=parseFloat(t[2])||0);break}case"scale":{let t=a[1].split(",");1===t.length?s[e].x=s[e].y=s[e].z=parseFloat(t[0])||1:(t.length>=1&&(s[e].x=parseFloat(t[0])||1),t.length>=2&&(s[e].y=parseFloat(t[1])||1),t.length>=3&&(s[e].z=parseFloat(t[2])||1));break}}}else if(/altvr\.anchors\.(.*)\.(.*)/i.test(a[0])){let[,e,s]=a[0].match(/altvr\.anchors\.(.*)\.(.*)/i),i=t.anchors.findIndex(t=>{return t.name===e});switch(i<0&&(i=t.anchors.push({name:e})-1),anchormanifest=t.anchors[i]=Object.assign({name:e},t.anchors[i]),anchormanifest.position=Object.assign({x:0,y:0,z:0},anchormanifest.position),anchormanifest.rotation=Object.assign({x:0,y:0,z:0},anchormanifest.rotation),anchormanifest.scale=anchormanifest.hasOwnProperty("scale")&&"number"==typeof anchormanifest.scale?{x:anchormanifest.scale||1,y:anchormanifest.scale||1,z:anchormanifest.scale||1}:Object.assign({x:1,y:1,z:1},anchormanifest.scale),s){case"position":case"rotation":{let e=a[1].split(",");e.length>=1&&(anchormanifest[s].x=parseFloat(e[0])||0),e.length>=2&&(anchormanifest[s].y=parseFloat(e[1])||0),e.length>=3&&(anchormanifest[s].z=parseFloat(e[2])||0);break}case"scale":{let e=a[1].split(",");1===e.length?anchormanifest[s].x=anchormanifest[s].y=anchormanifest[s].z=parseFloat(e[0])||1:(e.length>=1&&(anchormanifest[s].x=parseFloat(e[0])||1),e.length>=2&&(anchormanifest[s].y=parseFloat(e[1])||1),e.length>=3&&(anchormanifest[s].z=parseFloat(e[2])||1));break}}}};return e.has("altvr.manifest")&&e.get("altvr.manifest").length>0?new Promise((a,s)=>{fetch(altspaceutil.getAbsoluteURL(e.get("altvr.manifest"))).then(e=>e.json()).then(e=>{altspaceutil._fullspaceAppManifest=e,t(altspaceutil._fullspaceAppManifest),a(altspaceutil._fullspaceAppManifest)}).catch(()=>s("Failed to download manifest from "+e.get("altvr.manifest")))}):(altspaceutil._fullspaceAppManifest={enclosure:{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},anchors:[]},t(altspaceutil._fullspaceAppManifest),Promise.resolve(altspaceutil._fullspaceAppManifest))},altspaceutil.FullspaceApp=class{constructor(e){this.config=Object.assign({serializationBufferSize:5e5},e),this.config.serializationBufferSize&&altspaceutil.expandSerializationBuffer(this.config.serializationBufferSize)}initialize(){let e=()=>{return this._isInitializing||this._isInitialized?new Promise((e,t)=>{let a=setInterval(()=>{this._isInitializing||(clearInterval(a),e())},10)}):(this._isInitializing=!0,Promise.resolve())},t=altspace.inClient?altspace.getSpace():Promise.resolve({sid:"browser",name:"Web Space",templateSid:"browser"});return new Promise((a,s)=>{e().then(()=>{return this._isInitialized?a(this):(this._isInitializing=!0,Promise.all([altspaceutil.getFullspaceEnclosure(),altspaceutil.getFullspaceAppManifest(),t]).then(e=>{let[t,s,i]=e;if(this._enclosure=t,this._manifest=s,this._space=i,this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera,altspace.inClient)this._renderer=altspace.getThreeJSRenderer();else{this._renderer=new THREE.WebGLRenderer({antialias:!0}),Object.assign(this._camera,{fov:90,near:1,far:2e3}),this._camera.position.z=20;let e=()=>{this._renderer.setClearColor("#99AACC"),document.body.style.margin="0px",document.body.style.overflow="hidden",document.body.appendChild(this._renderer.domElement)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e();let t=()=>{this._camera.aspect=window.innerWidth/window.innerHeight,this._camera.updateProjectionMatrix(),this._renderer.setSize(window.innerWidth,window.innerHeight)};window.addEventListener("resize",t),t(),this._scene.add(this._camera),this._scene.add(new THREE.AmbientLight("white")),altspace.utilities.shims.cursor.init(this._scene,this._camera,{renderer:this._renderer})}this._anchors={},this._anchor=Object.assign(new THREE.Group,{name:"altvr.enclosure"}),this._scene.add(this._anchor);let r=this._manifest?this._manifest.enclosure:null;r&&(this._anchor.position.copy(r.position),this._anchor.rotation.set(THREE.Math.degToRad(r.rotation.x),THREE.Math.degToRad(r.rotation.y),THREE.Math.degToRad(r.rotation.z)),this._anchor.scale.copy(r.scale)),this._anchorsGroup=Object.assign(new THREE.Group,{name:"altvr.anchors"}),this._anchorsGroup.addBehavior(new class e{get type(){return"_ApplyAppAnchorTransform"}constructor(e){this.anchor=e}awake(e){this.object3d=e,this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}update(){this.object3d.position.copy(this.anchor.position),this.object3d.quaternion.copy(this.anchor.quaternion),this.object3d.scale.copy(this.anchor.scale)}}(this._anchor)),this._scene.add(this._anchorsGroup),this._isInitialized=!0;let n=()=>{window.requestAnimationFrame(n),this._scene.updateAllBehaviors(),this._renderer.render(this._scene,this._camera)};n(),this._isInitializing=!1,a(this)}))}).catch(()=>{this._isInitializing=!1,s("Failed to initialize fullspace app.")})})}anchors(e){if(this._anchors[e])return this._anchors[e];let t=this._anchors[e]=Object.assign(new THREE.Group,{name:e});this._anchorsGroup.add(t);let a=this._manifest.anchors.find(t=>{return t.name===e});return a&&(t.position.copy(a.position),t.rotation.set(THREE.Math.degToRad(a.rotation.x),THREE.Math.degToRad(a.rotation.y),THREE.Math.degToRad(a.rotation.z)),t.scale.copy(a.scale)),t}get scene(){return this._scene}get renderer(){return this._renderer}get camera(){return this._camera}get anchor(){return this._anchor}get enclosure(){return this._enclosure}get space(){return this._space}},altspaceutil.getFullspaceApp=function(e){return altspaceutil._fullspaceApp||(altspaceutil._fullspaceApp=new altspaceutil.FullspaceApp(e)),altspaceutil._fullspaceApp.initialize()},altspaceutil.getAbsoluteURL=function(e){return new URL(e,window.location).toString()},altspaceutil.getBasePath=function(e){return e.split("/").slice(0,-1).join("/")+"/"},altspaceutil.loadTexture=function(e,t){if(altspace.inClient){if(e.startsWith("blob:")){let t=new THREE.Texture;return fetch(e).then(e=>e.blob()).then(a=>{let s=new FileReader;s.onerror=(()=>console.warn("Failed to load blob texture at "+e)),s.onload=(()=>Object.assign(t,{image:{nodeName:"CANVAS",toDataURL:()=>s.result},needsUpdate:!0})),s.readAsDataURL(a)}),t}return e.startsWith("data:")?Object.assign(new THREE.Texture({nodeName:"CANVAS",toDataURL:()=>e}),{needsUpdate:!0}):new THREE.Texture({src:altspaceutil.getAbsoluteURL(e)})}t=Object.assign({crossOrigin:"anonymous"},t);var a=new THREE.TextureLoader;return"anonymous"!==t.crossOrigin&&a.setCrossOrigin(t.crossOrigin),void 0!==t.withCredentials&&a.setWithCredentials(t.withCredentials),void 0!==t.path&&a.setPath(t.path),a.load(e)},altspaceutil.setCursorCollider=function(e,t,a){e&&(a?e.traverse(e=>{e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t}):(e.userData.altspace||(e.userData.altspace={}),e.userData.altspace.collider||(e.userData.altspace.collider={}),e.userData.altspace.collider.enabled=t))},altspaceutil.isCursorCollider=function(e){return!!e&&(!e.userData.altspace||!e.userData.altspace.collider||void 0===e.userData.altspace.enabled||e.userData.altspace.enabled)},altspaceutil.manageBehavior=function(e,t){e.__isManaged=!0,t.__resetManagedBehavior||t.addEventListener("removed",t.__resetManagedBehavior=function(){t.__resetManagedBehavior&&(t.removeEventListener("removed",t.__resetManagedBehavior),t.__resetManagedBehavior=null),t.traverse(function(e){if(e.__behaviorList)for(var t of e.__behaviorList)if(t.__isInitialized&&t.__isManaged)try{t.dispose&&t.dispose.call(t,e),t.__isInitialized=!1}catch(a){console.group(),(console.error||console.log).call(console,a.stack||a),console.log("[Behavior]"),console.log(t),console.log("[Object3D]"),console.log(e),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(e,t){e.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(e,t){var a=e.clone(!1);if(e.__behaviorList&&e.__behaviorList.length>0)for(var s of e.__behaviorList)try{if(s.clone){var i=s.clone.call(s,a,e);i&&(a.__behaviorList=a.__behaviorList||[],a.__behaviorList.push(i))}}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(s),console.log("[Object3D]"),console.log(e),console.groupEnd()}if(void 0===t||t)for(var r of e.children)a.add(r.cloneWithBehaviors(!0));return a},altspaceutil.loadScript=((e,t)=>{if(t=Object.assign({loadOnce:!0},t),altspaceutil._loadedScripts=altspaceutil._loadedScripts||{},t.scriptTest&&t.scriptTest(e))return Promise.resolve();if(t.loadOnce){if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].loaded)return Promise.resolve();if(altspaceutil._loadedScripts[e]&&altspaceutil._loadedScripts[e].waiting)return altspaceutil._loadedScripts[e].waiting}let a=document.createElement("script");a.src=new URL(e,window.location).toString(),a.async=!1;let s=void 0===altspaceutil._loadedScripts[e],i=new Promise((i,r)=>{a.onload=(()=>{!t.scriptTest||t.scriptTest(e)?i():(console.warn("Script test failed for script at "+a.src),r("Script test failed for script at "+a.src)),s&&(altspaceutil._loadedScripts[e].loaded=!0,altspaceutil._loadedScripts[e].waiting=null)}),a.onerror=(()=>{s&&(altspaceutil._loadedScripts[e].waiting=null,delete altspaceutil._loadedScripts[e]),console.warn("Failed to load script at "+a.src),r("Failed to load script at "+a.src)})});if(s&&(altspaceutil._loadedScripts[e]={waiting:i}),altspaceutil._lastLoadScript)altspaceutil._lastLoadScript.parentNode.insertBefore(a,altspaceutil._lastLoadScript.nextSibling);else{let e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}return altspaceutil._lastLoadScript=a,i}),altspaceutil.loadScripts=(e=>{return!e||e.length<=0?Promise.resolve():Promise.all(e.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadScript(e):altspaceutil.loadScript(e.url,e)))}),altspaceutil.overrideTextureLoader=(e=>{altspace.inClient&&(altspaceutil._isTextureLoaderOverridden=e)}),altspace.inClient&&(altspaceutil._originalTextureLoaderFunc||(altspaceutil._originalTextureLoaderFunc=THREE.TextureLoader.prototype.load),altspaceutil._isTextureLoaderOverridden=!0,THREE.TextureLoader.prototype.load=function(e,t){if(!altspaceutil._isTextureLoaderOverridden)return altspaceutil._originalTextureLoaderFunc.apply(this,arguments);let a=altspaceutil.loadTexture(e);return t&&t(a),a}),altspaceutil._assetLoaders||(altspaceutil._assetLoaders=new class{constructor(){this.handlers=[],this.add(/\.obj$/i,(e,t)=>{return new Promise((a,s)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/combine/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/MTLLoader.min.js,npm/three@0."+THREE.REVISION+".0/examples/js/loaders/OBJLoader.min.js",{scriptTest:()=>THREE.MTLLoader&&THREE.OBJLoader}).then(()=>{let i=new THREE.FileLoader;i.load(e,i=>{let r=/^[\s]*mtllib[\s]+(.*\.mtl)[\s]*$/m.exec(i);if(r){r=new URL(r[1],e).toString();let n=new THREE.MTLLoader;n.setCrossOrigin(t.crossOrigin),n.setTexturePath(altspaceutil.getBasePath(r)),n.load(r,e=>{e.preload(),a((new THREE.OBJLoader).setMaterials(e).parse(i))},null,()=>s("Could not retrieve materials from "+r))}else a((new THREE.OBJLoader).parse(i))},null,()=>s("Could not retrieve asset from "+e))}).catch(()=>s("Could not load scripts for MTLLoader/OBJLoader"))})}),this.add(/\.gltf|\.glb$/i,(e,t)=>{if(altspace.inClient&&(void 0===t.native||t.native)){let a=new THREE.Object3D;return a.addBehavior(new altspaceutil.behaviors.NativeComponent("n-gltf",{url:e},{useCollider:t.cursorCollider})),Promise.resolve(a)}return new Promise((a,s)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/GLTFLoader.min.js",{scriptTest:()=>THREE.GLTFLoader}).then(()=>{let i=new THREE.GLTFLoader;i.setCrossOrigin(t.crossOrigin),i.load(e,e=>a(e.scene),null,()=>s("Could not retrieve asset from "+e))}).catch(()=>s("Could not load scripts for GLTFLoader"))})}),this.add(/\.dae$/i,(e,t)=>{return new Promise((a,s)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/ColladaLoader.min.js",{scriptTest:()=>THREE.ColladaLoader}).then(()=>{if(altspace.inClient){let i=new THREE.FileLoader;i.load(e,s=>{let i=THREE.TextureLoader.prototype.load;THREE.TextureLoader.prototype.load=(t=>{return new THREE.Texture({src:new URL(t,e).toString()})});let r=new THREE.ColladaLoader;r.setCrossOrigin(t.crossOrigin);let n=r.parse(s,altspaceutil.getBasePath(e));THREE.TextureLoader.prototype.load=i,a(n.scene)},null,()=>s("Could not retrieve asset from "+e))}else{let i=new THREE.ColladaLoader;i.setCrossOrigin(t.crossOrigin),i.load(e,e=>a(e.scene),null,()=>s("Could not retrieve asset from "+e))}}).catch(()=>s("Could not load scripts for ColladaLoader"))})}),this.add(/\.fbx$/i,(e,t)=>{return new Promise((a,s)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/npm/three@0."+THREE.REVISION+".0/examples/js/loaders/FBXLoader.min.js",{scriptTest:()=>THREE.FBXLoader}).then(()=>{let i=new THREE.FBXLoader;i.setCrossOrigin(t.crossOrigin),i.load(e,e=>a(e.scene),null,()=>s("Could not retrieve asset from "+e))}).catch(()=>s("Could not load scripts for FBXLoader"))})}),this.add(/\.bom$/i,(e,t)=>{return new Promise((a,s)=>{altspaceutil.loadScript("https://cdn.jsdelivr.net/gh/NGenesis/bom-three.js@v0.6.3/examples/js/loaders/BOMLoader.min.js",{scriptTest:()=>THREE.BOMLoader}).then(()=>{let i=new THREE.BOMLoader;i.setCrossOrigin(t.crossOrigin),i.load(e,e=>a(e),null,()=>s("Could not retrieve asset from "+e))}).catch(()=>s("Could not load scripts for BOMLoader"))})})}add(e,t){this.handlers.push({regex:e,handler:t})}remove(e,t){this.handlers=this.handlers.filter(t=>t.regex!==e&&(!t||t!==t))}get(e){let t=new URL(e).pathname;for(let a of this.handlers)if(a.regex.test(t))return a.handler;return null}}),altspaceutil.addAssetLoader=((e,t)=>{altspaceutil._assetLoaders.add(e,t)}),altspaceutil.removeAssetLoader=((e,t)=>{altspaceutil._assetLoaders.remove(e,t)}),altspaceutil.loadAsset=((e,t)=>{e=altspaceutil.getAbsoluteURL(e),t=Object.assign({applyTransform:!0,cursorCollider:!1},t);let a=e=>{return altspaceutil.setCursorCollider(e,!!t.cursorCollider,!0),t.applyTransform&&(t.position&&(t.position=Object.assign({x:0,y:0,z:0},t.position),e.position.copy(t.position)),t.quaternion?(t.quaternion=Object.assign({x:0,y:0,z:0,w:1},t.quaternion),e.quaternion.copy(t.quaternion)):t.rotation&&(t.rotation=Object.assign({x:0,y:0,z:0},t.rotation),e.rotation.set(t.rotation.x,t.rotation.y,t.rotation.z)),t.scale&&(t.scale=t.hasOwnProperty("scale")&&"number"==typeof t.scale?{x:t.scale||1,y:t.scale||1,z:t.scale||1}:Object.assign({x:1,y:1,z:1},t.scale),e.scale.copy(t.scale))),new Promise((a,s)=>{let i=t.onLoaded?t.onLoaded(e):null;i instanceof Promise?i.then(()=>a(e)).catch(e=>s("Error occurred while processing onLoaded asset handler",e)):a(e)})},s=altspaceutil._assetLoaders.get(e,t);return s?s(e,t).then(a):Promise.reject("Could not get asset handler for "+e)}),altspaceutil.loadAssets=(e=>{return e?new Promise((t,a)=>{let s=Array.isArray(e)?e:Object.values(e);Promise.all(s.map(e=>"string"==typeof e||e instanceof String?altspaceutil.loadAsset(e):altspaceutil.loadAsset(e.url,e))).then(a=>{if(Array.isArray(e))t(a);else{let s={};Object.keys(e).forEach((e,t)=>{s[e]=a[t]}),t(s)}}).catch(e=>a("Could not load assets",e))}):Promise.resolve(e)}),altspaceutil.behaviors.UserEvents=function(e){this.config=Object.assign({subscribeSelfServerEvents:!1,onRequestData:null,refreshTime:5e3,trace:!1,userIds:[]},e),this.type="UserEvents",this.awake=function(e){if(this.object3d=e,this.time=0,this.loading=!1,this.users={},this.userIds=this.config.userIds.constructor===Array?this.config.userIds:[this.config.userIds],altspaceutil.manageBehavior(this,this.object3d),this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var t=this;altspace.getUser().then(function(e){t.selfUserId=e.legacyUserId?e.legacyUserId:e.userId,t.updateUserAvatarInfo(e.avatarInfo),e.addEventListener("avatarchange",t.onUpdateUserAvatarInfo.bind(t)),t.config.subscribeSelfServerEvents&&(t.userIds.push(e.legacyUserId?e.legacyUserId:e.userId),t.requestUserData())})}else this.requestUserData()},this.onUpdateUserAvatarInfo=function(e){this.updateUserAvatarInfo(e.data)},this.updateUserAvatarInfo=function(e){function t(e){if(e){var t=e.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);if(t)return[t[1],t[2],t[3]]}return e}var a=t(e.primaryColor),s=t(e.highlightColor),i=this.selfUserId,r=this.users[i]||{userId:i};this.users[i]=r;var n=r.avatarId;r.avatarId=e.sid||null;var o,l=r.rawAvatarColors,c=r.avatarTextures,u=r.avatarId!==n;switch(r.avatarColors={},r.rawAvatarColors={},r.avatarTextures={},r.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":o="Rubenoid",e.textures[0]&&(r.avatarTextures.hair=e.textures[0]),e.textures[1]&&(r.avatarTextures.skin=e.textures[1]),e.textures[2]&&(r.avatarTextures.clothing=e.textures[2]),u||(u=c.hair!==r.avatarTextures.hair||c.skin!==r.avatarTextures.skin||c.clothing!==r.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":o="Robothead",s&&(r.avatarColors.highlight=this.getAvatarColor(s),r.rawAvatarColors.highlight=s),u||(u=!l.highlight||JSON.stringify(l.highlight)!==JSON.stringify(r.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":o="Pod",a&&(r.avatarColors.primary=this.getAvatarColor(a),r.rawAvatarColors.primary=a),s&&(r.avatarColors.highlight=this.getAvatarColor(s),r.rawAvatarColors.highlight=s),u||(u=!l.primary||!l.highlight||JSON.stringify(l.primary)!==JSON.stringify(r.rawAvatarColors.primary)||JSON.stringify(l.highlight)!==JSON.stringify(r.rawAvatarColors.highlight));break;default:o="",this.config.trace&&console.log("Unknown avatar type: "+r.avatarId)}if(u){var h=this;this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:r.userId,avatarId:r.avatarId,avatarClass:o,colors:r.avatarColors,rawColors:r.rawAvatarColors,textures:r.avatarTextures},bubbles:!0,target:h.object3d})}},this.update=function(e){!this.loading&&this.userIds.length>0&&(this.time-=e,this.time<=0&&this.requestUserData())},this.onLoaded=function(e){if(this.loading){var t=JSON.parse(e),a=this;for(var s of t.users)if(s&&s.user_id){var i=s.user_id,r=this.users[i]||{userId:i};this.users[i]=r;var n=r.username;r.username=s.username||null;var o=r.displayName;r.displayName=s.display_name||null;var l=r.online;r.online=s.online||!1;var c=s.user_avatar.config.avatar,u=r.avatarId;r.avatarId=c.avatar_sid||null;var h,d=r.rawAvatarColors,p=r.avatarTextures,f=r.avatarId!==u;switch(r.avatarColors={},r.rawAvatarColors={},r.avatarTextures={},r.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":h="Rubenoid";var g="rubenoid-male-01"===r.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";c[g+"1"][0]&&(r.avatarTextures.hair=c[g+"1"][0]),c[g+"2"][0]&&(r.avatarTextures.skin=c[g+"2"][0]),c[g+"3"][0]&&(r.avatarTextures.clothing=c[g+"3"][0]),f||(f=p.hair!==r.avatarTextures.hair||p.skin!==r.avatarTextures.skin||p.clothing!==r.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":h="Robothead",c["robothead-highlight-color"]&&(r.avatarColors.highlight=this.getAvatarColor(c["robothead-highlight-color"]),r.rawAvatarColors.highlight=c["robothead-highlight-color"]),f||(f=!d.highlight||JSON.stringify(d.highlight)!==JSON.stringify(r.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":h="Pod",c["primary-color"]&&(r.avatarColors.primary=this.getAvatarColor(c["primary-color"]),r.rawAvatarColors.primary=c["primary-color"]),c["highlight-color"]&&(r.avatarColors.highlight=this.getAvatarColor(c["highlight-color"]),r.rawAvatarColors.highlight=c["highlight-color"]),f||(f=!d.primary||!d.highlight||JSON.stringify(d.primary)!==JSON.stringify(r.rawAvatarColors.primary)||JSON.stringify(d.highlight)!==JSON.stringify(r.rawAvatarColors.highlight));break;default:h="",this.config.trace&&console.log("Unknown avatar type: "+r.avatarId)}r.username===n&&r.displayName===o||this.object3d.dispatchEvent({type:"userchange",detail:{userId:r.userId,username:r.username,displayName:r.displayName},bubbles:!0,target:a.object3d}),f&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:r.userId,avatarId:r.avatarId,avatarClass:h,colors:r.avatarColors,rawColors:r.rawAvatarColors,textures:r.avatarTextures},bubbles:!0,target:a.object3d}),r.online!==l&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:r.userId,displayName:r.displayName,online:!!r.online},bubbles:!0,target:a.object3d})}this.loading=!1}},this.onError=function(e){if(this.loading){if(this.config.trace){var t=e.target.responseURL||"";console.log("Error loading avatar data "+t)}this.loading=!1}},this.subscribeUser=function(e){var t=this.userIds.indexOf(e);t===-1&&this.userIds.push(e)},this.unsubscribeUser=function(e){var t=this.userIds.indexOf(e);t>=0&&this.userIds.splice(t,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var e=[];for(var t of this.userIds)this.config.onRequestData&&!this.config.onRequestData.call(this,t,this.object3d)||e.push(t);e.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+e.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.config.refreshTime,this.loading=!0)}},this.getAvatarColor=function(e){function t(e,t,a){var s=Math.max(e,t,a);return s>255&&(e=Math.floor(e/s*255),t=Math.floor(t/s*255),a=Math.floor(a/s*255)),new THREE.Color(e/255,t/255,a/255)}function a(e){var t={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return e=e in t?e:"white",new THREE.Color(t[e].r,t[e].g,t[e].b)}if("string"==typeof e){var s=e.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return s?t(s[1],s[2],s[3]):a(e)}if(e.constructor===Array&&1===e.length&&"string"==typeof e[0]){var s=e[0].match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return s?t(s[1],s[2],s[3]):a(e[0])}return t(e[0],e[1],e[2])},this.dispose=function(){this.dataRequest=null,this.object3d=null,this.time=0,this.loading=!1,this.users={}},this.clone=function(){return new altspaceutil.behaviors.UserEvents(this.config)}};