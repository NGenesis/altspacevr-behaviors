"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(a,e){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(a,e):null},altspaceutil.removeNativeEventListener=function(a,e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(a,e)},altspaceutil.removeAllNativeEventListeners=function(a){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[a]&&delete altspace._internal.couiEngine.events[a]},altspaceutil.getObject3DById=function(a){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(a):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.expandSerializationBuffer=function(a){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&a>0&&altspace._internal.ScratchThriftBuffer.grow(a)},altspaceutil.profileSerializationBuffer=function(a){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===a||a)},altspaceutil.isMobileApp=function(a){return/mobile/i.test(navigator.userAgent)},altspaceutil.getFullspaceEnclosure=function(){return new Promise(function(a,e){altspace.getEnclosure().then(function(t){t.requestFullspace().then(function(){t.addEventListener("fullspacechange",function(){t.fullspace||t.requestFullspace().catch(function(){e("enclosure.requestFullspace() after fullspacechange event failed")})}),a(t)}).catch(function(){e("enclosure.requestFullspace() failed")})}).catch(function(){e("altspace.getEnclosure() failed")})})},altspaceutil.getAbsoluteURL=function(a){return new URL(a,window.location).toString()},altspaceutil.getBasePath=function(a){return a.split("/").slice(0,-1).join("/")+"/"},altspaceutil.loadTexture=function(a,e){if(altspace.inClient)return new THREE.Texture({src:altspaceutil.getAbsoluteURL(a)});e=Object.assign({crossOrigin:"anonymous"},e);var t=new THREE.TextureLoader;return"anonymous"!==e.crossOrigin&&t.setCrossOrigin(e.crossOrigin),void 0!==e.withCredentials&&t.setWithCredentials(e.withCredentials),void 0!==e.path&&t.setPath(e.path),t.load(a)},altspaceutil.setCursorCollider=function(a,e,t){a&&(t?a.traverse(a=>{a.userData.altspace||(a.userData.altspace={}),a.userData.altspace.collider||(a.userData.altspace.collider={}),a.userData.altspace.collider.enabled=e}):(a.userData.altspace||(a.userData.altspace={}),a.userData.altspace.collider||(a.userData.altspace.collider={}),a.userData.altspace.collider.enabled=e))},altspaceutil.isCursorCollider=function(a){return!!a&&(!a.userData.altspace||!a.userData.altspace.collider||void 0===a.userData.altspace.enabled||a.userData.altspace.enabled)},altspaceutil.manageBehavior=function(a,e){a.__isManaged=!0,e.__resetManagedBehavior||e.addEventListener("removed",e.__resetManagedBehavior=function(){e.__resetManagedBehavior&&(e.removeEventListener("removed",e.__resetManagedBehavior),e.__resetManagedBehavior=null),e.traverse(function(a){if(a.__behaviorList)for(var e of a.__behaviorList)if(e.__isInitialized&&e.__isManaged)try{e.dispose&&e.dispose.call(e,a),e.__isInitialized=!1}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(e),console.log("[Object3D]"),console.log(a),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(a,e){a.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(a,e){var t=a.clone(!1);if(a.__behaviorList&&a.__behaviorList.length>0)for(var r of a.__behaviorList)try{if(r.clone){var s=r.clone.call(r,t,a);s&&(t.__behaviorList=t.__behaviorList||[],t.__behaviorList.push(s))}}catch(e){console.group(),(console.error||console.log).call(console,e.stack||e),console.log("[Behavior]"),console.log(r),console.log("[Object3D]"),console.log(a),console.groupEnd()}if(void 0===e||e)for(var i of a.children)t.add(i.cloneWithBehaviors(!0));return t},altspaceutil.behaviors.UserEvents=function(a){this.config=Object.assign({subscribeSelfServerEvents:!1,onRequestData:null,refreshTime:5e3,trace:!1,userIds:[]},a),this.type="UserEvents",this.awake=function(a){if(this.object3d=a,this.time=0,this.loading=!1,this.users={},this.userIds=this.config.userIds.constructor===Array?this.config.userIds:[this.config.userIds],altspaceutil.manageBehavior(this,this.object3d),this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var e=this;altspace.getUser().then(function(a){e.selfUserId=a.legacyUserId?a.legacyUserId:a.userId,e.updateUserAvatarInfo(a.avatarInfo),a.addEventListener("avatarchange",e.onUpdateUserAvatarInfo.bind(e)),e.config.subscribeSelfServerEvents&&(e.userIds.push(a.legacyUserId?a.legacyUserId:a.userId),e.requestUserData())})}else this.requestUserData()},this.onUpdateUserAvatarInfo=function(a){this.updateUserAvatarInfo(a.data)},this.updateUserAvatarInfo=function(a){function e(a){if(a){var e=a.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);if(e)return[e[1],e[2],e[3]]}return a}var t=e(a.primaryColor),r=e(a.highlightColor),s=this.selfUserId,i=this.users[s]||{userId:s};this.users[s]=i;var n=i.avatarId;i.avatarId=a.sid||null;var o,l=i.rawAvatarColors,c=i.avatarTextures,u=i.avatarId!==n;switch(i.avatarColors={},i.rawAvatarColors={},i.avatarTextures={},i.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":o="Rubenoid",a.textures[0]&&(i.avatarTextures.hair=a.textures[0]),a.textures[1]&&(i.avatarTextures.skin=a.textures[1]),a.textures[2]&&(i.avatarTextures.clothing=a.textures[2]),u||(u=c.hair!==i.avatarTextures.hair||c.skin!==i.avatarTextures.skin||c.clothing!==i.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":o="Robothead",r&&(i.avatarColors.highlight=this.getAvatarColor(r),i.rawAvatarColors.highlight=r),u||(u=!l.highlight||JSON.stringify(l.highlight)!==JSON.stringify(i.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":o="Pod",t&&(i.avatarColors.primary=this.getAvatarColor(t),i.rawAvatarColors.primary=t),r&&(i.avatarColors.highlight=this.getAvatarColor(r),i.rawAvatarColors.highlight=r),u||(u=!l.primary||!l.highlight||JSON.stringify(l.primary)!==JSON.stringify(i.rawAvatarColors.primary)||JSON.stringify(l.highlight)!==JSON.stringify(i.rawAvatarColors.highlight));break;default:o="",this.config.trace&&console.log("Unknown avatar type: "+i.avatarId)}if(u){var h=this;this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:i.userId,avatarId:i.avatarId,avatarClass:o,colors:i.avatarColors,rawColors:i.rawAvatarColors,textures:i.avatarTextures},bubbles:!0,target:h.object3d})}},this.update=function(a){!this.loading&&this.userIds.length>0&&(this.time-=a,this.time<=0&&this.requestUserData())},this.onLoaded=function(a){if(this.loading){var e=JSON.parse(a),t=this;for(var r of e.users)if(r&&r.user_id){var s=r.user_id,i=this.users[s]||{userId:s};this.users[s]=i;var n=i.username;i.username=r.username||null;var o=i.displayName;i.displayName=r.display_name||null;var l=i.online;i.online=r.online||!1;var c=r.user_avatar.config.avatar,u=i.avatarId;i.avatarId=c.avatar_sid||null;var h,d=i.rawAvatarColors,g=i.avatarTextures,v=i.avatarId!==u;switch(i.avatarColors={},i.rawAvatarColors={},i.avatarTextures={},i.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":h="Rubenoid";var p="rubenoid-male-01"===i.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";c[p+"1"][0]&&(i.avatarTextures.hair=c[p+"1"][0]),c[p+"2"][0]&&(i.avatarTextures.skin=c[p+"2"][0]),c[p+"3"][0]&&(i.avatarTextures.clothing=c[p+"3"][0]),v||(v=g.hair!==i.avatarTextures.hair||g.skin!==i.avatarTextures.skin||g.clothing!==i.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":h="Robothead",c["robothead-highlight-color"]&&(i.avatarColors.highlight=this.getAvatarColor(c["robothead-highlight-color"]),i.rawAvatarColors.highlight=c["robothead-highlight-color"]),v||(v=!d.highlight||JSON.stringify(d.highlight)!==JSON.stringify(i.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":h="Pod",c["primary-color"]&&(i.avatarColors.primary=this.getAvatarColor(c["primary-color"]),i.rawAvatarColors.primary=c["primary-color"]),c["highlight-color"]&&(i.avatarColors.highlight=this.getAvatarColor(c["highlight-color"]),i.rawAvatarColors.highlight=c["highlight-color"]),v||(v=!d.primary||!d.highlight||JSON.stringify(d.primary)!==JSON.stringify(i.rawAvatarColors.primary)||JSON.stringify(d.highlight)!==JSON.stringify(i.rawAvatarColors.highlight));break;default:h="",this.config.trace&&console.log("Unknown avatar type: "+i.avatarId)}i.username===n&&i.displayName===o||this.object3d.dispatchEvent({type:"userchange",detail:{userId:i.userId,username:i.username,displayName:i.displayName},bubbles:!0,target:t.object3d}),v&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:i.userId,avatarId:i.avatarId,avatarClass:h,colors:i.avatarColors,rawColors:i.rawAvatarColors,textures:i.avatarTextures},bubbles:!0,target:t.object3d}),i.online!==l&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:i.userId,displayName:i.displayName,online:!!i.online},bubbles:!0,target:t.object3d})}this.loading=!1}},this.onError=function(a){if(this.loading){if(this.config.trace){var e=a.target.responseURL||"";console.log("Error loading avatar data "+e)}this.loading=!1}},this.subscribeUser=function(a){var e=this.userIds.indexOf(a);e===-1&&this.userIds.push(a)},this.unsubscribeUser=function(a){var e=this.userIds.indexOf(a);e>=0&&this.userIds.splice(e,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var a=[];for(var e of this.userIds)this.config.onRequestData&&!this.config.onRequestData.call(this,e,this.object3d)||a.push(e);a.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+a.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.config.refreshTime,this.loading=!0)}},this.getAvatarColor=function(a){function e(a,e,t){var r=Math.max(a,e,t);return r>255&&(a=Math.floor(a/r*255),e=Math.floor(e/r*255),t=Math.floor(t/r*255)),new THREE.Color(a/255,e/255,t/255)}function t(a){var e={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return a=a in e?a:"white",new THREE.Color(e[a].r,e[a].g,e[a].b)}if("string"==typeof a){var r=a.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return r?e(r[1],r[2],r[3]):t(a)}if("string"==typeof a[0]){var r=a[0].match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return r?e(r[1],r[2],r[3]):t(a[0])}return e(a[0],a[1],a[2])},this.dispose=function(){this.dataRequest=null,this.object3d=null,this.time=0,this.loading=!1,this.users={}},this.clone=function(){return new altspaceutil.behaviors.UserEvents(this.config)}};