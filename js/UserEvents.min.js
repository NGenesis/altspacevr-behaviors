"use strict";window.altspaceutil=window.altspaceutil||{},altspaceutil.behaviors=altspaceutil.behaviors||{},altspaceutil.addNativeEventListener=function(a,e){return altspace.inClient&&altspace._internal&&altspace._internal.couiEngine?altspace._internal.couiEngine.on(a,e):null},altspaceutil.removeNativeEventListener=function(a,e){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.off(a,e)},altspaceutil.removeAllNativeEventListeners=function(a){altspace.inClient&&altspace._internal&&altspace._internal.couiEngine&&altspace._internal.couiEngine.events[a]&&delete altspace._internal.couiEngine.events[a]},altspaceutil.getObject3DById=function(a){return altspace.inClient&&altspace._internal?altspace._internal.getObject3DById(a):null},altspaceutil.getThreeJSScene=function(){return altspace.inClient&&altspace._internal?altspace._internal.getThreeJSScene():null},altspaceutil.expandSerializationBuffer=function(a){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&a>0&&altspace._internal.ScratchThriftBuffer.grow(a)},altspaceutil.profileSerializationBuffer=function(a){altspace.inClient&&altspace._internal&&altspace._internal.ScratchThriftBuffer&&(altspace._internal.ScratchThriftBuffer.profile=void 0===a||a)},altspaceutil.isMobileApp=function(a){return/mobile/i.test(navigator.userAgent)},altspaceutil.getAbsoluteURL=function(a){if(a&&!a.startsWith("http"))if(a.startsWith("/"))a=location.origin+a;else{var e=location.pathname;e.endsWith("/")||(e=location.pathname.split("/").slice(0,-1).join("/")+"/"),a=location.origin+e+a}return a},altspaceutil.getBasePath=function(a){return a.split("/").slice(0,-1).join("/")+"/"},altspaceutil.manageBehavior=function(a,e){a.__isManaged=!0,e.__resetManagedBehavior||e.addEventListener("removed",e.__resetManagedBehavior=function(){e.__resetManagedBehavior&&(e.removeEventListener("removed",e.__resetManagedBehavior),e.__resetManagedBehavior=null),e.traverse(function(a){if(a.__behaviorList)for(var e of a.__behaviorList)if(e.__isInitialized&&e.__isManaged)try{e.dispose&&e.dispose.call(e,a),e.__isInitialized=!1}catch(t){console.group(),(console.error||console.log).call(console,t.stack||t),console.log("[Behavior]"),console.log(e),console.log("[Object3D]"),console.log(a),console.groupEnd()}})})},altspaceutil.unmanageBehavior=function(a,e){a.__isManaged=!1},altspaceutil.cloneWithBehaviors=function(a,e){var t=a.clone(!1);if(a.__behaviorList&&a.__behaviorList.length>0)for(var r of a.__behaviorList)try{if(r.clone){var i=r.clone.call(r,t,a);i&&(t.__behaviorList=t.__behaviorList||[],t.__behaviorList.push(i))}}catch(e){console.group(),(console.error||console.log).call(console,e.stack||e),console.log("[Behavior]"),console.log(r),console.log("[Object3D]"),console.log(a),console.groupEnd()}if(void 0===e||e)for(var s of a.children)t.add(s.cloneWithBehaviors(!0));return t},altspaceutil.behaviors.UserEvents=function(a){this.config=Object.assign({subscribeSelfServerEvents:!1,onRequestData:null,refreshTime:5e3,trace:!1,userIds:[]},a),this.type="UserEvents",this.awake=function(a){if(this.object3d=a,this.time=0,this.loading=!1,this.users={},this.userIds=this.config.userIds.constructor===Array?this.config.userIds:[this.config.userIds],altspaceutil.manageBehavior(this,this.object3d),this.dataRequest=new THREE.FileLoader,this.dataRequest.setWithCredentials(!0),this.userIds.length<=0){var e=this;altspace.getUser().then(function(a){e.selfUserId=a.legacyUserId?a.legacyUserId:a.userId,e.updateUserAvatarInfo(a.avatarInfo),a.addEventListener("avatarchange",e.onUpdateUserAvatarInfo.bind(e)),e.config.subscribeSelfServerEvents&&(e.userIds.push(a.legacyUserId?a.legacyUserId:a.userId),e.requestUserData())})}else this.requestUserData()},this.onUpdateUserAvatarInfo=function(a){this.updateUserAvatarInfo(a.data)},this.updateUserAvatarInfo=function(a){function e(a){if(a){var e=a.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);if(e)return[e[1],e[2],e[3]]}return a}var t=e(a.primaryColor),r=e(a.highlightColor),i=this.selfUserId,s=this.users[i]||{userId:i};this.users[i]=s;var o=s.avatarId;s.avatarId=a.sid||null;var n,l=s.rawAvatarColors,h=s.avatarTextures,c=s.avatarId!==o;switch(s.avatarColors={},s.rawAvatarColors={},s.avatarTextures={},s.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":n="Rubenoid",a.textures[0]&&(s.avatarTextures.hair=a.textures[0]),a.textures[1]&&(s.avatarTextures.skin=a.textures[1]),a.textures[2]&&(s.avatarTextures.clothing=a.textures[2]),c||(c=h.hair!==s.avatarTextures.hair||h.skin!==s.avatarTextures.skin||h.clothing!==s.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":n="Robothead",r&&(s.avatarColors.highlight=this.getAvatarColor(r),s.rawAvatarColors.highlight=r),c||(c=!l.highlight||JSON.stringify(l.highlight)!==JSON.stringify(s.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":n="Pod",t&&(s.avatarColors.primary=this.getAvatarColor(t),s.rawAvatarColors.primary=t),r&&(s.avatarColors.highlight=this.getAvatarColor(r),s.rawAvatarColors.highlight=r),c||(c=!l.primary||!l.highlight||JSON.stringify(l.primary)!==JSON.stringify(s.rawAvatarColors.primary)||JSON.stringify(l.highlight)!==JSON.stringify(s.rawAvatarColors.highlight));break;default:n="",this.config.trace&&console.log("Unknown avatar type: "+s.avatarId)}if(c){var u=this;this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:s.userId,avatarId:s.avatarId,avatarClass:n,colors:s.avatarColors,rawColors:s.rawAvatarColors,textures:s.avatarTextures},bubbles:!0,target:u.object3d})}},this.update=function(a){!this.loading&&this.userIds.length>0&&(this.time-=a,this.time<=0&&this.requestUserData())},this.onLoaded=function(a){if(this.loading){var e=JSON.parse(a),t=this;for(var r of e.users)if(r&&r.user_id){var i=r.user_id,s=this.users[i]||{userId:i};this.users[i]=s;var o=s.username;s.username=r.username||null;var n=s.displayName;s.displayName=r.display_name||null;var l=s.online;s.online=r.online||!1;var h=r.user_avatar.config.avatar,c=s.avatarId;s.avatarId=h.avatar_sid||null;var u,d=s.rawAvatarColors,g=s.avatarTextures,v=s.avatarId!==c;switch(s.avatarColors={},s.rawAvatarColors={},s.avatarTextures={},s.avatarId){case"rubenoid-male-01":case"rubenoid-female-01":u="Rubenoid";var f="rubenoid-male-01"===s.avatarId?"rubenoid-male-texture-":"rubenoid-female-texture-";h[f+"1"][0]&&(s.avatarTextures.hair=h[f+"1"][0]),h[f+"2"][0]&&(s.avatarTextures.skin=h[f+"2"][0]),h[f+"3"][0]&&(s.avatarTextures.clothing=h[f+"3"][0]),v||(v=g.hair!==s.avatarTextures.hair||g.skin!==s.avatarTextures.skin||g.clothing!==s.avatarTextures.clothing);break;case"robothead-roundguy-01":case"robothead-propellerhead-01":u="Robothead",h["robothead-highlight-color"]&&(s.avatarColors.highlight=this.getAvatarColor(h["robothead-highlight-color"]),s.rawAvatarColors.highlight=h["robothead-highlight-color"]),v||(v=!d.highlight||JSON.stringify(d.highlight)!==JSON.stringify(s.rawAvatarColors.highlight));break;case"a-series-m01":case"pod-classic":case"s-series-f01":case"s-series-m01":case"x-series-m01":case"x-series-m02":u="Pod",h["primary-color"]&&(s.avatarColors.primary=this.getAvatarColor(h["primary-color"]),s.rawAvatarColors.primary=h["primary-color"]),h["highlight-color"]&&(s.avatarColors.highlight=this.getAvatarColor(h["highlight-color"]),s.rawAvatarColors.highlight=h["highlight-color"]),v||(v=!d.primary||!d.highlight||JSON.stringify(d.primary)!==JSON.stringify(s.rawAvatarColors.primary)||JSON.stringify(d.highlight)!==JSON.stringify(s.rawAvatarColors.highlight));break;default:u="",this.config.trace&&console.log("Unknown avatar type: "+s.avatarId)}s.username===o&&s.displayName===n||this.object3d.dispatchEvent({type:"userchange",detail:{userId:s.userId,username:s.username,displayName:s.displayName},bubbles:!0,target:t.object3d}),v&&this.object3d.dispatchEvent({type:"avatarchange",detail:{userId:s.userId,avatarId:s.avatarId,avatarClass:u,colors:s.avatarColors,rawColors:s.rawAvatarColors,textures:s.avatarTextures},bubbles:!0,target:t.object3d}),s.online!==l&&this.object3d.dispatchEvent({type:"avatarstatus",detail:{userId:s.userId,displayName:s.displayName,online:!!s.online},bubbles:!0,target:t.object3d})}this.loading=!1}},this.onError=function(a){if(this.loading){if(this.config.trace){var e=a.target.responseURL||"";console.log("Error loading avatar data "+e)}this.loading=!1}},this.subscribeUser=function(a){var e=this.userIds.indexOf(a);e===-1&&this.userIds.push(a)},this.unsubscribeUser=function(a){var e=this.userIds.indexOf(a);e>=0&&this.userIds.splice(e,1)},this.requestUserData=function(){if(!(!this.dataRequest||this.loading||this.userIds.length<=0)){var a=[];for(var e of this.userIds)this.config.onRequestData&&!this.config.onRequestData.call(this,e,this.object3d)||a.push(e);a.length>0&&(this.dataRequest.load("https://account.altvr.com/api/v1/users/"+a.join(),this.onLoaded.bind(this),void 0,this.onError.bind(this)),this.time=this.config.refreshTime,this.loading=!0)}},this.getAvatarColor=function(a){function e(a,e,t){var r=Math.max(a,e,t);return r>255&&(a=Math.floor(a/r*255),e=Math.floor(e/r*255),t=Math.floor(t/r*255)),new THREE.Color(a/255,e/255,t/255)}function t(a){var e={black:{r:.1,g:.1,b:.1},darkgrey:{r:.3,g:.3,b:.3},grey:{r:.75,g:.75,b:.75},white:{r:1,g:1,b:1}};return a=a in e?a:"white",new THREE.Color(e[a].r,e[a].g,e[a].b)}if("string"==typeof a){var r=a.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return r?e(r[1],r[2],r[3]):t(a)}if("string"==typeof a[0]){var r=a[0].match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);return r?e(r[1],r[2],r[3]):t(a[0])}return e(a[0],a[1],a[2])},this.dispose=function(){this.dataRequest=null,this.object3d=null,this.time=0,this.loading=!1,this.users={}},this.clone=function(){return new altspaceutil.behaviors.UserEvents(this.config)}};